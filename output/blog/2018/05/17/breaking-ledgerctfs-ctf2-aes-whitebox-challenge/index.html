<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Breaking ledgerctf's ctf2 AES whitebox challenge</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="Axel '0vercl0k' Souchet">
    <link rel="stylesheet" href="/theme/css/bootstrap.min.css" type="text/css" />
    <style type="text/css">
      body {
        padding-top: 60px;
        padding-bottom: 40px;
      }
      .sidebar-nav {
        padding: 9px 0;
      }
      .tag-1 {
        font-size: 13pt;
      }
      .tag-2 {
        font-size: 10pt;
      }
      .tag-2 {
        font-size: 8pt;
      }
      .tag-4 {
        font-size: 6pt;
     }
    </style>
    <link href="/theme/css/bootstrap-responsive.min.css" rel="stylesheet" />
    <link href="/theme/css/font-awesome.css" rel="stylesheet" />
    <link href="/theme/css/pygments.css" rel="stylesheet" />

    <!--[if lt IE 9]>
      <script src="//html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <link href="/feeds/atom.xml" type="application/atom+xml" rel="alternate" title="Diary of a reverse-engineer ATOM Feed" />
    <link href="/feeds/rss.xml" type="application/atom+xml" rel="alternate" title="Diary of a reverse-engineer RSS Feed" />

  </head>

  <body>

    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container-fluid">
          <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
          <a class="brand" href="/index.html">Diary of a reverse-engineer </a>
          <div class="nav-collapse">
            <ul class="nav">
              <ul class="nav">
                    <li><a href="/archives.html"><i class="icon-th-list"></i>Archives</a></li>
              </ul>

                <li >
                    <a href="/category/debugging.html">
                      <i class="icon-folder-open icon-large"></i>debugging
                    </a>
                </li>
                <li >
                    <a href="/category/exploitation.html">
                      <i class="icon-folder-open icon-large"></i>exploitation
                    </a>
                </li>
                <li >
                    <a href="/category/misc.html">
                      <i class="icon-folder-open icon-large"></i>misc
                    </a>
                </li>
                <li >
                    <a href="/category/obfuscation.html">
                      <i class="icon-folder-open icon-large"></i>obfuscation
                    </a>
                </li>
                <li class="active">
                    <a href="/category/reverse-engineering.html">
                      <i class="icon-folder-open icon-large"></i>reverse-engineering
                    </a>
                </li>

                <li><a href="/pages/about.html">About</a></li>
                <li><a href="/pages/presentations.html">Presentations</a></li>

            </ul>
          </div><!--/.nav-collapse -->
        </div>
      </div>
    </div>

    <div class="container-fluid">
      <div class="row">
        <div class="span9" id="content">
<section id="content">
        <article>
                <header>
                        <h1>
                                <a href=""
                                        rel="bookmark"
                                        title="Permalink to Breaking ledgerctf's ctf2 AES whitebox challenge">
                                        Breaking ledgerctf's ctf2 AES whitebox challenge
                                </a>
                        </h1>
                </header>
                <div class="entry-content">
                <div class="well">
<footer class="post-info">
<span class="label">Date</span>
<abbr class="published" title="2018-05-17T11:52:00-07:00">
        <i class="icon-calendar"></i>Thu 17 May 2018
</abbr>
<span class="label">By</span>
<a href="/author/axel-0vercl0k-souchet.html"><i class="icon-user"></i>Axel "0vercl0k" Souchet</a>
<span class="label">Category</span>
<a href="/category/reverse-engineering.html"><i class="icon-folder-open"></i>reverse-engineering</a>


<span class="label">Tags</span>
	<a href="/tag/reverse-engineering.html"><i class="icon-tag"></i>reverse-engineering</a>
	<a href="/tag/ledgerctf.html"><i class="icon-tag"></i>ledgerctf</a>
	<a href="/tag/whitebox.html"><i class="icon-tag"></i>whitebox</a>
</footer><!-- /.post-info -->                </div>
                <h1 id="introduction">Introduction</h1>
<p>About a month ago, my mate <a href="https://twitter.com/b0n0n">b0n0n</a> was working on the <a href="https://www.ledger.fr/ctf2018/">ledgerctf</a> puzzles and challenged me to have a look at the <em>ctf2</em> binary. Annnnd I did; this blogpost will discuss this specific challenge and the scheme you had to break. Before diving though, here is a bit of background.</p>
<p><a href="https://www.ledger.fr/">ledger</a> is a french security company started in 2014 that is specialized in cryptography, cryptocurrencies and hardware. They put up three different puzzles online to celebrate the official launch of their <a href="https://www.ledger.fr/bounty-program/">bug bounty program</a>. The second challenge called 'ctf2' is what this blogpost is going to discuss.</p>
<p>We are given an ELF64 binary called <em>ctf2</em> available <a href="https://drive.google.com/open?id=1UPLe3V5Jt3SMqZe4ZIFcnWydSqUyI4Ao">here</a> for download for you to follow at home :). The binary is about 11MB, written in C++ and even has symbols.</p>
<p>Let's go dive in!</p>


<div class="toc"><span class="toctitle">Table of contents:</span><ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#the-big-picture">The big picture</a><ul>
<li><a href="#recon">Recon</a></li>
<li><a href="#diffusion">Diffusion</a></li>
<li><a href="#confusion">Confusion</a></li>
<li><a href="#generation">Generation</a></li>
</ul>
</li>
<li><a href="#zooming-in">Zooming in</a><ul>
<li><a href="#schedule">schedule</a></li>
</ul>
</li>
</ul>
</div>
<h1 id="the-big-picture">The big picture</h1>
<h2 id="recon">Recon</h2>
<p>The very first thing I'm sure you've seen is how much data is in the binary as seen below; it either means that the binary is packed and that IDA struggles to recognize pieces of the binary as code, or it is actually data.</p>
<p><center><img alt="ida.png" src="/images/breaking_ledgerctfs_ctf2_aes_whitebox_challenge/ida.png"></center></p>
<p>We also know that the binary hasn't been stripped and so the first hypothesis is most likely wrong. By skimming through the code in the disassembler, everything looks healthy; can't see any obvious obfuscation or anti-debugging. Pretty sure we are looking at a pure reverse-engineering challenge at this point, smooth sailing!</p>
<h2 id="diffusion">Diffusion</h2>
<p>The binary expects a serial which is a string composed of 32 hex characters like this one: <code>00112233445566778899AABBCCDDEEFF</code>. Then, there is a 16 rounds loop that walks character by character the input serial and builds 15 blobs of 16 bytes each; I decided to call them <code>i0</code>, <code>i1</code>, .., <code>i14</code> (as it's very self explanatory, I know). Each round of this loop initializes one byte of every <code>i</code>'s (hence the 16 rounds). The current input serial byte is being put through a <em>rolling</em> substitution box (that I called <code>sbx</code>; note that it is 11534336 bytes long), one for every <code>i</code>'s. This basically diffuses the input serial in those blobs. If the explanation above wasn't clear enough or something; here is what it looks like in prettyfied C:</p>
<div class="highlight"><pre><span></span><span class="k">while</span><span class="p">(</span><span class="n">Idx</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">sbx</span><span class="o">++</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">CurrentByteString</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">Serial</span><span class="p">[</span><span class="n">Idx</span><span class="p">],</span>
    <span class="n">Serial</span><span class="p">[</span><span class="n">Idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span>
    <span class="mi">0</span>
  <span class="p">};</span>
  <span class="n">Idx</span> <span class="o">+=</span> <span class="mi">2LL</span><span class="p">;</span>
  <span class="kt">uint8_t</span> <span class="n">CurrentByte</span> <span class="o">=</span> <span class="n">strtol</span><span class="p">(</span><span class="n">CurrentByteString</span><span class="p">,</span> <span class="mi">0LL</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
  <span class="n">i0</span><span class="p">[</span><span class="n">sbx</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">CurrentByte</span><span class="p">;</span>
  <span class="n">i1</span><span class="p">[</span><span class="n">sbx</span><span class="p">[</span><span class="mi">15</span><span class="p">]]</span> <span class="o">=</span> <span class="n">CurrentByte</span><span class="p">;</span>
  <span class="n">i2</span><span class="p">[</span><span class="n">sbx</span><span class="p">[</span><span class="mi">31</span><span class="p">]]</span> <span class="o">=</span> <span class="n">CurrentByte</span><span class="p">;</span>
  <span class="n">i3</span><span class="p">[</span><span class="n">sbx</span><span class="p">[</span><span class="mi">47</span><span class="p">]]</span> <span class="o">=</span> <span class="n">CurrentByte</span><span class="p">;</span>
  <span class="n">i4</span><span class="p">[</span><span class="n">sbx</span><span class="p">[</span><span class="mi">63</span><span class="p">]]</span> <span class="o">=</span> <span class="n">CurrentByte</span><span class="p">;</span>
  <span class="n">i5</span><span class="p">[</span><span class="n">sbx</span><span class="p">[</span><span class="mi">79</span><span class="p">]]</span> <span class="o">=</span> <span class="n">CurrentByte</span><span class="p">;</span>
  <span class="n">i6</span><span class="p">[</span><span class="n">sbx</span><span class="p">[</span><span class="mi">95</span><span class="p">]]</span> <span class="o">=</span> <span class="n">CurrentByte</span><span class="p">;</span>
  <span class="n">i7</span><span class="p">[</span><span class="n">sbx</span><span class="p">[</span><span class="mi">111</span><span class="p">]]</span> <span class="o">=</span> <span class="n">CurrentByte</span><span class="p">;</span>
  <span class="n">i8</span><span class="p">[</span><span class="n">sbx</span><span class="p">[</span><span class="mi">127</span><span class="p">]]</span> <span class="o">=</span> <span class="n">CurrentByte</span><span class="p">;</span>
  <span class="n">i9</span><span class="p">[</span><span class="n">sbx</span><span class="p">[</span><span class="mi">143</span><span class="p">]]</span> <span class="o">=</span> <span class="n">CurrentByte</span><span class="p">;</span>
  <span class="n">i10</span><span class="p">[</span><span class="n">sbx</span><span class="p">[</span><span class="mi">159</span><span class="p">]]</span> <span class="o">=</span> <span class="n">CurrentByte</span><span class="p">;</span>
  <span class="n">i11</span><span class="p">[</span><span class="n">sbx</span><span class="p">[</span><span class="mi">175</span><span class="p">]]</span> <span class="o">=</span> <span class="n">CurrentByte</span><span class="p">;</span>
  <span class="n">i12</span><span class="p">[</span><span class="n">sbx</span><span class="p">[</span><span class="mi">191</span><span class="p">]]</span> <span class="o">=</span> <span class="n">CurrentByte</span><span class="p">;</span>
  <span class="n">i13</span><span class="p">[</span><span class="n">sbx</span><span class="p">[</span><span class="mi">207</span><span class="p">]]</span> <span class="o">=</span> <span class="n">CurrentByte</span><span class="p">;</span>
  <span class="n">i14</span><span class="p">[</span><span class="n">sbx</span><span class="p">[</span><span class="mi">223</span><span class="p">]]</span> <span class="o">=</span> <span class="n">CurrentByte</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<h2 id="confusion">Confusion</h2>
<p>After the above part, there is now a bunch of stuff happening that don't make a whole lot of sense at the time of reverse-engineering; but as far as I am concerned it also doesn't sound too concerning either as I can't see a clear relationship yet with the input serial bytes or the <code>i</code>s. As those two are the only user-input derived datas, those are the only one I care about for now.</p>
<p>What I learned from this part though is that there are new players in town. There are basically three blobs of 16 bytes, respectively called <code>mask</code>, <code>mask3</code> and <code>shiftedmask</code> that gets initialized with values derived from <code>rand()</code>. At first it is a bit confusing to see pseudo-randomized values getting involved but we can assume those operations will get canceled out by some others. It wouldn't make sense to have some crypto algorithm producing non deterministic results. Even though, the PRNG is seeded with <code>time(NULL)</code> it sounds a bit odd and unlikely to have outputs bound to the local time.</p>
<div class="highlight"><pre><span></span><span class="k">do</span>
<span class="p">{</span>
  <span class="n">v16</span> <span class="o">=</span> <span class="n">v15</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
  <span class="k">do</span>
  <span class="p">{</span>
    <span class="n">rd</span> <span class="o">=</span> <span class="n">rand</span><span class="p">();</span>
    <span class="n">v18</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kr">__int8</span><span class="p">)(((</span><span class="kt">unsigned</span> <span class="kr">__int64</span><span class="p">)</span><span class="n">rd</span> <span class="o">&gt;&gt;</span> <span class="mi">56</span><span class="p">)</span> <span class="o">+</span> <span class="n">rd</span><span class="p">)</span> <span class="o">-</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)(</span><span class="n">rd</span> <span class="o">&gt;&gt;</span> <span class="mi">31</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span>
    <span class="n">mask</span><span class="p">[</span><span class="n">v15</span><span class="p">]</span> <span class="o">=</span> <span class="n">v18</span><span class="p">;</span>
    <span class="n">mask3</span><span class="p">[</span><span class="n">v15</span><span class="p">]</span> <span class="o">=</span> <span class="n">v18</span><span class="p">;</span>
    <span class="n">shiftedmask</span><span class="p">[</span><span class="n">v15</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">v18</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">while</span> <span class="p">(</span> <span class="n">v15</span> <span class="o">!=</span> <span class="n">v16</span> <span class="p">);</span>
<span class="p">}</span>
<span class="k">while</span> <span class="p">(</span> <span class="n">v15</span> <span class="o">!=</span> <span class="mi">16</span> <span class="p">);</span>
</pre></div>


<p>After this, there are a bunch of other operations that we don't care that much. Really, you can see those as blackboxes that generate deterministic outputs. Which means we will be able to conveniently dump the generated values and carry on if we need them. For what it's worth, it basically mixes a bunch of values inside <code>mask3</code>.</p>
<div class="highlight"><pre><span></span><span class="n">shiftrows</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kr">__int8</span> <span class="p">(</span><span class="o">*</span><span class="p">)[</span><span class="mi">4</span><span class="p">])</span><span class="n">shiftedmask</span><span class="p">);</span>
<span class="n">shiftrows</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kr">__int8</span> <span class="p">(</span><span class="o">*</span><span class="p">)[</span><span class="mi">4</span><span class="p">])</span><span class="n">mask3</span><span class="p">);</span>
<span class="n">v19</span> <span class="o">=</span> <span class="n">mul3</span><span class="p">[(</span><span class="kt">unsigned</span> <span class="kr">__int8</span><span class="p">)</span><span class="n">byte_D03774</span><span class="p">]</span> <span class="o">^</span> <span class="n">mul2</span><span class="p">[</span><span class="n">mask3</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">^</span> <span class="n">byte_D03778</span> <span class="o">^</span> <span class="n">byte_D0377C</span><span class="p">;</span>
<span class="n">v20</span> <span class="o">=</span> <span class="n">mul3</span><span class="p">[(</span><span class="kt">unsigned</span> <span class="kr">__int8</span><span class="p">)</span><span class="n">byte_D0377C</span><span class="p">]</span> <span class="o">^</span> <span class="n">mul2</span><span class="p">[(</span><span class="kt">unsigned</span> <span class="kr">__int8</span><span class="p">)</span><span class="n">byte_D03778</span><span class="p">]</span> <span class="o">^</span> <span class="n">byte_D03774</span> <span class="o">^</span> <span class="n">mask3</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="n">v21</span> <span class="o">=</span> <span class="n">mul3</span><span class="p">[</span><span class="n">mask3</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">^</span> <span class="n">mul2</span><span class="p">[(</span><span class="kt">unsigned</span> <span class="kr">__int8</span><span class="p">)</span><span class="n">byte_D0377C</span><span class="p">]</span> <span class="o">^</span> <span class="n">byte_D03778</span> <span class="o">^</span> <span class="n">byte_D03774</span><span class="p">;</span>
<span class="n">byte_D03774</span> <span class="o">=</span> <span class="n">mul3</span><span class="p">[(</span><span class="kt">unsigned</span> <span class="kr">__int8</span><span class="p">)</span><span class="n">byte_D03778</span><span class="p">]</span> <span class="o">^</span> <span class="n">mul2</span><span class="p">[(</span><span class="kt">unsigned</span> <span class="kr">__int8</span><span class="p">)</span><span class="n">byte_D03774</span><span class="p">]</span> <span class="o">^</span> <span class="n">mask3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">^</span> <span class="n">byte_D0377C</span><span class="p">;</span>
<span class="n">mask3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">v19</span><span class="p">;</span>
<span class="n">byte_D03778</span> <span class="o">=</span> <span class="n">v20</span><span class="p">;</span>
<span class="n">byte_D0377C</span> <span class="o">=</span> <span class="n">v21</span><span class="p">;</span>
<span class="n">v22</span> <span class="o">=</span> <span class="n">mul3</span><span class="p">[(</span><span class="kt">unsigned</span> <span class="kr">__int8</span><span class="p">)</span><span class="n">byte_D0377D</span><span class="p">]</span> <span class="o">^</span> <span class="n">mul2</span><span class="p">[(</span><span class="kt">unsigned</span> <span class="kr">__int8</span><span class="p">)</span><span class="n">byte_D03779</span><span class="p">]</span> <span class="o">^</span> <span class="n">mask3</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">^</span> <span class="n">byte_D03775</span><span class="p">;</span>
<span class="n">v23</span> <span class="o">=</span> <span class="n">mul3</span><span class="p">[(</span><span class="kt">unsigned</span> <span class="kr">__int8</span><span class="p">)</span><span class="n">byte_D03775</span><span class="p">]</span> <span class="o">^</span> <span class="n">mul2</span><span class="p">[</span><span class="n">mask3</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">^</span> <span class="n">byte_D03779</span> <span class="o">^</span> <span class="n">byte_D0377D</span><span class="p">;</span>
<span class="n">v24</span> <span class="o">=</span> <span class="n">mul3</span><span class="p">[</span><span class="n">mask3</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">^</span> <span class="n">mul2</span><span class="p">[(</span><span class="kt">unsigned</span> <span class="kr">__int8</span><span class="p">)</span><span class="n">byte_D0377D</span><span class="p">]</span> <span class="o">^</span> <span class="n">byte_D03779</span> <span class="o">^</span> <span class="n">byte_D03775</span><span class="p">;</span>
<span class="n">byte_D03775</span> <span class="o">=</span> <span class="n">mul3</span><span class="p">[(</span><span class="kt">unsigned</span> <span class="kr">__int8</span><span class="p">)</span><span class="n">byte_D03779</span><span class="p">]</span> <span class="o">^</span> <span class="n">mul2</span><span class="p">[(</span><span class="kt">unsigned</span> <span class="kr">__int8</span><span class="p">)</span><span class="n">byte_D03775</span><span class="p">]</span> <span class="o">^</span> <span class="n">mask3</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">^</span> <span class="n">byte_D0377D</span><span class="p">;</span>
<span class="n">mask3</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">v23</span><span class="p">;</span>
<span class="n">byte_D03779</span> <span class="o">=</span> <span class="n">v22</span><span class="p">;</span>
<span class="n">byte_D0377D</span> <span class="o">=</span> <span class="n">v24</span><span class="p">;</span>
<span class="n">v25</span> <span class="o">=</span> <span class="n">mul3</span><span class="p">[(</span><span class="kt">unsigned</span> <span class="kr">__int8</span><span class="p">)</span><span class="n">byte_D0377E</span><span class="p">]</span> <span class="o">^</span> <span class="n">mul2</span><span class="p">[(</span><span class="kt">unsigned</span> <span class="kr">__int8</span><span class="p">)</span><span class="n">byte_D0377A</span><span class="p">]</span> <span class="o">^</span> <span class="n">byte_D03776</span> <span class="o">^</span> <span class="n">mask3</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="n">v26</span> <span class="o">=</span> <span class="n">mul3</span><span class="p">[</span><span class="n">mask3</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">^</span> <span class="n">mul2</span><span class="p">[(</span><span class="kt">unsigned</span> <span class="kr">__int8</span><span class="p">)</span><span class="n">byte_D0377E</span><span class="p">]</span> <span class="o">^</span> <span class="n">byte_D0377A</span> <span class="o">^</span> <span class="n">byte_D03776</span><span class="p">;</span>
<span class="n">v27</span> <span class="o">=</span> <span class="n">mul3</span><span class="p">[(</span><span class="kt">unsigned</span> <span class="kr">__int8</span><span class="p">)</span><span class="n">byte_D03776</span><span class="p">]</span> <span class="o">^</span> <span class="n">mul2</span><span class="p">[</span><span class="n">mask3</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">^</span> <span class="n">byte_D0377E</span> <span class="o">^</span> <span class="n">byte_D0377A</span><span class="p">;</span>
<span class="n">byte_D03776</span> <span class="o">=</span> <span class="n">mul3</span><span class="p">[(</span><span class="kt">unsigned</span> <span class="kr">__int8</span><span class="p">)</span><span class="n">byte_D0377A</span><span class="p">]</span> <span class="o">^</span> <span class="n">mul2</span><span class="p">[(</span><span class="kt">unsigned</span> <span class="kr">__int8</span><span class="p">)</span><span class="n">byte_D03776</span><span class="p">]</span> <span class="o">^</span> <span class="n">byte_D0377E</span> <span class="o">^</span> <span class="n">mask3</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="n">byte_D0377A</span> <span class="o">=</span> <span class="n">v25</span><span class="p">;</span>
<span class="n">byte_D0377E</span> <span class="o">=</span> <span class="n">v26</span><span class="p">;</span>
<span class="n">mask3</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">v27</span><span class="p">;</span>
<span class="n">v28</span> <span class="o">=</span> <span class="n">mul3</span><span class="p">[(</span><span class="kt">unsigned</span> <span class="kr">__int8</span><span class="p">)</span><span class="n">byte_D03777</span><span class="p">]</span> <span class="o">^</span> <span class="n">mul2</span><span class="p">[</span><span class="n">mask3</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span> <span class="o">^</span> <span class="n">byte_D0377F</span> <span class="o">^</span> <span class="n">byte_D0377B</span><span class="p">;</span>
<span class="n">v29</span> <span class="o">=</span> <span class="n">mul3</span><span class="p">[(</span><span class="kt">unsigned</span> <span class="kr">__int8</span><span class="p">)</span><span class="n">byte_D0377F</span><span class="p">]</span> <span class="o">^</span> <span class="n">mul2</span><span class="p">[(</span><span class="kt">unsigned</span> <span class="kr">__int8</span><span class="p">)</span><span class="n">byte_D0377B</span><span class="p">]</span> <span class="o">^</span> <span class="n">byte_D03777</span> <span class="o">^</span> <span class="n">mask3</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
<span class="n">v30</span> <span class="o">=</span> <span class="n">mul3</span><span class="p">[</span><span class="n">mask3</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span> <span class="o">^</span> <span class="n">mul2</span><span class="p">[(</span><span class="kt">unsigned</span> <span class="kr">__int8</span><span class="p">)</span><span class="n">byte_D0377F</span><span class="p">]</span> <span class="o">^</span> <span class="n">byte_D0377B</span> <span class="o">^</span> <span class="n">byte_D03777</span><span class="p">;</span>
<span class="n">byte_D03777</span> <span class="o">=</span> <span class="n">mul3</span><span class="p">[(</span><span class="kt">unsigned</span> <span class="kr">__int8</span><span class="p">)</span><span class="n">byte_D0377B</span><span class="p">]</span> <span class="o">^</span> <span class="n">mul2</span><span class="p">[(</span><span class="kt">unsigned</span> <span class="kr">__int8</span><span class="p">)</span><span class="n">byte_D03777</span><span class="p">]</span> <span class="o">^</span> <span class="n">byte_D0377F</span> <span class="o">^</span> <span class="n">mask3</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
<span class="n">mask3</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">v28</span><span class="p">;</span>
<span class="n">byte_D0377B</span> <span class="o">=</span> <span class="n">v29</span><span class="p">;</span>
<span class="n">byte_D0377F</span> <span class="o">=</span> <span class="n">v30</span><span class="p">;</span>
<span class="o">*</span><span class="p">(</span><span class="kr">__m128i</span> <span class="o">*</span><span class="p">)</span><span class="n">mask3</span> <span class="o">=</span> <span class="n">_mm_xor_si128</span><span class="p">(</span><span class="n">_mm_load_si128</span><span class="p">((</span><span class="k">const</span> <span class="kr">__m128i</span> <span class="o">*</span><span class="p">)</span><span class="n">mask</span><span class="p">),</span> <span class="o">*</span><span class="p">(</span><span class="kr">__m128i</span> <span class="o">*</span><span class="p">)</span><span class="n">mask3</span><span class="p">);</span>
</pre></div>


<p><code>mul3</code> and <code>mul2</code> are basically arrays that are designed to have <code>mul2[idx] = idx * 2</code> and <code>mul3[idx] = idx * 3</code>.</p>
<div class="highlight"><pre><span></span><span class="k">const</span> <span class="kt">uint8_t</span> <span class="n">mul2</span><span class="p">[</span><span class="mi">256</span><span class="p">]</span> <span class="p">{</span>
    <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span>
    <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span>
    <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="mh">0x2c</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span>
    <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x3e</span><span class="p">,</span>
    <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x4a</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">,</span> <span class="mh">0x4e</span><span class="p">,</span>
    <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0x5a</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span>
    <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="mh">0x6a</span><span class="p">,</span> <span class="mh">0x6c</span><span class="p">,</span> <span class="mh">0x6e</span><span class="p">,</span>
    <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">,</span> <span class="mh">0x76</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0x7e</span><span class="p">,</span>
    <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">,</span> <span class="mh">0x8a</span><span class="p">,</span> <span class="mh">0x8c</span><span class="p">,</span> <span class="mh">0x8e</span><span class="p">,</span>
    <span class="mh">0x90</span><span class="p">,</span> <span class="mh">0x92</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">,</span> <span class="mh">0x96</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">,</span> <span class="mh">0x9a</span><span class="p">,</span> <span class="mh">0x9c</span><span class="p">,</span> <span class="mh">0x9e</span><span class="p">,</span>
    <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0xa2</span><span class="p">,</span> <span class="mh">0xa4</span><span class="p">,</span> <span class="mh">0xa6</span><span class="p">,</span> <span class="mh">0xa8</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0xac</span><span class="p">,</span> <span class="mh">0xae</span><span class="p">,</span>
    <span class="mh">0xb0</span><span class="p">,</span> <span class="mh">0xb2</span><span class="p">,</span> <span class="mh">0xb4</span><span class="p">,</span> <span class="mh">0xb6</span><span class="p">,</span> <span class="mh">0xb8</span><span class="p">,</span> <span class="mh">0xba</span><span class="p">,</span> <span class="mh">0xbc</span><span class="p">,</span> <span class="mh">0xbe</span><span class="p">,</span>
    <span class="mh">0xc0</span><span class="p">,</span> <span class="mh">0xc2</span><span class="p">,</span> <span class="mh">0xc4</span><span class="p">,</span> <span class="mh">0xc6</span><span class="p">,</span> <span class="mh">0xc8</span><span class="p">,</span> <span class="mh">0xca</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">,</span> <span class="mh">0xce</span><span class="p">,</span>
    <span class="mh">0xd0</span><span class="p">,</span> <span class="mh">0xd2</span><span class="p">,</span> <span class="mh">0xd4</span><span class="p">,</span> <span class="mh">0xd6</span><span class="p">,</span> <span class="mh">0xd8</span><span class="p">,</span> <span class="mh">0xda</span><span class="p">,</span> <span class="mh">0xdc</span><span class="p">,</span> <span class="mh">0xde</span><span class="p">,</span>
    <span class="mh">0xe0</span><span class="p">,</span> <span class="mh">0xe2</span><span class="p">,</span> <span class="mh">0xe4</span><span class="p">,</span> <span class="mh">0xe6</span><span class="p">,</span> <span class="mh">0xe8</span><span class="p">,</span> <span class="mh">0xea</span><span class="p">,</span> <span class="mh">0xec</span><span class="p">,</span> <span class="mh">0xee</span><span class="p">,</span>
    <span class="mh">0xf0</span><span class="p">,</span> <span class="mh">0xf2</span><span class="p">,</span> <span class="mh">0xf4</span><span class="p">,</span> <span class="mh">0xf6</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mh">0xfa</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">,</span> <span class="mh">0xfe</span><span class="p">,</span>
    <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span>
    <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span>
    <span class="mh">0x3b</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span>
    <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0x2d</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span>
    <span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x59</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">,</span> <span class="mh">0x5d</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span>
    <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x4f</span><span class="p">,</span> <span class="mh">0x4d</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">,</span>
    <span class="mh">0x7b</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">,</span> <span class="mh">0x77</span><span class="p">,</span> <span class="mh">0x75</span><span class="p">,</span>
    <span class="mh">0x6b</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0x6d</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span>
    <span class="mh">0x9b</span><span class="p">,</span> <span class="mh">0x99</span><span class="p">,</span> <span class="mh">0x9f</span><span class="p">,</span> <span class="mh">0x9d</span><span class="p">,</span> <span class="mh">0x93</span><span class="p">,</span> <span class="mh">0x91</span><span class="p">,</span> <span class="mh">0x97</span><span class="p">,</span> <span class="mh">0x95</span><span class="p">,</span>
    <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">,</span> <span class="mh">0x8f</span><span class="p">,</span> <span class="mh">0x8d</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span>
    <span class="mh">0xbb</span><span class="p">,</span> <span class="mh">0xb9</span><span class="p">,</span> <span class="mh">0xbf</span><span class="p">,</span> <span class="mh">0xbd</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0xb1</span><span class="p">,</span> <span class="mh">0xb7</span><span class="p">,</span> <span class="mh">0xb5</span><span class="p">,</span>
    <span class="mh">0xab</span><span class="p">,</span> <span class="mh">0xa9</span><span class="p">,</span> <span class="mh">0xaf</span><span class="p">,</span> <span class="mh">0xad</span><span class="p">,</span> <span class="mh">0xa3</span><span class="p">,</span> <span class="mh">0xa1</span><span class="p">,</span> <span class="mh">0xa7</span><span class="p">,</span> <span class="mh">0xa5</span><span class="p">,</span>
    <span class="mh">0xdb</span><span class="p">,</span> <span class="mh">0xd9</span><span class="p">,</span> <span class="mh">0xdf</span><span class="p">,</span> <span class="mh">0xdd</span><span class="p">,</span> <span class="mh">0xd3</span><span class="p">,</span> <span class="mh">0xd1</span><span class="p">,</span> <span class="mh">0xd7</span><span class="p">,</span> <span class="mh">0xd5</span><span class="p">,</span>
    <span class="mh">0xcb</span><span class="p">,</span> <span class="mh">0xc9</span><span class="p">,</span> <span class="mh">0xcf</span><span class="p">,</span> <span class="mh">0xcd</span><span class="p">,</span> <span class="mh">0xc3</span><span class="p">,</span> <span class="mh">0xc1</span><span class="p">,</span> <span class="mh">0xc7</span><span class="p">,</span> <span class="mh">0xc5</span><span class="p">,</span>
    <span class="mh">0xfb</span><span class="p">,</span> <span class="mh">0xf9</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xfd</span><span class="p">,</span> <span class="mh">0xf3</span><span class="p">,</span> <span class="mh">0xf1</span><span class="p">,</span> <span class="mh">0xf7</span><span class="p">,</span> <span class="mh">0xf5</span><span class="p">,</span>
    <span class="mh">0xeb</span><span class="p">,</span> <span class="mh">0xe9</span><span class="p">,</span> <span class="mh">0xef</span><span class="p">,</span> <span class="mh">0xed</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0xe1</span><span class="p">,</span> <span class="mh">0xe7</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span>
<span class="p">};</span>
</pre></div>


<p>One thing of interest, maybe, is that there is a small anti-debug in there. The file is opened and read (using one of <code>std::vector</code>'s constructor that takes an <code>std::ifstreambuf_iterator</code>. Didn't even know it was a thing!), and some sort of sum of control is generated; and this value is used later in the <code>schedule</code> routine. It means that if you were about to go and patch the binary for whatever reasons, the algorithm would end up generating different values. Again, this is barely an inconvenience as we can just dump it out and ignore it.</p>
<div class="highlight"><pre><span></span><span class="n">std</span><span class="o">::</span><span class="n">basic_ifstream</span><span class="o">&lt;</span><span class="kt">char</span><span class="p">,</span><span class="n">std</span><span class="o">::</span><span class="n">char_traits</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;&gt;::</span><span class="n">basic_ifstream</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v63</span><span class="p">,</span> <span class="o">*</span><span class="n">v3</span><span class="p">,</span> <span class="mi">4LL</span><span class="p">);</span>
<span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">,</span><span class="n">std</span><span class="o">::</span><span class="n">allocator</span><span class="o">&lt;</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="o">&gt;&gt;::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">istreambuf_iterator</span><span class="o">&lt;</span><span class="kt">char</span><span class="p">,</span><span class="n">std</span><span class="o">::</span><span class="n">char_traits</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;&gt;</span><span class="p">,</span><span class="kt">void</span><span class="o">&gt;</span><span class="p">(</span>
  <span class="o">&amp;</span><span class="n">v46</span><span class="p">,</span>
  <span class="o">*</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">**</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">v64</span> <span class="o">+</span> <span class="o">*</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">v63</span> <span class="o">-</span> <span class="mi">24</span><span class="p">)),</span>
  <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
  <span class="mi">0LL</span><span class="p">,</span>
  <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="n">v31</span> <span class="o">=</span> <span class="n">v46</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="kt">signed</span> <span class="kt">int</span><span class="p">)</span><span class="n">v47</span> <span class="o">-</span> <span class="p">(</span><span class="kt">signed</span> <span class="kt">int</span><span class="p">)</span><span class="n">v46</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span>
<span class="p">{</span>
  <span class="n">v32</span> <span class="o">=</span> <span class="mi">0LL</span><span class="p">;</span>
  <span class="n">v33</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)(</span><span class="n">v47</span> <span class="o">-</span> <span class="p">(</span><span class="n">_DWORD</span><span class="p">)</span><span class="n">v46</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1LL</span><span class="p">;</span>
  <span class="k">do</span>
  <span class="p">{</span>
    <span class="n">v34</span> <span class="o">=</span> <span class="n">v32</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">;</span>
    <span class="n">v35</span> <span class="o">=</span> <span class="n">v31</span><span class="p">[</span><span class="n">v32</span><span class="o">++</span><span class="p">]</span> <span class="o">^</span> <span class="o">*</span><span class="p">((</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">crc</span> <span class="o">+</span> <span class="n">v34</span><span class="p">);</span>
    <span class="o">*</span><span class="p">((</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">crc</span> <span class="o">+</span> <span class="n">v34</span><span class="p">)</span> <span class="o">=</span> <span class="n">v35</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">while</span> <span class="p">(</span> <span class="n">v32</span> <span class="o">!=</span> <span class="n">v33</span> <span class="p">);</span>
<span class="p">}</span>
</pre></div>


<h2 id="generation">Generation</h2>
<p>At this point, the 15 <code>i</code>'s from above are used to initialize what I called <code>s0</code>, <code>s1</code>, ..., <code>s14</code>. Again, it is 15 blobs of 16 bytes each. This state is then passed to the <code>schedule</code> function that will do a lot of arithmetic operations on this state. Again, no need to understand <code>schedule</code> just yet; as far as we are concerned it is a black box that takes a state in input and gives us a state in output, period.</p>
<p>Each 16 bytes (xmmwords) of the <code>state</code> (<code>s0</code>, ..., <code>s14</code>) is XOR'ed together, and if the resulting xmmword obeys a bunch of constraints then you get the good boy.</p>
<p>The constraints look like this:</p>
<div class="highlight"><pre><span></span><span class="n">h1</span> <span class="o">=</span> <span class="n">mxor</span><span class="p">.</span><span class="n">m128i_u8</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|</span> <span class="p">((</span><span class="n">mxor</span><span class="p">.</span><span class="n">m128i_u8</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">|</span> <span class="p">((</span><span class="n">mxor</span><span class="p">.</span><span class="n">m128i_u8</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">|</span> <span class="p">((</span><span class="n">mxor</span><span class="p">.</span><span class="n">m128i_u8</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">|</span> <span class="p">((</span><span class="n">mxor</span><span class="p">.</span><span class="n">m128i_u8</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|</span> <span class="p">((</span><span class="n">mxor</span><span class="p">.</span><span class="n">m128i_u8</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">|</span> <span class="p">((</span><span class="n">mxor</span><span class="p">.</span><span class="n">m128i_u8</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">|</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kr">__int64</span><span class="p">)</span><span class="n">mxor</span><span class="p">.</span><span class="n">m128i_u8</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
<span class="n">h2</span> <span class="o">=</span> <span class="n">mxor</span><span class="p">.</span><span class="n">m128i_u8</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|</span> <span class="p">((</span><span class="n">mxor</span><span class="p">.</span><span class="n">m128i_u8</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">|</span> <span class="p">((</span><span class="n">mxor</span><span class="p">.</span><span class="n">m128i_u8</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">|</span> <span class="p">((</span><span class="n">mxor</span><span class="p">.</span><span class="n">m128i_u8</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">|</span> <span class="p">((</span><span class="n">mxor</span><span class="p">.</span><span class="n">m128i_u8</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|</span> <span class="p">((</span><span class="n">mxor</span><span class="p">.</span><span class="n">m128i_u8</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">|</span> <span class="p">((</span><span class="n">mxor</span><span class="p">.</span><span class="n">m128i_u8</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">|</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kr">__int64</span><span class="p">)</span><span class="n">mxor</span><span class="p">.</span><span class="n">m128i_u8</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span> <span class="n">BYTE6</span><span class="p">(</span><span class="n">h2</span><span class="p">)</span> <span class="o">==</span> <span class="sc">&#39;i&#39;</span>
  <span class="o">&amp;&amp;</span> <span class="n">BYTE5</span><span class="p">(</span><span class="n">h2</span><span class="p">)</span> <span class="o">==</span> <span class="sc">&#39;7&#39;</span>
  <span class="o">&amp;&amp;</span> <span class="n">BYTE4</span><span class="p">(</span><span class="n">h2</span><span class="p">)</span> <span class="o">==</span> <span class="sc">&#39;\x13&#39;</span>
  <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">mxor</span><span class="p">.</span><span class="n">m128i_u8</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|</span> <span class="p">((</span><span class="n">mxor</span><span class="p">.</span><span class="n">m128i_u8</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">|</span> <span class="p">((</span><span class="n">mxor</span><span class="p">.</span><span class="n">m128i_u8</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">|</span> <span class="p">((</span><span class="n">mxor</span><span class="p">.</span><span class="n">m128i_u8</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">|</span> <span class="p">((</span><span class="n">mxor</span><span class="p">.</span><span class="n">m128i_u8</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|</span> <span class="p">((</span><span class="n">mxor</span><span class="p">.</span><span class="n">m128i_u8</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">|</span> <span class="p">((</span><span class="n">mxor</span><span class="p">.</span><span class="n">m128i_u8</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">|</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">mxor</span><span class="p">.</span><span class="n">m128i_u8</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span> <span class="o">==</span> <span class="mi">66</span>
  <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kr">__int8</span><span class="p">)((</span><span class="n">mxor</span><span class="p">.</span><span class="n">m128i_u8</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|</span> <span class="p">((</span><span class="n">mxor</span><span class="p">.</span><span class="n">m128i_u8</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">|</span> <span class="p">((</span><span class="n">mxor</span><span class="p">.</span><span class="n">m128i_u8</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">|</span> <span class="p">((</span><span class="n">mxor</span><span class="p">.</span><span class="n">m128i_u8</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">|</span> <span class="p">((</span><span class="n">mxor</span><span class="p">.</span><span class="n">m128i_u8</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|</span> <span class="p">((</span><span class="n">mxor</span><span class="p">.</span><span class="n">m128i_u8</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">|</span> <span class="p">((</span><span class="n">mxor</span><span class="p">.</span><span class="n">m128i_u8</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">|</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">mxor</span><span class="p">.</span><span class="n">m128i_u8</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">==</span> <span class="mi">105</span>
  <span class="o">&amp;&amp;</span> <span class="n">BYTE1</span><span class="p">(</span><span class="n">h2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">55</span>
  <span class="o">&amp;&amp;</span> <span class="n">mxor</span><span class="p">.</span><span class="n">m128i_i8</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">19</span>
  <span class="o">&amp;&amp;</span> <span class="n">HIBYTE</span><span class="p">(</span><span class="n">h1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">66</span>
  <span class="o">&amp;&amp;</span> <span class="n">BYTE6</span><span class="p">(</span><span class="n">h1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">105</span>
  <span class="o">&amp;&amp;</span> <span class="n">BYTE5</span><span class="p">(</span><span class="n">h1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">55</span>
  <span class="o">&amp;&amp;</span> <span class="n">BYTE4</span><span class="p">(</span><span class="n">h1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">19</span>
  <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">mxor</span><span class="p">.</span><span class="n">m128i_u8</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|</span> <span class="p">((</span><span class="n">mxor</span><span class="p">.</span><span class="n">m128i_u8</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">|</span> <span class="p">((</span><span class="n">mxor</span><span class="p">.</span><span class="n">m128i_u8</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">|</span> <span class="p">((</span><span class="n">mxor</span><span class="p">.</span><span class="n">m128i_u8</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">|</span> <span class="p">((</span><span class="n">mxor</span><span class="p">.</span><span class="n">m128i_u8</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|</span> <span class="p">((</span><span class="n">mxor</span><span class="p">.</span><span class="n">m128i_u8</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">|</span> <span class="p">((</span><span class="n">mxor</span><span class="p">.</span><span class="n">m128i_u8</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">|</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">mxor</span><span class="p">.</span><span class="n">m128i_u8</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span> <span class="o">==</span> <span class="mi">66</span>
  <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kr">__int8</span><span class="p">)((</span><span class="n">mxor</span><span class="p">.</span><span class="n">m128i_u8</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|</span> <span class="p">((</span><span class="n">mxor</span><span class="p">.</span><span class="n">m128i_u8</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">|</span> <span class="p">((</span><span class="n">mxor</span><span class="p">.</span><span class="n">m128i_u8</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">|</span> <span class="p">((</span><span class="n">mxor</span><span class="p">.</span><span class="n">m128i_u8</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">|</span> <span class="p">((</span><span class="n">mxor</span><span class="p">.</span><span class="n">m128i_u8</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|</span> <span class="p">((</span><span class="n">mxor</span><span class="p">.</span><span class="n">m128i_u8</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">|</span> <span class="p">((</span><span class="n">mxor</span><span class="p">.</span><span class="n">m128i_u8</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">|</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">mxor</span><span class="p">.</span><span class="n">m128i_u8</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">==</span> <span class="mi">105</span>
  <span class="o">&amp;&amp;</span> <span class="n">BYTE1</span><span class="p">(</span><span class="n">h1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">55</span>
  <span class="o">&amp;&amp;</span> <span class="n">mxor</span><span class="p">.</span><span class="n">m128i_i8</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">19</span>
  <span class="o">&amp;&amp;</span> <span class="n">h2</span> <span class="o">&gt;&gt;</span> <span class="mi">56</span> <span class="o">==</span> <span class="mi">66</span> <span class="p">)</span>
<span class="p">{</span>
  <span class="n">puts</span><span class="p">(</span><span class="s">&quot;**** Login Successful ****&quot;</span><span class="p">);</span>
  <span class="n">v42</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">else</span>
<span class="p">{</span>
  <span class="n">puts</span><span class="p">(</span><span class="s">&quot;**** Login Failed ****&quot;</span><span class="p">);</span>
  <span class="n">v42</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<p>This garbage above simply translates to <code>win = (mxor == 0x42424242696969693737373713131313ULL) ? true : false</code> if you look at it closer by the way :).</p>
<h1 id="zooming-in">Zooming in</h1>
<p>This is now time to zoom in some specific parts at this point; we sort of know what we need to achieve, and we need to know how. We know several things. We know we have some dumping to do: <code>mask</code>, <code>mask3</code>, <code>shiftedmask</code>, <code>crc</code>, <code>sbx</code> and <code>mul2</code>, <code>mul3</code>. But the most important part is to understand a bit more <code>schedule</code> obviously. It is the heart of the challenge for now.</p>
<h2 id="schedule">schedule</h2>
<p>The function doesn't look too bad which is always nice for us. The first part of the function is randomly selecting one of the <code>s</code>'s variable.</p>
<div class="highlight"><pre><span></span><span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">rand</span><span class="p">()</span> <span class="o">%</span> <span class="mi">15</span><span class="p">;</span> <span class="n">scheduling</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">40</span><span class="p">;</span> <span class="n">i</span> <span class="o">=</span> <span class="n">rand</span><span class="p">()</span> <span class="o">%</span> <span class="mi">15</span><span class="p">);</span>
<span class="n">nround</span> <span class="o">=</span> <span class="n">scheduling</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</pre></div>


<p>The switch case that follows basically applies one type of transformation (arithmetic ones) onto the chosen <code>s</code> variable. In order to track the number of rounds already applied to the state variables, an array called <code>scheduling</code> is used. The algorithm stops when every <code>s</code> variable has been applied 40 rounds on them. There's also a simple anti-debugging in here; a timer is started at the beginning (<code>t1</code>) of the round and stopped at the end (<code>t2</code>). The result of <code>t2 - t1</code> is injected back into the current <code>s</code> variable which means that if you've been debugging a round, the current state is poluted and produces the wrong result.</p>
<p>We can observe 6 different type of operations. Some of them look very easily inversible and some others that'd need some more work. But at this point, it really reminds me of this AES white-box that I analyzed back in <a href="https://github.com/0vercl0k/articles/blob/master/AES%20Whitebox%20Unboxing%20No%20Such%20Problem.pdf">AES Whitebox Unboxing No Such Problem</a>, 2013. This one doesn't have any obfuscation though which makes it so much easier to deal with. In this article, I basically divided and conqueered. I isolated each round by chunk of four bytes; each one of those quarter of round worked as a black box function that took 4 bytes of input and generated 4 bytes of output. I wanted to find the 4 bytes of input that would give me the 4 bytes of output I wanted. Solving those quarters could be done simultaneously and starting from the desired output you could go from round <code>N</code> to round <code>N-1</code>. </p>
                </div><!-- /.entry-content -->
        </article>
</section>
        </div><!--/span-->
      </div><!--/row-->
      <hr>

      <footer style='background-color:#00000000'>
        <center>
          <address id="about">
                  Proudly powered by <a href="http://pelican.notmyidea.org/">Pelican <i class="icon-external-link"></i></a>,
                                  which takes great advantage of <a href="http://python.org">Python <i class="icon-external-link"></i></a>.
          </address><!-- /#about -->

          <p>The theme is from <a href="http://twitter.github.com/bootstrap/">Bootstrap from Twitter <i class="icon-external-link"></i></a>,
                     and <a href="http://fortawesome.github.com/Font-Awesome/">Font-Awesome <i class="icon-external-link"></i></a>, thanks!</p>
        </center>
      </footer>

    </div><!--/.fluid-container-->


    <script src="/theme/js/jquery-1.7.2.min.js"></script>
    <script src="/theme/js/bootstrap.min.js"></script>
  </body>
</html>