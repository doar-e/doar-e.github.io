<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Spotlight on an unprotected AES128 white-box implementation</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="Axel '0vercl0k' Souchet">
    <link rel="stylesheet" href="../../../../../theme/css/bootstrap.min.css" type="text/css" />
    <style type="text/css">
      body {
        padding-top: 60px;
        padding-bottom: 40px;
      }
      .sidebar-nav {
        padding: 9px 0;
      }
      .tag-1 {
        font-size: 13pt;
      }
      .tag-2 {
        font-size: 10pt;
      }
      .tag-2 {
        font-size: 8pt;
      }
      .tag-4 {
        font-size: 6pt;
     }
    </style>
    <link href="../../../../../theme/css/bootstrap-responsive.min.css" rel="stylesheet" />
    <link href="../../../../../theme/css/font-awesome.css" rel="stylesheet" />
    <link href="../../../../../theme/css/pygments.css" rel="stylesheet" />

    <!--[if lt IE 9]>
      <script src="//html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <link href="../../../../../feeds/atom.xml" type="application/atom+xml" rel="alternate" title="Diary of a reverse-engineer ATOM Feed" />
    <link href="../../../../../feeds/rss.xml" type="application/atom+xml" rel="alternate" title="Diary of a reverse-engineer RSS Feed" />

  </head>

  <body>

    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container-fluid">
          <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
          <a class="brand" href="../../../../../index.html">Diary of a reverse-engineer </a>
          <div class="nav-collapse">
            <ul class="nav">
              <ul class="nav">
                    <li><a href="../../../../../archives.html"><i class="icon-th-list"></i>Archives</a></li>
              </ul>

                <li >
                    <a href="../../../../../category/debugging.html">
                      <i class="icon-folder-open icon-large"></i>debugging
                    </a>
                </li>
                <li >
                    <a href="../../../../../category/exploitation.html">
                      <i class="icon-folder-open icon-large"></i>exploitation
                    </a>
                </li>
                <li >
                    <a href="../../../../../category/misc.html">
                      <i class="icon-folder-open icon-large"></i>misc
                    </a>
                </li>
                <li class="active">
                    <a href="../../../../../category/obfuscation.html">
                      <i class="icon-folder-open icon-large"></i>obfuscation
                    </a>
                </li>
                <li >
                    <a href="../../../../../category/reverse-engineering.html">
                      <i class="icon-folder-open icon-large"></i>reverse-engineering
                    </a>
                </li>

                <li><a href="../../../../../pages/about.html">About</a></li>
                <li><a href="../../../../../pages/presentations.html">Presentations</a></li>

            </ul>
          </div><!--/.nav-collapse -->
        </div>
      </div>
    </div>

    <div class="container-fluid">
      <div class="row">
        <div class="span9" id="content">
<section id="content">
        <article>
                <header>
                        <h1>
                                <a href=""
                                        rel="bookmark"
                                        title="Permalink to Spotlight on an unprotected AES128 white-box implementation">
                                        Spotlight on an unprotected AES128 white-box implementation
                                </a>
                        </h1>
                </header>
                <div class="entry-content">
                <div class="well">
<footer class="post-info">
<span class="label">Date</span>
<abbr class="published" title="2015-02-08T22:59:00-08:00">
        <i class="icon-calendar"></i>Sun 08 February 2015
</abbr>
<span class="label">By</span>
<a href="../../../../../author/axel-0vercl0k-souchet.html"><i class="icon-user"></i>Axel "0vercl0k" Souchet</a>
<span class="label">Category</span>
<a href="../../../../../category/obfuscation.html"><i class="icon-folder-open"></i>obfuscation</a>


<span class="label">Tags</span>
	<a href="../../../../../tag/obfuscation.html"><i class="icon-tag"></i>obfuscation</a>
	<a href="../../../../../tag/white-box.html"><i class="icon-tag"></i>white-box</a>
	<a href="../../../../../tag/practical-cryptography.html"><i class="icon-tag"></i>practical cryptography</a>
	<a href="../../../../../tag/aes128.html"><i class="icon-tag"></i>aes128</a>
	<a href="../../../../../tag/encryption.html"><i class="icon-tag"></i>encryption</a>
</footer><!-- /.post-info -->                </div>
                <h1 id="introduction">Introduction</h1>
<p>I think it all began when I've worked on the <a href="https://github.com/0vercl0k/stuffz/tree/master/NoSuchCon2013">NSC2013</a> crackme made by <a href="https://twitter.com/elvanderb">@elvanderb</a>, long story short you had an AES128 heavily obfuscated white-box implementation to break. The thing was you could actually solve the challenge in different ways: </p>
<ol>
<li>the first one was the easiest one: you didn't need to know anything about white-box, crypto or even AES ; you could just see the function as a black-box &amp; try to find "design flaws" in its inner-workings</li>
<li>the elite way: this one involved to understand &amp; recover the entire design of the white-box, then to identify design weaknesses that allows the challenger to directly attack &amp; recover the encryption key. A really nice write-up has been recently written by <a href="https://twitter.com/doegox">@doegox</a>, check it out, really :): <a href="http://wiki.yobi.be/wiki/NSC_Writeups">Oppida/NoSuchCon challenge</a>.</li>
</ol>
<p>The annoying thing is that you don't have a lot of understandable available C code on the web that implement such things, nevertheless you do have quite some nice academic references ; they are a really good resource to build your own.</p>
<p>This post aims to present briefly, in a simple way what an AES white-box looks like, and to show how its design is important if you want to not have your encryption key extracted :). The implementation I'm going to talk about today is not my creation at all, I just followed the first part (might do another post talking about the second part? Who knows) of a really <a href="https://github.com/0vercl0k/stuffz/raw/master/wbaes_attack/docs/a_tutorial_on_whitebox_aes.pdf">nice paper</a> (even for non-mathematical / crypto guys like me!) written by James A. Muir.</p>
<p>The idea is simple: we will start from a clean AES128 encryption function in plain C, we will modify it &amp; transform it into a white-box implementation in several steps.
As usual, all the code are available on my github account; you are encourage to break &amp; hack them!</p>
<p>Of course, we will use this post to briefly present what is the white-box cryptography, what are the goals &amp; why it's kind of cool.</p>
<p>Before diving deep, here is the table of contents:</p>


<div class="toc"><span class="toctitle">Table of contents:</span><ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#aes128">AES128</a><ul>
<li><a href="#introduction_1">Introduction</a></li>
<li><a href="#key-schedule">Key schedule</a></li>
<li><a href="#encryption-process">Encryption process</a><ul>
<li><a href="#transformations">Transformations</a><ul>
<li><a href="#addroundkey">AddRoundKey</a></li>
<li><a href="#subbytes">SubBytes</a></li>
<li><a href="#shiftrows">ShiftRows</a></li>
<li><a href="#mixcolumns">MixColumns</a></li>
</ul>
</li>
<li><a href="#combine-them-together">Combine them together</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#white-boxing-aes128-in-7-steps">White-boxing AES128 in ~7 steps</a><ul>
<li><a href="#introduction_2">Introduction</a></li>
<li><a href="#step-1-bring-the-first-addroundkey-in-the-loop-kick-out-the-last-one-out-of-it">Step 1: bring the first AddRoundKey in the loop &amp; kick out the last one out of it</a></li>
<li><a href="#step-2-subbytes-then-shiftrows-equals-shiftrows-then-subbytes">Step 2: SubBytes then ShiftRows equals ShiftRows then SubBytes</a></li>
<li><a href="#step-3-shiftrows-first-but-needs-to-shiftrows-the-round-key">Step 3: ShiftRows first, but needs to ShiftRows the round-key</a></li>
<li><a href="#step-4-white-boxing-it-like-its-hot-white-boxing-it-like-its-hot">Step 4: White-boxing it like it's hot, White-boxing it like it's hot</a></li>
<li><a href="#step-5-transforming-mixcolumns-in-a-look-up-table">Step 5: Transforming MixColumns in a look-up table</a></li>
<li><a href="#step-6-adding-a-little-xor-table">Step 6: Adding a little xor table</a></li>
<li><a href="#step-7-combining-tboxes-ty-tables">Step 7: Combining TBoxes &amp; Ty tables</a></li>
<li><a href="#final-code">Final code</a></li>
</ul>
</li>
<li><a href="#attacking-the-white-box-extract-the-key">Attacking the white-box: extract the key</a></li>
<li><a href="#obfuscating-it">Obfuscating it?</a></li>
<li><a href="#last-words">Last words</a></li>
</ul>
</div>
<h1 id="aes128">AES128</h1>
<h2 id="introduction_1">Introduction</h2>
<p>All right, here we are: this part is just a reminder of how AES (with a 128 bits key) roughly works. If you know that already, feel free to go to the next level. Basically in here I just want us to build our first function: a simple block encryption. The signature of the function will be something, as you expect, like this:</p>
<div class="highlight"><pre><span></span><code>    <span class="kt">void</span> <span class="n">aes128_enc_base</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">in</span><span class="p">[</span><span class="mi">16</span><span class="p">],</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">out</span><span class="p">[</span><span class="mi">16</span><span class="p">],</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">key</span><span class="p">[</span><span class="mi">16</span><span class="p">])</span>
</code></pre></div>

<p>The encryption works in eleven rounds, the first one &amp; the last one are slightly different than the nine others ; but they all rely on four different operations. Those operations are called: AddRoundKey, SubBytes, ShiftRows, MixColumns. Each round modifies a 128 bits state with a 128 bits round-key. Those round-keys are generated from the encryption key after a key expansion (called key schedule) function. Note that the first round-key is actually the encryption key.</p>
<p>The first part of an AES encryption is to execute the key schedule in order to get our round-keys ; once we have them all it's just a matter of using the four different operations we saw to generate the encrypted plain-text.</p>
<p>I know that I quite like to see how crypto algorithms work in a visual way, if this is also your case check this SWF animation (no exploit in here, don't worry :)): <a href="http://www.formaestudio.com/rijndaelinspector/archivos/Rijndael_Animation_v4_eng.swf">Rijndael_Animation_v4_eng.swf</a> ; else you can also read the <a href="http://csrc.nist.gov/publications/fips/fips197/fips-197.pdf">FIPS-197</a> document.</p>
<h2 id="key-schedule">Key schedule</h2>
<p>The key schedule is like the most important part of the algorithm. As I said a bit earlier, this function is a derivation one: it takes the encryption key as input and will generate the round-keys the encryption process will use as output.</p>
<p>I don't really feel like explaining in detail how it works (as it is a bit tricky to explain that with words), I would rather advise you to read the FIPS document or to follow the flash animation. Here is what my key schedule looks like:</p>
<div class="highlight"><pre><span></span><code><span class="c1">// aes key schedule</span>
    <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">S_box</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x7C</span><span class="p">,</span> <span class="mh">0x77</span><span class="p">,</span> <span class="mh">0x7B</span><span class="p">,</span> <span class="mh">0xF2</span><span class="p">,</span> <span class="mh">0x6B</span><span class="p">,</span> <span class="mh">0x6F</span><span class="p">,</span> <span class="mh">0xC5</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">,</span> <span class="mh">0x2B</span><span class="p">,</span> <span class="mh">0xFE</span><span class="p">,</span> <span class="mh">0xD7</span><span class="p">,</span> <span class="mh">0xAB</span><span class="p">,</span> <span class="mh">0x76</span><span class="p">,</span> <span class="mh">0xCA</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">,</span> <span class="mh">0xC9</span><span class="p">,</span> <span class="mh">0x7D</span><span class="p">,</span> <span class="mh">0xFA</span><span class="p">,</span> <span class="mh">0x59</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">,</span> <span class="mh">0xF0</span><span class="p">,</span> <span class="mh">0xAD</span><span class="p">,</span> <span class="mh">0xD4</span><span class="p">,</span> <span class="mh">0xA2</span><span class="p">,</span> <span class="mh">0xAF</span><span class="p">,</span> <span class="mh">0x9C</span><span class="p">,</span> <span class="mh">0xA4</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0xC0</span><span class="p">,</span> <span class="mh">0xB7</span><span class="p">,</span> <span class="mh">0xFD</span><span class="p">,</span> <span class="mh">0x93</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x3F</span><span class="p">,</span> <span class="mh">0xF7</span><span class="p">,</span> <span class="mh">0xCC</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="mh">0xA5</span><span class="p">,</span> <span class="mh">0xE5</span><span class="p">,</span> <span class="mh">0xF1</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">,</span> <span class="mh">0xD8</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0xC7</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0xC3</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x96</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x9A</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0xE2</span><span class="p">,</span> <span class="mh">0xEB</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0xB2</span><span class="p">,</span> <span class="mh">0x75</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0x2C</span><span class="p">,</span> <span class="mh">0x1A</span><span class="p">,</span> <span class="mh">0x1B</span><span class="p">,</span> <span class="mh">0x6E</span><span class="p">,</span> <span class="mh">0x5A</span><span class="p">,</span> <span class="mh">0xA0</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0x3B</span><span class="p">,</span> <span class="mh">0xD6</span><span class="p">,</span> <span class="mh">0xB3</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0xE3</span><span class="p">,</span> <span class="mh">0x2F</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span> <span class="mh">0xD1</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xED</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0xFC</span><span class="p">,</span> <span class="mh">0xB1</span><span class="p">,</span> <span class="mh">0x5B</span><span class="p">,</span> <span class="mh">0x6A</span><span class="p">,</span> <span class="mh">0xCB</span><span class="p">,</span> <span class="mh">0xBE</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0x4A</span><span class="p">,</span> <span class="mh">0x4C</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0xCF</span><span class="p">,</span> <span class="mh">0xD0</span><span class="p">,</span> <span class="mh">0xEF</span><span class="p">,</span> <span class="mh">0xAA</span><span class="p">,</span> <span class="mh">0xFB</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x4D</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">,</span> <span class="mh">0xF9</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x7F</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x3C</span><span class="p">,</span> <span class="mh">0x9F</span><span class="p">,</span> <span class="mh">0xA8</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">,</span> <span class="mh">0xA3</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x8F</span><span class="p">,</span> <span class="mh">0x92</span><span class="p">,</span> <span class="mh">0x9D</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0xF5</span><span class="p">,</span> <span class="mh">0xBC</span><span class="p">,</span> <span class="mh">0xB6</span><span class="p">,</span> <span class="mh">0xDA</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xF3</span><span class="p">,</span> <span class="mh">0xD2</span><span class="p">,</span> <span class="mh">0xCD</span><span class="p">,</span> <span class="mh">0x0C</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0xEC</span><span class="p">,</span> <span class="mh">0x5F</span><span class="p">,</span> <span class="mh">0x97</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0xC4</span><span class="p">,</span> <span class="mh">0xA7</span><span class="p">,</span> <span class="mh">0x7E</span><span class="p">,</span> <span class="mh">0x3D</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0x5D</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0x4F</span><span class="p">,</span> <span class="mh">0xDC</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x2A</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0xEE</span><span class="p">,</span> <span class="mh">0xB8</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0xDE</span><span class="p">,</span> <span class="mh">0x5E</span><span class="p">,</span> <span class="mh">0x0B</span><span class="p">,</span> <span class="mh">0xDB</span><span class="p">,</span> <span class="mh">0xE0</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x3A</span><span class="p">,</span> <span class="mh">0x0A</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x5C</span><span class="p">,</span> <span class="mh">0xC2</span><span class="p">,</span> <span class="mh">0xD3</span><span class="p">,</span> <span class="mh">0xAC</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x91</span><span class="p">,</span> <span class="mh">0x95</span><span class="p">,</span> <span class="mh">0xE4</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0xE7</span><span class="p">,</span> <span class="mh">0xC8</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">,</span> <span class="mh">0x6D</span><span class="p">,</span> <span class="mh">0x8D</span><span class="p">,</span> <span class="mh">0xD5</span><span class="p">,</span> <span class="mh">0x4E</span><span class="p">,</span> <span class="mh">0xA9</span><span class="p">,</span> <span class="mh">0x6C</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0xF4</span><span class="p">,</span> <span class="mh">0xEA</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0x7A</span><span class="p">,</span> <span class="mh">0xAE</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0xBA</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x2E</span><span class="p">,</span> <span class="mh">0x1C</span><span class="p">,</span> <span class="mh">0xA6</span><span class="p">,</span> <span class="mh">0xB4</span><span class="p">,</span> <span class="mh">0xC6</span><span class="p">,</span> <span class="mh">0xE8</span><span class="p">,</span> <span class="mh">0xDD</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">,</span> <span class="mh">0x1F</span><span class="p">,</span> <span class="mh">0x4B</span><span class="p">,</span> <span class="mh">0xBD</span><span class="p">,</span> <span class="mh">0x8B</span><span class="p">,</span> <span class="mh">0x8A</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0x3E</span><span class="p">,</span> <span class="mh">0xB5</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0xF6</span><span class="p">,</span> <span class="mh">0x0E</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span> <span class="mh">0xB9</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0xC1</span><span class="p">,</span> <span class="mh">0x1D</span><span class="p">,</span> <span class="mh">0x9E</span><span class="p">,</span> <span class="mh">0xE1</span><span class="p">,</span> <span class="mh">0xF8</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="mh">0xD9</span><span class="p">,</span> <span class="mh">0x8E</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">,</span> <span class="mh">0x9B</span><span class="p">,</span> <span class="mh">0x1E</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span> <span class="mh">0xE9</span><span class="p">,</span> <span class="mh">0xCE</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span> <span class="mh">0xDF</span><span class="p">,</span> <span class="mh">0x8C</span><span class="p">,</span> <span class="mh">0xA1</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">,</span> <span class="mh">0x0D</span><span class="p">,</span> <span class="mh">0xBF</span><span class="p">,</span> <span class="mh">0xE6</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x99</span><span class="p">,</span> <span class="mh">0x2D</span><span class="p">,</span> <span class="mh">0x0F</span><span class="p">,</span> <span class="mh">0xB0</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="mh">0xBB</span><span class="p">,</span> <span class="mh">0x16</span> <span class="p">};</span>
    <span class="cp">#define DW(x) (*(unsigned int*)(x))</span>
    <span class="p">{</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">d</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">round_keys</span><span class="p">[</span><span class="mi">11</span><span class="p">][</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
        <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">rcon</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x1B</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x6C</span><span class="p">,</span> <span class="mh">0xD8</span><span class="p">,</span> <span class="mh">0xAB</span><span class="p">,</span> <span class="mh">0x4D</span><span class="p">,</span> <span class="mh">0x9A</span><span class="p">,</span> <span class="mh">0x2F</span><span class="p">,</span> <span class="mh">0x5E</span><span class="p">,</span> <span class="mh">0xBC</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0xC6</span><span class="p">,</span> <span class="mh">0x97</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x6A</span><span class="p">,</span> <span class="mh">0xD4</span><span class="p">,</span> <span class="mh">0xB3</span><span class="p">,</span> <span class="mh">0x7D</span><span class="p">,</span> <span class="mh">0xFA</span><span class="p">,</span> <span class="mh">0xEF</span><span class="p">,</span> <span class="mh">0xC5</span><span class="p">,</span> <span class="mh">0x91</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0xE4</span><span class="p">,</span> <span class="mh">0xD3</span><span class="p">,</span> <span class="mh">0xBD</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0xC2</span><span class="p">,</span> <span class="mh">0x9F</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x4A</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0xCC</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0x1D</span><span class="p">,</span> <span class="mh">0x3A</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">,</span> <span class="mh">0xE8</span><span class="p">,</span> <span class="mh">0xCB</span><span class="p">,</span> <span class="mh">0x8D</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x1B</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x6C</span><span class="p">,</span> <span class="mh">0xD8</span><span class="p">,</span> <span class="mh">0xAB</span><span class="p">,</span> <span class="mh">0x4D</span><span class="p">,</span> <span class="mh">0x9A</span><span class="p">,</span> <span class="mh">0x2F</span><span class="p">,</span> <span class="mh">0x5E</span><span class="p">,</span> <span class="mh">0xBC</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0xC6</span><span class="p">,</span> <span class="mh">0x97</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x6A</span><span class="p">,</span> <span class="mh">0xD4</span><span class="p">,</span> <span class="mh">0xB3</span><span class="p">,</span> <span class="mh">0x7D</span><span class="p">,</span> <span class="mh">0xFA</span><span class="p">,</span> <span class="mh">0xEF</span><span class="p">,</span> <span class="mh">0xC5</span><span class="p">,</span> <span class="mh">0x91</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0xE4</span><span class="p">,</span> <span class="mh">0xD3</span><span class="p">,</span> <span class="mh">0xBD</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0xC2</span><span class="p">,</span> <span class="mh">0x9F</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x4A</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0xCC</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0x1D</span><span class="p">,</span> <span class="mh">0x3A</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">,</span> <span class="mh">0xE8</span><span class="p">,</span> <span class="mh">0xCB</span><span class="p">,</span> <span class="mh">0x8D</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x1B</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x6C</span><span class="p">,</span> <span class="mh">0xD8</span><span class="p">,</span> <span class="mh">0xAB</span><span class="p">,</span> <span class="mh">0x4D</span><span class="p">,</span> <span class="mh">0x9A</span><span class="p">,</span> <span class="mh">0x2F</span><span class="p">,</span> <span class="mh">0x5E</span><span class="p">,</span> <span class="mh">0xBC</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0xC6</span><span class="p">,</span> <span class="mh">0x97</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x6A</span><span class="p">,</span> <span class="mh">0xD4</span><span class="p">,</span> <span class="mh">0xB3</span><span class="p">,</span> <span class="mh">0x7D</span><span class="p">,</span> <span class="mh">0xFA</span><span class="p">,</span> <span class="mh">0xEF</span><span class="p">,</span> <span class="mh">0xC5</span><span class="p">,</span> <span class="mh">0x91</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0xE4</span><span class="p">,</span> <span class="mh">0xD3</span><span class="p">,</span> <span class="mh">0xBD</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0xC2</span><span class="p">,</span> <span class="mh">0x9F</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x4A</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0xCC</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0x1D</span><span class="p">,</span> <span class="mh">0x3A</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">,</span> <span class="mh">0xE8</span><span class="p">,</span> <span class="mh">0xCB</span><span class="p">,</span> <span class="mh">0x8D</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x1B</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x6C</span><span class="p">,</span> <span class="mh">0xD8</span><span class="p">,</span> <span class="mh">0xAB</span><span class="p">,</span> <span class="mh">0x4D</span><span class="p">,</span> <span class="mh">0x9A</span><span class="p">,</span> <span class="mh">0x2F</span><span class="p">,</span> <span class="mh">0x5E</span><span class="p">,</span> <span class="mh">0xBC</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0xC6</span><span class="p">,</span> <span class="mh">0x97</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x6A</span><span class="p">,</span> <span class="mh">0xD4</span><span class="p">,</span> <span class="mh">0xB3</span><span class="p">,</span> <span class="mh">0x7D</span><span class="p">,</span> <span class="mh">0xFA</span><span class="p">,</span> <span class="mh">0xEF</span><span class="p">,</span> <span class="mh">0xC5</span><span class="p">,</span> <span class="mh">0x91</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0xE4</span><span class="p">,</span> <span class="mh">0xD3</span><span class="p">,</span> <span class="mh">0xBD</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0xC2</span><span class="p">,</span> <span class="mh">0x9F</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x4A</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0xCC</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0x1D</span><span class="p">,</span> <span class="mh">0x3A</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">,</span> <span class="mh">0xE8</span><span class="p">,</span> <span class="mh">0xCB</span><span class="p">,</span> <span class="mh">0x8D</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x1B</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x6C</span><span class="p">,</span> <span class="mh">0xD8</span><span class="p">,</span> <span class="mh">0xAB</span><span class="p">,</span> <span class="mh">0x4D</span><span class="p">,</span> <span class="mh">0x9A</span><span class="p">,</span> <span class="mh">0x2F</span><span class="p">,</span> <span class="mh">0x5E</span><span class="p">,</span> <span class="mh">0xBC</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0xC6</span><span class="p">,</span> <span class="mh">0x97</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x6A</span><span class="p">,</span> <span class="mh">0xD4</span><span class="p">,</span> <span class="mh">0xB3</span><span class="p">,</span> <span class="mh">0x7D</span><span class="p">,</span> <span class="mh">0xFA</span><span class="p">,</span> <span class="mh">0xEF</span><span class="p">,</span> <span class="mh">0xC5</span><span class="p">,</span> <span class="mh">0x91</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0xE4</span><span class="p">,</span> <span class="mh">0xD3</span><span class="p">,</span> <span class="mh">0xBD</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0xC2</span><span class="p">,</span> <span class="mh">0x9F</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x4A</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0xCC</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0x1D</span><span class="p">,</span> <span class="mh">0x3A</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">,</span> <span class="mh">0xE8</span><span class="p">,</span> <span class="mh">0xCB</span><span class="p">,</span> <span class="mh">0x8D</span> <span class="p">};</span>

        <span class="c1">/// Key schedule -- Generate one subkey for each round</span>
        <span class="c1">/// http://www.formaestudio.com/rijndaelinspector/archivos/Rijndael_Animation_v4_eng.swf</span>

        <span class="c1">// First round-key is the actual key</span>
        <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">round_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">key</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">DW</span><span class="p">(</span><span class="o">&amp;</span><span class="n">round_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">12</span><span class="p">]);</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">11</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// Rotate `d` 8 bits to the right</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">ROT</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

            <span class="c1">// Takes every bytes of `d` &amp; substitute them using `S_box`</span>
            <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a3</span><span class="p">,</span> <span class="n">a4</span><span class="p">;</span>
            <span class="c1">// Do not forget to xor this byte with `rcon[i]`</span>
            <span class="n">a1</span> <span class="o">=</span> <span class="n">S_box</span><span class="p">[(</span><span class="n">d</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">]</span> <span class="o">^</span> <span class="n">rcon</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="c1">// a1 is the LSB</span>
            <span class="n">a2</span> <span class="o">=</span> <span class="n">S_box</span><span class="p">[(</span><span class="n">d</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">];</span>
            <span class="n">a3</span> <span class="o">=</span> <span class="n">S_box</span><span class="p">[(</span><span class="n">d</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">];</span>
            <span class="n">a4</span> <span class="o">=</span> <span class="n">S_box</span><span class="p">[(</span><span class="n">d</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">];</span>

            <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="n">a1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">a2</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">a3</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">a4</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>

            <span class="c1">// Now we can generate the current roundkey using the previous one</span>
            <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">d</span> <span class="o">^=</span> <span class="n">DW</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">round_keys</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="n">j</span> <span class="o">*</span> <span class="mi">4</span><span class="p">]));</span>
                <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">round_keys</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span> <span class="o">*</span> <span class="mi">4</span><span class="p">]))</span> <span class="o">=</span> <span class="n">d</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div>

<p>Sweet, feel free to dump the round keys and to compare them with an official test vector to convince you that this thing works. Once we have that function, we need to build the different primitives that the core encryption algorithm will use &amp; reuse to generate the encrypted block. Some of them are like 1 line of C, really simple ; some others are a bit more twisted, but whatever.</p>
<h2 id="encryption-process">Encryption process</h2>
<h3 id="transformations">Transformations</h3>
<h4 id="addroundkey">AddRoundKey</h4>
<p>This one is a really simple one: it takes a round key (according to which round you are currently in), the state &amp; you xor every single byte of the state with the round-key.</p>
<div class="highlight"><pre><span></span><code>    <span class="kt">void</span> <span class="nf">AddRoundKey</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">roundkey</span><span class="p">[</span><span class="mi">16</span><span class="p">],</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">out</span><span class="p">[</span><span class="mi">16</span><span class="p">])</span>
    <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
            <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^=</span> <span class="n">roundkey</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="p">}</span>
</code></pre></div>

<h4 id="subbytes">SubBytes</h4>
<p>Another simple one: it takes the state as input &amp; will substitute every byte using the forward substitution box <code>S_box</code>.</p>
<div class="highlight"><pre><span></span><code>    <span class="kt">void</span> <span class="nf">SubBytes</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">out</span><span class="p">[</span><span class="mi">16</span><span class="p">])</span>
    <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
            <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">S_box</span><span class="p">[</span><span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]];</span>
    <span class="p">}</span>
</code></pre></div>

<p>If you are interested in how the values of the <code>S_box</code> are computed, you should read the following blogpost <a href="http://kutioo.blogspot.fr/2013/11/aes-sbox-and-parigp.html">AES SBox and ParisGP</a> written by my mate <a href="https://twitter.com/kutioo">@kutioo</a>.</p>
<h4 id="shiftrows">ShiftRows</h4>
<p>This operation is a bit less tricky, but still is fairly straightforward. Imagine that the state is a 4x4 matrix, you just have to left rotate the second line by 1 byte, the third one by 2 bytes &amp; finally the last one by 3 bytes. This can be done in C like this:</p>
<div class="highlight"><pre><span></span><code>    <span class="kr">__forceinline</span> <span class="kt">void</span> <span class="nf">ShiftRows</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">out</span><span class="p">[</span><span class="mi">16</span><span class="p">])</span>
    <span class="p">{</span>
        <span class="c1">// +----+----+----+----+</span>
        <span class="c1">// | 00 | 04 | 08 | 12 |</span>
        <span class="c1">// +----+----+----+----+</span>
        <span class="c1">// | 01 | 05 | 09 | 13 |</span>
        <span class="c1">// +----+----+----+----+</span>
        <span class="c1">// | 02 | 06 | 10 | 14 |</span>
        <span class="c1">// +----+----+----+----+</span>
        <span class="c1">// | 03 | 07 | 11 | 15 |</span>
        <span class="c1">// +----+----+----+----+</span>
        <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">tmp1</span><span class="p">,</span> <span class="n">tmp2</span><span class="p">;</span>

        <span class="n">tmp1</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
        <span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
        <span class="n">out</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="mi">9</span><span class="p">];</span>
        <span class="n">out</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="mi">13</span><span class="p">];</span>
        <span class="n">out</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp1</span><span class="p">;</span>

        <span class="n">tmp1</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
        <span class="n">tmp2</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
        <span class="n">out</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
        <span class="n">out</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="mi">14</span><span class="p">];</span>
        <span class="n">out</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp1</span><span class="p">;</span>
        <span class="n">out</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp2</span><span class="p">;</span>

        <span class="n">tmp1</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
        <span class="n">out</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="mi">15</span><span class="p">];</span>
        <span class="n">out</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="mi">11</span><span class="p">];</span>
        <span class="n">out</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
        <span class="n">out</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp1</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div>

<h4 id="mixcolumns">MixColumns</h4>
<p>I guess this one is the less trivial one to implement &amp; understand. But basically it is a "matrix multiplication" (in GF(2^8) though hence the double-quotes) between 4 bytes of the state (row matrix) against a fixed 4x4 matrix. That gives you 4 new state bytes, so you do that for every double-words of your state.</p>
<p>Now, I kind of cheated for my implementation: instead of implementing the "weird" multiplication, I figured I could use a pre-computed table instead to avoid all the hassle. Because the fixed matrix has only 3 different values (1, 2 &amp; 3) the final table has a really small memory footprint: 3*0x100 bytes basically (if I'm being honest I even stole this table from <a href="https://twitter.com/elvanderb">@elvanderb</a>'s <a href="http://pastebin.com/MvXpGZts">crazy white-box generator</a>).</p>
<div class="highlight"><pre><span></span><code><span class="err">    const unsigned char gmul[3][0x100] = {</span>
<span class="err">        { 0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09, 0x0A, 0x0B, 0x0C, 0x0D, 0x0E, 0x0F, 0x10, 0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17, 0x18, 0x19, 0x1A, 0x1B, 0x1C, 0x1D, 0x1E, 0x1F, 0x20, 0x21, 0x22, 0x23, 0x24, 0x25, 0x26, 0x27, 0x28, 0x29, 0x2A, 0x2B, 0x2C, 0x2D, 0x2E, 0x2F, 0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x3A, 0x3B, 0x3C, 0x3D, 0x3E, 0x3F, 0x40, 0x41, 0x42, 0x43, 0x44, 0x45, 0x46, 0x47, 0x48, 0x49, 0x4A, 0x4B, 0x4C, 0x4D, 0x4E, 0x4F, 0x50, 0x51, 0x52, 0x53, 0x54, 0x55, 0x56, 0x57, 0x58, 0x59, 0x5A, 0x5B, 0x5C, 0x5D, 0x5E, 0x5F, 0x60, 0x61, 0x62, 0x63, 0x64, 0x65, 0x66, 0x67, 0x68, 0x69, 0x6A, 0x6B, 0x6C, 0x6D, 0x6E, 0x6F, 0x70, 0x71, 0x72, 0x73, 0x74, 0x75, 0x76, 0x77, 0x78, 0x79, 0x7A, 0x7B, 0x7C, 0x7D, 0x7E, 0x7F, 0x80, 0x81, 0x82, 0x83, 0x84, 0x85, 0x86, 0x87, 0x88, 0x89, 0x8A, 0x8B, 0x8C, 0x8D, 0x8E, 0x8F, 0x90, 0x91, 0x92, 0x93, 0x94, 0x95, 0x96, 0x97, 0x98, 0x99, 0x9A, 0x9B, 0x9C, 0x9D, 0x9E, 0x9F, 0xA0, 0xA1, 0xA2, 0xA3, 0xA4, 0xA5, 0xA6, 0xA7, 0xA8, 0xA9, 0xAA, 0xAB, 0xAC, 0xAD, 0xAE, 0xAF, 0xB0, 0xB1, 0xB2, 0xB3, 0xB4, 0xB5, 0xB6, 0xB7, 0xB8, 0xB9, 0xBA, 0xBB, 0xBC, 0xBD, 0xBE, 0xBF, 0xC0, 0xC1, 0xC2, 0xC3, 0xC4, 0xC5, 0xC6, 0xC7, 0xC8, 0xC9, 0xCA, 0xCB, 0xCC, 0xCD, 0xCE, 0xCF, 0xD0, 0xD1, 0xD2, 0xD3, 0xD4, 0xD5, 0xD6, 0xD7, 0xD8, 0xD9, 0xDA, 0xDB, 0xDC, 0xDD, 0xDE, 0xDF, 0xE0, 0xE1, 0xE2, 0xE3, 0xE4, 0xE5, 0xE6, 0xE7, 0xE8, 0xE9, 0xEA, 0xEB, 0xEC, 0xED, 0xEE, 0xEF, 0xF0, 0xF1, 0xF2, 0xF3, 0xF4, 0xF5, 0xF6, 0xF7, 0xF8, 0xF9, 0xFA, 0xFB, 0xFC, 0xFD, 0xFE, 0xFF },</span>
<span class="err">        { 0x00, 0x02, 0x04, 0x06, 0x08, 0x0A, 0x0C, 0x0E, 0x10, 0x12, 0x14, 0x16, 0x18, 0x1A, 0x1C, 0x1E, 0x20, 0x22, 0x24, 0x26, 0x28, 0x2A, 0x2C, 0x2E, 0x30, 0x32, 0x34, 0x36, 0x38, 0x3A, 0x3C, 0x3E, 0x40, 0x42, 0x44, 0x46, 0x48, 0x4A, 0x4C, 0x4E, 0x50, 0x52, 0x54, 0x56, 0x58, 0x5A, 0x5C, 0x5E, 0x60, 0x62, 0x64, 0x66, 0x68, 0x6A, 0x6C, 0x6E, 0x70, 0x72, 0x74, 0x76, 0x78, 0x7A, 0x7C, 0x7E, 0x80, 0x82, 0x84, 0x86, 0x88, 0x8A, 0x8C, 0x8E, 0x90, 0x92, 0x94, 0x96, 0x98, 0x9A, 0x9C, 0x9E, 0xA0, 0xA2, 0xA4, 0xA6, 0xA8, 0xAA, 0xAC, 0xAE, 0xB0, 0xB2, 0xB4, 0xB6, 0xB8, 0xBA, 0xBC, 0xBE, 0xC0, 0xC2, 0xC4, 0xC6, 0xC8, 0xCA, 0xCC, 0xCE, 0xD0, 0xD2, 0xD4, 0xD6, 0xD8, 0xDA, 0xDC, 0xDE, 0xE0, 0xE2, 0xE4, 0xE6, 0xE8, 0xEA, 0xEC, 0xEE, 0xF0, 0xF2, 0xF4, 0xF6, 0xF8, 0xFA, 0xFC, 0xFE, 0x1B, 0x19, 0x1F, 0x1D, 0x13, 0x11, 0x17, 0x15, 0x0B, 0x09, 0x0F, 0x0D, 0x03, 0x01, 0x07, 0x05, 0x3B, 0x39, 0x3F, 0x3D, 0x33, 0x31, 0x37, 0x35, 0x2B, 0x29, 0x2F, 0x2D, 0x23, 0x21, 0x27, 0x25, 0x5B, 0x59, 0x5F, 0x5D, 0x53, 0x51, 0x57, 0x55, 0x4B, 0x49, 0x4F, 0x4D, 0x43, 0x41, 0x47, 0x45, 0x7B, 0x79, 0x7F, 0x7D, 0x73, 0x71, 0x77, 0x75, 0x6B, 0x69, 0x6F, 0x6D, 0x63, 0x61, 0x67, 0x65, 0x9B, 0x99, 0x9F, 0x9D, 0x93, 0x91, 0x97, 0x95, 0x8B, 0x89, 0x8F, 0x8D, 0x83, 0x81, 0x87, 0x85, 0xBB, 0xB9, 0xBF, 0xBD, 0xB3, 0xB1, 0xB7, 0xB5, 0xAB, 0xA9, 0xAF, 0xAD, 0xA3, 0xA1, 0xA7, 0xA5, 0xDB, 0xD9, 0xDF, 0xDD, 0xD3, 0xD1, 0xD7, 0xD5, 0xCB, 0xC9, 0xCF, 0xCD, 0xC3, 0xC1, 0xC7, 0xC5, 0xFB, 0xF9, 0xFF, 0xFD, 0xF3, 0xF1, 0xF7, 0xF5, 0xEB, 0xE9, 0xEF, 0xED, 0xE3, 0xE1, 0xE7, 0xE5 },</span>
<span class="err">        { 0x00, 0x03, 0x06, 0x05, 0x0C, 0x0F, 0x0A, 0x09, 0x18, 0x1B, 0x1E, 0x1D, 0x14, 0x17, 0x12, 0x11, 0x30, 0x33, 0x36, 0x35, 0x3C, 0x3F, 0x3A, 0x39, 0x28, 0x2B, 0x2E, 0x2D, 0x24, 0x27, 0x22, 0x21, 0x60, 0x63, 0x66, 0x65, 0x6C, 0x6F, 0x6A, 0x69, 0x78, 0x7B, 0x7E, 0x7D, 0x74, 0x77, 0x72, 0x71, 0x50, 0x53, 0x56, 0x55, 0x5C, 0x5F, 0x5A, 0x59, 0x48, 0x4B, 0x4E, 0x4D, 0x44, 0x47, 0x42, 0x41, 0xC0, 0xC3, 0xC6, 0xC5, 0xCC, 0xCF, 0xCA, 0xC9, 0xD8, 0xDB, 0xDE, 0xDD, 0xD4, 0xD7, 0xD2, 0xD1, 0xF0, 0xF3, 0xF6, 0xF5, 0xFC, 0xFF, 0xFA, 0xF9, 0xE8, 0xEB, 0xEE, 0xED, 0xE4, 0xE7, 0xE2, 0xE1, 0xA0, 0xA3, 0xA6, 0xA5, 0xAC, 0xAF, 0xAA, 0xA9, 0xB8, 0xBB, 0xBE, 0xBD, 0xB4, 0xB7, 0xB2, 0xB1, 0x90, 0x93, 0x96, 0x95, 0x9C, 0x9F, 0x9A, 0x99, 0x88, 0x8B, 0x8E, 0x8D, 0x84, 0x87, 0x82, 0x81, 0x9B, 0x98, 0x9D, 0x9E, 0x97, 0x94, 0x91, 0x92, 0x83, 0x80, 0x85, 0x86, 0x8F, 0x8C, 0x89, 0x8A, 0xAB, 0xA8, 0xAD, 0xAE, 0xA7, 0xA4, 0xA1, 0xA2, 0xB3, 0xB0, 0xB5, 0xB6, 0xBF, 0xBC, 0xB9, 0xBA, 0xFB, 0xF8, 0xFD, 0xFE, 0xF7, 0xF4, 0xF1, 0xF2, 0xE3, 0xE0, 0xE5, 0xE6, 0xEF, 0xEC, 0xE9, 0xEA, 0xCB, 0xC8, 0xCD, 0xCE, 0xC7, 0xC4, 0xC1, 0xC2, 0xD3, 0xD0, 0xD5, 0xD6, 0xDF, 0xDC, 0xD9, 0xDA, 0x5B, 0x58, 0x5D, 0x5E, 0x57, 0x54, 0x51, 0x52, 0x43, 0x40, 0x45, 0x46, 0x4F, 0x4C, 0x49, 0x4A, 0x6B, 0x68, 0x6D, 0x6E, 0x67, 0x64, 0x61, 0x62, 0x73, 0x70, 0x75, 0x76, 0x7F, 0x7C, 0x79, 0x7A, 0x3B, 0x38, 0x3D, 0x3E, 0x37, 0x34, 0x31, 0x32, 0x23, 0x20, 0x25, 0x26, 0x2F, 0x2C, 0x29, 0x2A, 0x0B, 0x08, 0x0D, 0x0E, 0x07, 0x04, 0x01, 0x02, 0x13, 0x10, 0x15, 0x16, 0x1F, 0x1C, 0x19, 0x1A }</span>
<span class="err">        };</span>
</code></pre></div>

<p>Once you have this magic table, the multiplication gets really easy. Let's take an example:</p>
<p><center><img alt="mixcolumn_example.png" src="/images/spotlight_on_an_unprotected_aes128_white-box_implementation/mixcolumn_example.png"></center>
As I said, the four bytes at the left are from your state &amp; the 4x4 matrix is the fixed one (filled only with 3 different values). To have the result of this multiplication you just have to execute this:</p>
<div class="highlight"><pre><span></span><code>    <span class="n">reduce</span><span class="p">(</span><span class="n">operator</span><span class="p">.</span><span class="n">xor</span><span class="p">,</span> <span class="p">[</span><span class="n">gmul</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mh">0xd4</span><span class="p">],</span> <span class="n">gmul</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mh">0xbf</span><span class="p">],</span> <span class="n">gmul</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mh">0x5d</span><span class="p">],</span> <span class="n">gmul</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mh">0x30</span><span class="p">]])</span>
</code></pre></div>

<p>The first indexes in the table are the actual values taken from the 4x4 matrix minus one (because our array is going to be addressed from index 0). So then you can declare your own 4x4 matrix with proper indexes &amp; do the multiplication four times:</p>
<div class="highlight"><pre><span></span><code>    <span class="kt">void</span> <span class="nf">MixColumns</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">out</span><span class="p">[</span><span class="mi">16</span><span class="p">])</span>
    <span class="p">{</span>
        <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">matrix</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
            <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span>
        <span class="p">},</span>

        <span class="c1">/// In[19]: reduce(operator.xor, [gmul[1][0xd4], gmul[2][0xbf], gmul[0][0x5d], gmul[0][0x30]])</span>
        <span class="c1">/// Out[19] : 4</span>
        <span class="c1">/// In [20]: reduce(operator.xor, [gmul[0][0xd4], gmul[1][0xbf], gmul[2][0x5d], gmul[0][0x30]])</span>
        <span class="c1">/// Out[20]: 102</span>

        <span class="n">gmul</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mh">0x100</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x0A</span><span class="p">,</span> <span class="mh">0x0B</span><span class="p">,</span> <span class="mh">0x0C</span><span class="p">,</span> <span class="mh">0x0D</span><span class="p">,</span> <span class="mh">0x0E</span><span class="p">,</span> <span class="mh">0x0F</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x1A</span><span class="p">,</span> <span class="mh">0x1B</span><span class="p">,</span> <span class="mh">0x1C</span><span class="p">,</span> <span class="mh">0x1D</span><span class="p">,</span> <span class="mh">0x1E</span><span class="p">,</span> <span class="mh">0x1F</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x2A</span><span class="p">,</span> <span class="mh">0x2B</span><span class="p">,</span> <span class="mh">0x2C</span><span class="p">,</span> <span class="mh">0x2D</span><span class="p">,</span> <span class="mh">0x2E</span><span class="p">,</span> <span class="mh">0x2F</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0x3A</span><span class="p">,</span> <span class="mh">0x3B</span><span class="p">,</span> <span class="mh">0x3C</span><span class="p">,</span> <span class="mh">0x3D</span><span class="p">,</span> <span class="mh">0x3E</span><span class="p">,</span> <span class="mh">0x3F</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x4A</span><span class="p">,</span> <span class="mh">0x4B</span><span class="p">,</span> <span class="mh">0x4C</span><span class="p">,</span> <span class="mh">0x4D</span><span class="p">,</span> <span class="mh">0x4E</span><span class="p">,</span> <span class="mh">0x4F</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0x59</span><span class="p">,</span> <span class="mh">0x5A</span><span class="p">,</span> <span class="mh">0x5B</span><span class="p">,</span> <span class="mh">0x5C</span><span class="p">,</span> <span class="mh">0x5D</span><span class="p">,</span> <span class="mh">0x5E</span><span class="p">,</span> <span class="mh">0x5F</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="mh">0x6A</span><span class="p">,</span> <span class="mh">0x6B</span><span class="p">,</span> <span class="mh">0x6C</span><span class="p">,</span> <span class="mh">0x6D</span><span class="p">,</span> <span class="mh">0x6E</span><span class="p">,</span> <span class="mh">0x6F</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">,</span> <span class="mh">0x75</span><span class="p">,</span> <span class="mh">0x76</span><span class="p">,</span> <span class="mh">0x77</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0x7A</span><span class="p">,</span> <span class="mh">0x7B</span><span class="p">,</span> <span class="mh">0x7C</span><span class="p">,</span> <span class="mh">0x7D</span><span class="p">,</span> <span class="mh">0x7E</span><span class="p">,</span> <span class="mh">0x7F</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">,</span> <span class="mh">0x8A</span><span class="p">,</span> <span class="mh">0x8B</span><span class="p">,</span> <span class="mh">0x8C</span><span class="p">,</span> <span class="mh">0x8D</span><span class="p">,</span> <span class="mh">0x8E</span><span class="p">,</span> <span class="mh">0x8F</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span> <span class="mh">0x91</span><span class="p">,</span> <span class="mh">0x92</span><span class="p">,</span> <span class="mh">0x93</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">,</span> <span class="mh">0x95</span><span class="p">,</span> <span class="mh">0x96</span><span class="p">,</span> <span class="mh">0x97</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">,</span> <span class="mh">0x99</span><span class="p">,</span> <span class="mh">0x9A</span><span class="p">,</span> <span class="mh">0x9B</span><span class="p">,</span> <span class="mh">0x9C</span><span class="p">,</span> <span class="mh">0x9D</span><span class="p">,</span> <span class="mh">0x9E</span><span class="p">,</span> <span class="mh">0x9F</span><span class="p">,</span> <span class="mh">0xA0</span><span class="p">,</span> <span class="mh">0xA1</span><span class="p">,</span> <span class="mh">0xA2</span><span class="p">,</span> <span class="mh">0xA3</span><span class="p">,</span> <span class="mh">0xA4</span><span class="p">,</span> <span class="mh">0xA5</span><span class="p">,</span> <span class="mh">0xA6</span><span class="p">,</span> <span class="mh">0xA7</span><span class="p">,</span> <span class="mh">0xA8</span><span class="p">,</span> <span class="mh">0xA9</span><span class="p">,</span> <span class="mh">0xAA</span><span class="p">,</span> <span class="mh">0xAB</span><span class="p">,</span> <span class="mh">0xAC</span><span class="p">,</span> <span class="mh">0xAD</span><span class="p">,</span> <span class="mh">0xAE</span><span class="p">,</span> <span class="mh">0xAF</span><span class="p">,</span> <span class="mh">0xB0</span><span class="p">,</span> <span class="mh">0xB1</span><span class="p">,</span> <span class="mh">0xB2</span><span class="p">,</span> <span class="mh">0xB3</span><span class="p">,</span> <span class="mh">0xB4</span><span class="p">,</span> <span class="mh">0xB5</span><span class="p">,</span> <span class="mh">0xB6</span><span class="p">,</span> <span class="mh">0xB7</span><span class="p">,</span> <span class="mh">0xB8</span><span class="p">,</span> <span class="mh">0xB9</span><span class="p">,</span> <span class="mh">0xBA</span><span class="p">,</span> <span class="mh">0xBB</span><span class="p">,</span> <span class="mh">0xBC</span><span class="p">,</span> <span class="mh">0xBD</span><span class="p">,</span> <span class="mh">0xBE</span><span class="p">,</span> <span class="mh">0xBF</span><span class="p">,</span> <span class="mh">0xC0</span><span class="p">,</span> <span class="mh">0xC1</span><span class="p">,</span> <span class="mh">0xC2</span><span class="p">,</span> <span class="mh">0xC3</span><span class="p">,</span> <span class="mh">0xC4</span><span class="p">,</span> <span class="mh">0xC5</span><span class="p">,</span> <span class="mh">0xC6</span><span class="p">,</span> <span class="mh">0xC7</span><span class="p">,</span> <span class="mh">0xC8</span><span class="p">,</span> <span class="mh">0xC9</span><span class="p">,</span> <span class="mh">0xCA</span><span class="p">,</span> <span class="mh">0xCB</span><span class="p">,</span> <span class="mh">0xCC</span><span class="p">,</span> <span class="mh">0xCD</span><span class="p">,</span> <span class="mh">0xCE</span><span class="p">,</span> <span class="mh">0xCF</span><span class="p">,</span> <span class="mh">0xD0</span><span class="p">,</span> <span class="mh">0xD1</span><span class="p">,</span> <span class="mh">0xD2</span><span class="p">,</span> <span class="mh">0xD3</span><span class="p">,</span> <span class="mh">0xD4</span><span class="p">,</span> <span class="mh">0xD5</span><span class="p">,</span> <span class="mh">0xD6</span><span class="p">,</span> <span class="mh">0xD7</span><span class="p">,</span> <span class="mh">0xD8</span><span class="p">,</span> <span class="mh">0xD9</span><span class="p">,</span> <span class="mh">0xDA</span><span class="p">,</span> <span class="mh">0xDB</span><span class="p">,</span> <span class="mh">0xDC</span><span class="p">,</span> <span class="mh">0xDD</span><span class="p">,</span> <span class="mh">0xDE</span><span class="p">,</span> <span class="mh">0xDF</span><span class="p">,</span> <span class="mh">0xE0</span><span class="p">,</span> <span class="mh">0xE1</span><span class="p">,</span> <span class="mh">0xE2</span><span class="p">,</span> <span class="mh">0xE3</span><span class="p">,</span> <span class="mh">0xE4</span><span class="p">,</span> <span class="mh">0xE5</span><span class="p">,</span> <span class="mh">0xE6</span><span class="p">,</span> <span class="mh">0xE7</span><span class="p">,</span> <span class="mh">0xE8</span><span class="p">,</span> <span class="mh">0xE9</span><span class="p">,</span> <span class="mh">0xEA</span><span class="p">,</span> <span class="mh">0xEB</span><span class="p">,</span> <span class="mh">0xEC</span><span class="p">,</span> <span class="mh">0xED</span><span class="p">,</span> <span class="mh">0xEE</span><span class="p">,</span> <span class="mh">0xEF</span><span class="p">,</span> <span class="mh">0xF0</span><span class="p">,</span> <span class="mh">0xF1</span><span class="p">,</span> <span class="mh">0xF2</span><span class="p">,</span> <span class="mh">0xF3</span><span class="p">,</span> <span class="mh">0xF4</span><span class="p">,</span> <span class="mh">0xF5</span><span class="p">,</span> <span class="mh">0xF6</span><span class="p">,</span> <span class="mh">0xF7</span><span class="p">,</span> <span class="mh">0xF8</span><span class="p">,</span> <span class="mh">0xF9</span><span class="p">,</span> <span class="mh">0xFA</span><span class="p">,</span> <span class="mh">0xFB</span><span class="p">,</span> <span class="mh">0xFC</span><span class="p">,</span> <span class="mh">0xFD</span><span class="p">,</span> <span class="mh">0xFE</span><span class="p">,</span> <span class="mh">0xFF</span> <span class="p">},</span>
            <span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x0A</span><span class="p">,</span> <span class="mh">0x0C</span><span class="p">,</span> <span class="mh">0x0E</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x1A</span><span class="p">,</span> <span class="mh">0x1C</span><span class="p">,</span> <span class="mh">0x1E</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span> <span class="mh">0x2A</span><span class="p">,</span> <span class="mh">0x2C</span><span class="p">,</span> <span class="mh">0x2E</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x3A</span><span class="p">,</span> <span class="mh">0x3C</span><span class="p">,</span> <span class="mh">0x3E</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x4A</span><span class="p">,</span> <span class="mh">0x4C</span><span class="p">,</span> <span class="mh">0x4E</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0x5A</span><span class="p">,</span> <span class="mh">0x5C</span><span class="p">,</span> <span class="mh">0x5E</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="mh">0x6A</span><span class="p">,</span> <span class="mh">0x6C</span><span class="p">,</span> <span class="mh">0x6E</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">,</span> <span class="mh">0x76</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="mh">0x7A</span><span class="p">,</span> <span class="mh">0x7C</span><span class="p">,</span> <span class="mh">0x7E</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">,</span> <span class="mh">0x8A</span><span class="p">,</span> <span class="mh">0x8C</span><span class="p">,</span> <span class="mh">0x8E</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span> <span class="mh">0x92</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">,</span> <span class="mh">0x96</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">,</span> <span class="mh">0x9A</span><span class="p">,</span> <span class="mh">0x9C</span><span class="p">,</span> <span class="mh">0x9E</span><span class="p">,</span> <span class="mh">0xA0</span><span class="p">,</span> <span class="mh">0xA2</span><span class="p">,</span> <span class="mh">0xA4</span><span class="p">,</span> <span class="mh">0xA6</span><span class="p">,</span> <span class="mh">0xA8</span><span class="p">,</span> <span class="mh">0xAA</span><span class="p">,</span> <span class="mh">0xAC</span><span class="p">,</span> <span class="mh">0xAE</span><span class="p">,</span> <span class="mh">0xB0</span><span class="p">,</span> <span class="mh">0xB2</span><span class="p">,</span> <span class="mh">0xB4</span><span class="p">,</span> <span class="mh">0xB6</span><span class="p">,</span> <span class="mh">0xB8</span><span class="p">,</span> <span class="mh">0xBA</span><span class="p">,</span> <span class="mh">0xBC</span><span class="p">,</span> <span class="mh">0xBE</span><span class="p">,</span> <span class="mh">0xC0</span><span class="p">,</span> <span class="mh">0xC2</span><span class="p">,</span> <span class="mh">0xC4</span><span class="p">,</span> <span class="mh">0xC6</span><span class="p">,</span> <span class="mh">0xC8</span><span class="p">,</span> <span class="mh">0xCA</span><span class="p">,</span> <span class="mh">0xCC</span><span class="p">,</span> <span class="mh">0xCE</span><span class="p">,</span> <span class="mh">0xD0</span><span class="p">,</span> <span class="mh">0xD2</span><span class="p">,</span> <span class="mh">0xD4</span><span class="p">,</span> <span class="mh">0xD6</span><span class="p">,</span> <span class="mh">0xD8</span><span class="p">,</span> <span class="mh">0xDA</span><span class="p">,</span> <span class="mh">0xDC</span><span class="p">,</span> <span class="mh">0xDE</span><span class="p">,</span> <span class="mh">0xE0</span><span class="p">,</span> <span class="mh">0xE2</span><span class="p">,</span> <span class="mh">0xE4</span><span class="p">,</span> <span class="mh">0xE6</span><span class="p">,</span> <span class="mh">0xE8</span><span class="p">,</span> <span class="mh">0xEA</span><span class="p">,</span> <span class="mh">0xEC</span><span class="p">,</span> <span class="mh">0xEE</span><span class="p">,</span> <span class="mh">0xF0</span><span class="p">,</span> <span class="mh">0xF2</span><span class="p">,</span> <span class="mh">0xF4</span><span class="p">,</span> <span class="mh">0xF6</span><span class="p">,</span> <span class="mh">0xF8</span><span class="p">,</span> <span class="mh">0xFA</span><span class="p">,</span> <span class="mh">0xFC</span><span class="p">,</span> <span class="mh">0xFE</span><span class="p">,</span> <span class="mh">0x1B</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x1F</span><span class="p">,</span> <span class="mh">0x1D</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x0B</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x0F</span><span class="p">,</span> <span class="mh">0x0D</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x3B</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0x3F</span><span class="p">,</span> <span class="mh">0x3D</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x2B</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x2F</span><span class="p">,</span> <span class="mh">0x2D</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x5B</span><span class="p">,</span> <span class="mh">0x59</span><span class="p">,</span> <span class="mh">0x5F</span><span class="p">,</span> <span class="mh">0x5D</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0x4B</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x4F</span><span class="p">,</span> <span class="mh">0x4D</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">,</span> <span class="mh">0x7B</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0x7F</span><span class="p">,</span> <span class="mh">0x7D</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">,</span> <span class="mh">0x77</span><span class="p">,</span> <span class="mh">0x75</span><span class="p">,</span> <span class="mh">0x6B</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="mh">0x6F</span><span class="p">,</span> <span class="mh">0x6D</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0x9B</span><span class="p">,</span> <span class="mh">0x99</span><span class="p">,</span> <span class="mh">0x9F</span><span class="p">,</span> <span class="mh">0x9D</span><span class="p">,</span> <span class="mh">0x93</span><span class="p">,</span> <span class="mh">0x91</span><span class="p">,</span> <span class="mh">0x97</span><span class="p">,</span> <span class="mh">0x95</span><span class="p">,</span> <span class="mh">0x8B</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">,</span> <span class="mh">0x8F</span><span class="p">,</span> <span class="mh">0x8D</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0xBB</span><span class="p">,</span> <span class="mh">0xB9</span><span class="p">,</span> <span class="mh">0xBF</span><span class="p">,</span> <span class="mh">0xBD</span><span class="p">,</span> <span class="mh">0xB3</span><span class="p">,</span> <span class="mh">0xB1</span><span class="p">,</span> <span class="mh">0xB7</span><span class="p">,</span> <span class="mh">0xB5</span><span class="p">,</span> <span class="mh">0xAB</span><span class="p">,</span> <span class="mh">0xA9</span><span class="p">,</span> <span class="mh">0xAF</span><span class="p">,</span> <span class="mh">0xAD</span><span class="p">,</span> <span class="mh">0xA3</span><span class="p">,</span> <span class="mh">0xA1</span><span class="p">,</span> <span class="mh">0xA7</span><span class="p">,</span> <span class="mh">0xA5</span><span class="p">,</span> <span class="mh">0xDB</span><span class="p">,</span> <span class="mh">0xD9</span><span class="p">,</span> <span class="mh">0xDF</span><span class="p">,</span> <span class="mh">0xDD</span><span class="p">,</span> <span class="mh">0xD3</span><span class="p">,</span> <span class="mh">0xD1</span><span class="p">,</span> <span class="mh">0xD7</span><span class="p">,</span> <span class="mh">0xD5</span><span class="p">,</span> <span class="mh">0xCB</span><span class="p">,</span> <span class="mh">0xC9</span><span class="p">,</span> <span class="mh">0xCF</span><span class="p">,</span> <span class="mh">0xCD</span><span class="p">,</span> <span class="mh">0xC3</span><span class="p">,</span> <span class="mh">0xC1</span><span class="p">,</span> <span class="mh">0xC7</span><span class="p">,</span> <span class="mh">0xC5</span><span class="p">,</span> <span class="mh">0xFB</span><span class="p">,</span> <span class="mh">0xF9</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xFD</span><span class="p">,</span> <span class="mh">0xF3</span><span class="p">,</span> <span class="mh">0xF1</span><span class="p">,</span> <span class="mh">0xF7</span><span class="p">,</span> <span class="mh">0xF5</span><span class="p">,</span> <span class="mh">0xEB</span><span class="p">,</span> <span class="mh">0xE9</span><span class="p">,</span> <span class="mh">0xEF</span><span class="p">,</span> <span class="mh">0xED</span><span class="p">,</span> <span class="mh">0xE3</span><span class="p">,</span> <span class="mh">0xE1</span><span class="p">,</span> <span class="mh">0xE7</span><span class="p">,</span> <span class="mh">0xE5</span> <span class="p">},</span>
            <span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x0C</span><span class="p">,</span> <span class="mh">0x0F</span><span class="p">,</span> <span class="mh">0x0A</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x1B</span><span class="p">,</span> <span class="mh">0x1E</span><span class="p">,</span> <span class="mh">0x1D</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x3C</span><span class="p">,</span> <span class="mh">0x3F</span><span class="p">,</span> <span class="mh">0x3A</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span> <span class="mh">0x2B</span><span class="p">,</span> <span class="mh">0x2E</span><span class="p">,</span> <span class="mh">0x2D</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0x6C</span><span class="p">,</span> <span class="mh">0x6F</span><span class="p">,</span> <span class="mh">0x6A</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="mh">0x7B</span><span class="p">,</span> <span class="mh">0x7E</span><span class="p">,</span> <span class="mh">0x7D</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">,</span> <span class="mh">0x77</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0x5C</span><span class="p">,</span> <span class="mh">0x5F</span><span class="p">,</span> <span class="mh">0x5A</span><span class="p">,</span> <span class="mh">0x59</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x4B</span><span class="p">,</span> <span class="mh">0x4E</span><span class="p">,</span> <span class="mh">0x4D</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0xC0</span><span class="p">,</span> <span class="mh">0xC3</span><span class="p">,</span> <span class="mh">0xC6</span><span class="p">,</span> <span class="mh">0xC5</span><span class="p">,</span> <span class="mh">0xCC</span><span class="p">,</span> <span class="mh">0xCF</span><span class="p">,</span> <span class="mh">0xCA</span><span class="p">,</span> <span class="mh">0xC9</span><span class="p">,</span> <span class="mh">0xD8</span><span class="p">,</span> <span class="mh">0xDB</span><span class="p">,</span> <span class="mh">0xDE</span><span class="p">,</span> <span class="mh">0xDD</span><span class="p">,</span> <span class="mh">0xD4</span><span class="p">,</span> <span class="mh">0xD7</span><span class="p">,</span> <span class="mh">0xD2</span><span class="p">,</span> <span class="mh">0xD1</span><span class="p">,</span> <span class="mh">0xF0</span><span class="p">,</span> <span class="mh">0xF3</span><span class="p">,</span> <span class="mh">0xF6</span><span class="p">,</span> <span class="mh">0xF5</span><span class="p">,</span> <span class="mh">0xFC</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xFA</span><span class="p">,</span> <span class="mh">0xF9</span><span class="p">,</span> <span class="mh">0xE8</span><span class="p">,</span> <span class="mh">0xEB</span><span class="p">,</span> <span class="mh">0xEE</span><span class="p">,</span> <span class="mh">0xED</span><span class="p">,</span> <span class="mh">0xE4</span><span class="p">,</span> <span class="mh">0xE7</span><span class="p">,</span> <span class="mh">0xE2</span><span class="p">,</span> <span class="mh">0xE1</span><span class="p">,</span> <span class="mh">0xA0</span><span class="p">,</span> <span class="mh">0xA3</span><span class="p">,</span> <span class="mh">0xA6</span><span class="p">,</span> <span class="mh">0xA5</span><span class="p">,</span> <span class="mh">0xAC</span><span class="p">,</span> <span class="mh">0xAF</span><span class="p">,</span> <span class="mh">0xAA</span><span class="p">,</span> <span class="mh">0xA9</span><span class="p">,</span> <span class="mh">0xB8</span><span class="p">,</span> <span class="mh">0xBB</span><span class="p">,</span> <span class="mh">0xBE</span><span class="p">,</span> <span class="mh">0xBD</span><span class="p">,</span> <span class="mh">0xB4</span><span class="p">,</span> <span class="mh">0xB7</span><span class="p">,</span> <span class="mh">0xB2</span><span class="p">,</span> <span class="mh">0xB1</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span> <span class="mh">0x93</span><span class="p">,</span> <span class="mh">0x96</span><span class="p">,</span> <span class="mh">0x95</span><span class="p">,</span> <span class="mh">0x9C</span><span class="p">,</span> <span class="mh">0x9F</span><span class="p">,</span> <span class="mh">0x9A</span><span class="p">,</span> <span class="mh">0x99</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">,</span> <span class="mh">0x8B</span><span class="p">,</span> <span class="mh">0x8E</span><span class="p">,</span> <span class="mh">0x8D</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0x9B</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">,</span> <span class="mh">0x9D</span><span class="p">,</span> <span class="mh">0x9E</span><span class="p">,</span> <span class="mh">0x97</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">,</span> <span class="mh">0x91</span><span class="p">,</span> <span class="mh">0x92</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x8F</span><span class="p">,</span> <span class="mh">0x8C</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">,</span> <span class="mh">0x8A</span><span class="p">,</span> <span class="mh">0xAB</span><span class="p">,</span> <span class="mh">0xA8</span><span class="p">,</span> <span class="mh">0xAD</span><span class="p">,</span> <span class="mh">0xAE</span><span class="p">,</span> <span class="mh">0xA7</span><span class="p">,</span> <span class="mh">0xA4</span><span class="p">,</span> <span class="mh">0xA1</span><span class="p">,</span> <span class="mh">0xA2</span><span class="p">,</span> <span class="mh">0xB3</span><span class="p">,</span> <span class="mh">0xB0</span><span class="p">,</span> <span class="mh">0xB5</span><span class="p">,</span> <span class="mh">0xB6</span><span class="p">,</span> <span class="mh">0xBF</span><span class="p">,</span> <span class="mh">0xBC</span><span class="p">,</span> <span class="mh">0xB9</span><span class="p">,</span> <span class="mh">0xBA</span><span class="p">,</span> <span class="mh">0xFB</span><span class="p">,</span> <span class="mh">0xF8</span><span class="p">,</span> <span class="mh">0xFD</span><span class="p">,</span> <span class="mh">0xFE</span><span class="p">,</span> <span class="mh">0xF7</span><span class="p">,</span> <span class="mh">0xF4</span><span class="p">,</span> <span class="mh">0xF1</span><span class="p">,</span> <span class="mh">0xF2</span><span class="p">,</span> <span class="mh">0xE3</span><span class="p">,</span> <span class="mh">0xE0</span><span class="p">,</span> <span class="mh">0xE5</span><span class="p">,</span> <span class="mh">0xE6</span><span class="p">,</span> <span class="mh">0xEF</span><span class="p">,</span> <span class="mh">0xEC</span><span class="p">,</span> <span class="mh">0xE9</span><span class="p">,</span> <span class="mh">0xEA</span><span class="p">,</span> <span class="mh">0xCB</span><span class="p">,</span> <span class="mh">0xC8</span><span class="p">,</span> <span class="mh">0xCD</span><span class="p">,</span> <span class="mh">0xCE</span><span class="p">,</span> <span class="mh">0xC7</span><span class="p">,</span> <span class="mh">0xC4</span><span class="p">,</span> <span class="mh">0xC1</span><span class="p">,</span> <span class="mh">0xC2</span><span class="p">,</span> <span class="mh">0xD3</span><span class="p">,</span> <span class="mh">0xD0</span><span class="p">,</span> <span class="mh">0xD5</span><span class="p">,</span> <span class="mh">0xD6</span><span class="p">,</span> <span class="mh">0xDF</span><span class="p">,</span> <span class="mh">0xDC</span><span class="p">,</span> <span class="mh">0xD9</span><span class="p">,</span> <span class="mh">0xDA</span><span class="p">,</span> <span class="mh">0x5B</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0x5D</span><span class="p">,</span> <span class="mh">0x5E</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0x4F</span><span class="p">,</span> <span class="mh">0x4C</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x4A</span><span class="p">,</span> <span class="mh">0x6B</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="mh">0x6D</span><span class="p">,</span> <span class="mh">0x6E</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0x75</span><span class="p">,</span> <span class="mh">0x76</span><span class="p">,</span> <span class="mh">0x7F</span><span class="p">,</span> <span class="mh">0x7C</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0x7A</span><span class="p">,</span> <span class="mh">0x3B</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x3D</span><span class="p">,</span> <span class="mh">0x3E</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">,</span> <span class="mh">0x2F</span><span class="p">,</span> <span class="mh">0x2C</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x2A</span><span class="p">,</span> <span class="mh">0x0B</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x0D</span><span class="p">,</span> <span class="mh">0x0E</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x1F</span><span class="p">,</span> <span class="mh">0x1C</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x1A</span> <span class="p">}</span>
        <span class="p">};</span>

        <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">a</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">0</span><span class="p">];</span>
            <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
            <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">2</span><span class="p">];</span>
            <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">d</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">3</span><span class="p">];</span>

            <span class="n">out</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">gmul</span><span class="p">[</span><span class="n">matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">a</span><span class="p">]</span> <span class="o">^</span> <span class="n">gmul</span><span class="p">[</span><span class="n">matrix</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="n">b</span><span class="p">]</span> <span class="o">^</span> <span class="n">gmul</span><span class="p">[</span><span class="n">matrix</span><span class="p">[</span><span class="mi">2</span><span class="p">]][</span><span class="n">c</span><span class="p">]</span> <span class="o">^</span> <span class="n">gmul</span><span class="p">[</span><span class="n">matrix</span><span class="p">[</span><span class="mi">3</span><span class="p">]][</span><span class="n">d</span><span class="p">];</span>
            <span class="n">out</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">gmul</span><span class="p">[</span><span class="n">matrix</span><span class="p">[</span><span class="mi">4</span><span class="p">]][</span><span class="n">a</span><span class="p">]</span> <span class="o">^</span> <span class="n">gmul</span><span class="p">[</span><span class="n">matrix</span><span class="p">[</span><span class="mi">5</span><span class="p">]][</span><span class="n">b</span><span class="p">]</span> <span class="o">^</span> <span class="n">gmul</span><span class="p">[</span><span class="n">matrix</span><span class="p">[</span><span class="mi">6</span><span class="p">]][</span><span class="n">c</span><span class="p">]</span> <span class="o">^</span> <span class="n">gmul</span><span class="p">[</span><span class="n">matrix</span><span class="p">[</span><span class="mi">7</span><span class="p">]][</span><span class="n">d</span><span class="p">];</span>
            <span class="n">out</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">gmul</span><span class="p">[</span><span class="n">matrix</span><span class="p">[</span><span class="mi">8</span><span class="p">]][</span><span class="n">a</span><span class="p">]</span> <span class="o">^</span> <span class="n">gmul</span><span class="p">[</span><span class="n">matrix</span><span class="p">[</span><span class="mi">9</span><span class="p">]][</span><span class="n">b</span><span class="p">]</span> <span class="o">^</span> <span class="n">gmul</span><span class="p">[</span><span class="n">matrix</span><span class="p">[</span><span class="mi">10</span><span class="p">]][</span><span class="n">c</span><span class="p">]</span> <span class="o">^</span> <span class="n">gmul</span><span class="p">[</span><span class="n">matrix</span><span class="p">[</span><span class="mi">11</span><span class="p">]][</span><span class="n">d</span><span class="p">];</span>
            <span class="n">out</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">gmul</span><span class="p">[</span><span class="n">matrix</span><span class="p">[</span><span class="mi">12</span><span class="p">]][</span><span class="n">a</span><span class="p">]</span> <span class="o">^</span> <span class="n">gmul</span><span class="p">[</span><span class="n">matrix</span><span class="p">[</span><span class="mi">13</span><span class="p">]][</span><span class="n">b</span><span class="p">]</span> <span class="o">^</span> <span class="n">gmul</span><span class="p">[</span><span class="n">matrix</span><span class="p">[</span><span class="mi">14</span><span class="p">]][</span><span class="n">c</span><span class="p">]</span> <span class="o">^</span> <span class="n">gmul</span><span class="p">[</span><span class="n">matrix</span><span class="p">[</span><span class="mi">15</span><span class="p">]][</span><span class="n">d</span><span class="p">];</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div>

<h3 id="combine-them-together">Combine them together</h3>
<p>Now we have everything we need, it is going to be easy peasy ; really:</p>
<ol>
<li>The initial state is populated with the encryption key</li>
<li>Generate the round-keys thanks to the key schedule ; remember 11 keys, the first one being the plain encryption key</li>
<li>The first different round is a simple <code>AddRoundKey</code> operation</li>
<li>Then we enter in the main loop which does 9 rounds:<ol>
<li><code>SubBytes</code></li>
<li><code>ShiftRows</code></li>
<li><code>MixColumns</code></li>
<li><code>AddRoundKey</code></li>
</ol>
</li>
<li>Last round which is also a bit different:<ol>
<li><code>SubBytes</code></li>
<li><code>ShiftRows</code></li>
<li><code>AddRoundKey</code></li>
</ol>
</li>
<li>The state is now your encrypted block, yay!</li>
</ol>
<p>Here we are, we finally have our AES128 encryption function that we will use as a reference:</p>
<div class="highlight"><pre><span></span><code>    <span class="kt">void</span> <span class="nf">aes128_enc_base</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">in</span><span class="p">[</span><span class="mi">16</span><span class="p">],</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">out</span><span class="p">[</span><span class="mi">16</span><span class="p">],</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">key</span><span class="p">[</span><span class="mi">16</span><span class="p">])</span>
    <span class="p">{</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">d</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">round_keys</span><span class="p">[</span><span class="mi">11</span><span class="p">][</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
        <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">rcon</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x1B</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x6C</span><span class="p">,</span> <span class="mh">0xD8</span><span class="p">,</span> <span class="mh">0xAB</span><span class="p">,</span> <span class="mh">0x4D</span><span class="p">,</span> <span class="mh">0x9A</span><span class="p">,</span> <span class="mh">0x2F</span><span class="p">,</span> <span class="mh">0x5E</span><span class="p">,</span> <span class="mh">0xBC</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0xC6</span><span class="p">,</span> <span class="mh">0x97</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x6A</span><span class="p">,</span> <span class="mh">0xD4</span><span class="p">,</span> <span class="mh">0xB3</span><span class="p">,</span> <span class="mh">0x7D</span><span class="p">,</span> <span class="mh">0xFA</span><span class="p">,</span> <span class="mh">0xEF</span><span class="p">,</span> <span class="mh">0xC5</span><span class="p">,</span> <span class="mh">0x91</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0xE4</span><span class="p">,</span> <span class="mh">0xD3</span><span class="p">,</span> <span class="mh">0xBD</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0xC2</span><span class="p">,</span> <span class="mh">0x9F</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x4A</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0xCC</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0x1D</span><span class="p">,</span> <span class="mh">0x3A</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">,</span> <span class="mh">0xE8</span><span class="p">,</span> <span class="mh">0xCB</span><span class="p">,</span> <span class="mh">0x8D</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x1B</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x6C</span><span class="p">,</span> <span class="mh">0xD8</span><span class="p">,</span> <span class="mh">0xAB</span><span class="p">,</span> <span class="mh">0x4D</span><span class="p">,</span> <span class="mh">0x9A</span><span class="p">,</span> <span class="mh">0x2F</span><span class="p">,</span> <span class="mh">0x5E</span><span class="p">,</span> <span class="mh">0xBC</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0xC6</span><span class="p">,</span> <span class="mh">0x97</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x6A</span><span class="p">,</span> <span class="mh">0xD4</span><span class="p">,</span> <span class="mh">0xB3</span><span class="p">,</span> <span class="mh">0x7D</span><span class="p">,</span> <span class="mh">0xFA</span><span class="p">,</span> <span class="mh">0xEF</span><span class="p">,</span> <span class="mh">0xC5</span><span class="p">,</span> <span class="mh">0x91</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0xE4</span><span class="p">,</span> <span class="mh">0xD3</span><span class="p">,</span> <span class="mh">0xBD</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0xC2</span><span class="p">,</span> <span class="mh">0x9F</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x4A</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0xCC</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0x1D</span><span class="p">,</span> <span class="mh">0x3A</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">,</span> <span class="mh">0xE8</span><span class="p">,</span> <span class="mh">0xCB</span><span class="p">,</span> <span class="mh">0x8D</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x1B</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x6C</span><span class="p">,</span> <span class="mh">0xD8</span><span class="p">,</span> <span class="mh">0xAB</span><span class="p">,</span> <span class="mh">0x4D</span><span class="p">,</span> <span class="mh">0x9A</span><span class="p">,</span> <span class="mh">0x2F</span><span class="p">,</span> <span class="mh">0x5E</span><span class="p">,</span> <span class="mh">0xBC</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0xC6</span><span class="p">,</span> <span class="mh">0x97</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x6A</span><span class="p">,</span> <span class="mh">0xD4</span><span class="p">,</span> <span class="mh">0xB3</span><span class="p">,</span> <span class="mh">0x7D</span><span class="p">,</span> <span class="mh">0xFA</span><span class="p">,</span> <span class="mh">0xEF</span><span class="p">,</span> <span class="mh">0xC5</span><span class="p">,</span> <span class="mh">0x91</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0xE4</span><span class="p">,</span> <span class="mh">0xD3</span><span class="p">,</span> <span class="mh">0xBD</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0xC2</span><span class="p">,</span> <span class="mh">0x9F</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x4A</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0xCC</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0x1D</span><span class="p">,</span> <span class="mh">0x3A</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">,</span> <span class="mh">0xE8</span><span class="p">,</span> <span class="mh">0xCB</span><span class="p">,</span> <span class="mh">0x8D</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x1B</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x6C</span><span class="p">,</span> <span class="mh">0xD8</span><span class="p">,</span> <span class="mh">0xAB</span><span class="p">,</span> <span class="mh">0x4D</span><span class="p">,</span> <span class="mh">0x9A</span><span class="p">,</span> <span class="mh">0x2F</span><span class="p">,</span> <span class="mh">0x5E</span><span class="p">,</span> <span class="mh">0xBC</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0xC6</span><span class="p">,</span> <span class="mh">0x97</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x6A</span><span class="p">,</span> <span class="mh">0xD4</span><span class="p">,</span> <span class="mh">0xB3</span><span class="p">,</span> <span class="mh">0x7D</span><span class="p">,</span> <span class="mh">0xFA</span><span class="p">,</span> <span class="mh">0xEF</span><span class="p">,</span> <span class="mh">0xC5</span><span class="p">,</span> <span class="mh">0x91</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0xE4</span><span class="p">,</span> <span class="mh">0xD3</span><span class="p">,</span> <span class="mh">0xBD</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0xC2</span><span class="p">,</span> <span class="mh">0x9F</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x4A</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0xCC</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0x1D</span><span class="p">,</span> <span class="mh">0x3A</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">,</span> <span class="mh">0xE8</span><span class="p">,</span> <span class="mh">0xCB</span><span class="p">,</span> <span class="mh">0x8D</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x1B</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x6C</span><span class="p">,</span> <span class="mh">0xD8</span><span class="p">,</span> <span class="mh">0xAB</span><span class="p">,</span> <span class="mh">0x4D</span><span class="p">,</span> <span class="mh">0x9A</span><span class="p">,</span> <span class="mh">0x2F</span><span class="p">,</span> <span class="mh">0x5E</span><span class="p">,</span> <span class="mh">0xBC</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0xC6</span><span class="p">,</span> <span class="mh">0x97</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x6A</span><span class="p">,</span> <span class="mh">0xD4</span><span class="p">,</span> <span class="mh">0xB3</span><span class="p">,</span> <span class="mh">0x7D</span><span class="p">,</span> <span class="mh">0xFA</span><span class="p">,</span> <span class="mh">0xEF</span><span class="p">,</span> <span class="mh">0xC5</span><span class="p">,</span> <span class="mh">0x91</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0xE4</span><span class="p">,</span> <span class="mh">0xD3</span><span class="p">,</span> <span class="mh">0xBD</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0xC2</span><span class="p">,</span> <span class="mh">0x9F</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x4A</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0xCC</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0x1D</span><span class="p">,</span> <span class="mh">0x3A</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">,</span> <span class="mh">0xE8</span><span class="p">,</span> <span class="mh">0xCB</span><span class="p">,</span> <span class="mh">0x8D</span> <span class="p">};</span>

        <span class="c1">/// Key schedule -- Generate one subkey for each round</span>
        <span class="c1">/// http://www.formaestudio.com/rijndaelinspector/archivos/Rijndael_Animation_v4_eng.swf</span>

        <span class="c1">// First round-key is the actual key</span>
        <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">round_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">key</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">DW</span><span class="p">(</span><span class="o">&amp;</span><span class="n">round_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">12</span><span class="p">]);</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">11</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// Rotate `d` 8 bits to the right</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">ROT</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

            <span class="c1">// Takes every bytes of `d` &amp; substitute them using `S_box`</span>
            <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a3</span><span class="p">,</span> <span class="n">a4</span><span class="p">;</span>
            <span class="c1">// Do not forget to xor this byte with `rcon[i]`</span>
            <span class="n">a1</span> <span class="o">=</span> <span class="n">S_box</span><span class="p">[(</span><span class="n">d</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">]</span> <span class="o">^</span> <span class="n">rcon</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="c1">// a1 is the LSB</span>
            <span class="n">a2</span> <span class="o">=</span> <span class="n">S_box</span><span class="p">[(</span><span class="n">d</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">];</span>
            <span class="n">a3</span> <span class="o">=</span> <span class="n">S_box</span><span class="p">[(</span><span class="n">d</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">];</span>
            <span class="n">a4</span> <span class="o">=</span> <span class="n">S_box</span><span class="p">[(</span><span class="n">d</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">];</span>

            <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="n">a1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">a2</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">a3</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">a4</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>

            <span class="c1">// Now we can generate the current roundkey using the previous one</span>
            <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">d</span> <span class="o">^=</span> <span class="n">DW</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">round_keys</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="n">j</span> <span class="o">*</span> <span class="mi">4</span><span class="p">]));</span>
                <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">round_keys</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span> <span class="o">*</span> <span class="mi">4</span><span class="p">]))</span> <span class="o">=</span> <span class="n">d</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="c1">/// Dig in now</span>
        <span class="c1">/// The initial round is just AddRoundKey with the first one (being the encryption key)</span>
        <span class="n">memcpy</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">in</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
        <span class="n">AddRoundKey</span><span class="p">(</span><span class="n">round_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">out</span><span class="p">);</span>

        <span class="c1">/// Let&#39;s start the encryption process now</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">SubBytes</span><span class="p">(</span><span class="n">out</span><span class="p">);</span>
            <span class="n">ShiftRows</span><span class="p">(</span><span class="n">out</span><span class="p">);</span>
            <span class="n">MixColumns</span><span class="p">(</span><span class="n">out</span><span class="p">);</span>
            <span class="n">AddRoundKey</span><span class="p">(</span><span class="n">round_keys</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">out</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">/// Last round which is a bit different</span>
        <span class="n">SubBytes</span><span class="p">(</span><span class="n">out</span><span class="p">);</span>
        <span class="n">ShiftRows</span><span class="p">(</span><span class="n">out</span><span class="p">);</span>
        <span class="n">AddRoundKey</span><span class="p">(</span><span class="n">round_keys</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span> <span class="n">out</span><span class="p">);</span>
    <span class="p">}</span>
</code></pre></div>

<p>Not that bad right? And we can even prepare a function that tests if the encrypted block is valid or not (this is really going to be useful as soon as we start to tweak the implementation):</p>
<div class="highlight"><pre><span></span><code>    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">tests</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">/// AES128ENC</span>
        <span class="p">{</span>
            <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">key</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0x7e</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span> <span class="mh">0xae</span><span class="p">,</span> <span class="mh">0xd2</span><span class="p">,</span> <span class="mh">0xa6</span><span class="p">,</span> <span class="mh">0xab</span><span class="p">,</span> <span class="mh">0xf7</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0xcf</span><span class="p">,</span> <span class="mh">0x4f</span><span class="p">,</span> <span class="mh">0x3c</span> <span class="p">};</span>
            <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">out</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
            <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">plain</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0xf6</span><span class="p">,</span> <span class="mh">0xa8</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">,</span> <span class="mh">0x5a</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x8d</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">,</span> <span class="mh">0xa2</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x34</span> <span class="p">};</span>
            <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">expected</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0xdc</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0xfb</span><span class="p">,</span> <span class="mh">0xdc</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0x97</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x6a</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x32</span> <span class="p">};</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;&gt; aes128_enc_base ..&quot;</span><span class="p">);</span>
            <span class="n">aes128_enc_base</span><span class="p">(</span><span class="n">plain</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">expected</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">&quot;FAIL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;OK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div>

<p>Brilliant.</p>
<h1 id="white-boxing-aes128-in-7-steps">White-boxing AES128 in ~7 steps</h1>
<h2 id="introduction_2">Introduction</h2>
<p>I'm no crypto-expert whatsoever but I'll still try to explain what "white-boxing" AES means for us. Currently, we have a block encryption primitive with the following signature <code>void aes128_enc_base(unsigned char in[16], unsigned char out[16], unsigned char key[16])</code>. One of the purpose of the white-boxing process is going to "remove", or I should say "hide" instead, the key. Your primitive will work without any input key parameter, but the key won't be hard-coded either in the body of the function. You'll be able to encrypt things without any apparent key.</p>
<p>A perfectly secure but unpractical version of a white-box AES would be to have a big hash-table: the keys would be every single possible plain-texts and the values would be their encrypted version with the key you want. That should give you a really clear idea of what a white-box is. But obviously storing that kind of table in memory is another problem by itself :-).</p>
<p>Instead of using that "naive" idea, researchers came up with way to pre-compute "things" that involve the round-keys in order to hide everything. The other goal of a real white-box is to be resistant to reverse-engineering &amp; dynamic/static analysis. Even if you are able to read whatever memory you want, you still should not be able to extract the key. The <a href="https://github.com/0vercl0k/stuffz/tree/master/NoSuchCon2013">NoSuchCon2013</a> crackme is again a really good example of that: we had to wait for 2 years before <a href="https://twitter.com/doegox">@doegox</a> actually works his magic to extract the key.</p>
<p>The design of the implementation is really really important in order to make that key extraction process the most difficult.</p>
<p>In this part, we are using James A. Muir's <a href="https://github.com/0vercl0k/stuffz/raw/master/wbaes_attack/docs/a_tutorial_on_whitebox_aes.pdf">paper</a> to rewrite step by step our implementation in order to make it possible to combine several operations between them &amp; make pre-computed table out of them. At the end of this part we should have a working AES128 encryption primitive that doesn't require an hard-coded key. But we will also build in parallel a tool used to generate the different tables our implementation is going to need: obviously, this tool is going to need both the key schedule &amp; the encryption key to be able to generate the look-up tables.
Long story short: the first steps are basically going to reorder / rewrite the logic of the encryption, &amp; the last ones will really transform the implementation in a white-box.</p>
<p>Anyway, let's go folks!</p>
<h2 id="step-1-bring-the-first-addroundkey-in-the-loop-kick-out-the-last-one-out-of-it">Step 1: bring the first <code>AddRoundKey</code> in the loop &amp; kick out the last one out of it</h2>
<p>This one is really easy: basically we just have to change our loop to start at <code>i=0</code> until <code>i=8</code> (inclusive), move the first <code>AddRoundKey</code> in the loop, and move the last one outside of it.</p>
<p>The encryption loop should look like this now:</p>
<div class="highlight"><pre><span></span><code>    <span class="kt">void</span> <span class="nf">aes128_enc_reorg_step1</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">in</span><span class="p">[</span><span class="mi">16</span><span class="p">],</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">out</span><span class="p">[</span><span class="mi">16</span><span class="p">],</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">key</span><span class="p">[</span><span class="mi">16</span><span class="p">])</span>
    <span class="p">{</span>
    <span class="p">[...]</span>
        <span class="c1">/// Key schedule -- Generate one subkey for each round</span>
    <span class="p">[...]</span>
        <span class="n">memcpy</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">in</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>

        <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">AddRoundKey</span><span class="p">(</span><span class="n">round_keys</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">out</span><span class="p">);</span>
            <span class="n">SubBytes</span><span class="p">(</span><span class="n">out</span><span class="p">);</span>
            <span class="n">ShiftRows</span><span class="p">(</span><span class="n">out</span><span class="p">);</span>
            <span class="n">MixColumns</span><span class="p">(</span><span class="n">out</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">AddRoundKey</span><span class="p">(</span><span class="n">round_keys</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span> <span class="n">out</span><span class="p">);</span>
        <span class="n">SubBytes</span><span class="p">(</span><span class="n">out</span><span class="p">);</span>
        <span class="n">ShiftRows</span><span class="p">(</span><span class="n">out</span><span class="p">);</span>
        <span class="n">AddRoundKey</span><span class="p">(</span><span class="n">round_keys</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span> <span class="n">out</span><span class="p">);</span>
    <span class="p">}</span>
</code></pre></div>

<h2 id="step-2-subbytes-then-shiftrows-equals-shiftrows-then-subbytes">Step 2: <code>SubBytes</code> then <code>ShiftRows</code> equals <code>ShiftRows</code> then <code>SubBytes</code></h2>
<p>Yet another easy one: because <code>SubBytes</code> is just replacing a byte by its substitution (stored in <code>S_box</code>), you can apply <code>ShiftRows</code> before <code>SubBytes</code> or <code>SubBytes</code> before <code>ShiftRows</code> ; you will get the same result. So let's exchange them:</p>
<div class="highlight"><pre><span></span><code>    <span class="kt">void</span> <span class="nf">aes128_enc_reorg_step2</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">in</span><span class="p">[</span><span class="mi">16</span><span class="p">],</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">out</span><span class="p">[</span><span class="mi">16</span><span class="p">],</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">key</span><span class="p">[</span><span class="mi">16</span><span class="p">])</span>
    <span class="p">{</span>
    <span class="p">[...]</span>
        <span class="c1">/// Key schedule -- Generate one subkey for each round</span>
    <span class="p">[...]</span>
        <span class="n">memcpy</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">in</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>

        <span class="c1">/// Let&#39;s start the encryption process now</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">AddRoundKey</span><span class="p">(</span><span class="n">round_keys</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">out</span><span class="p">);</span>
            <span class="n">ShiftRows</span><span class="p">(</span><span class="n">out</span><span class="p">);</span>
            <span class="n">SubBytes</span><span class="p">(</span><span class="n">out</span><span class="p">);</span>
            <span class="n">MixColumns</span><span class="p">(</span><span class="n">out</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">/// Last round which is a bit different</span>
        <span class="n">AddRoundKey</span><span class="p">(</span><span class="n">round_keys</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span> <span class="n">out</span><span class="p">);</span>
        <span class="n">ShiftRows</span><span class="p">(</span><span class="n">out</span><span class="p">);</span>
        <span class="n">SubBytes</span><span class="p">(</span><span class="n">out</span><span class="p">);</span>
        <span class="n">AddRoundKey</span><span class="p">(</span><span class="n">round_keys</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span> <span class="n">out</span><span class="p">);</span>
    <span class="p">}</span>
</code></pre></div>

<h2 id="step-3-shiftrows-first-but-needs-to-shiftrows-the-round-key">Step 3: <code>ShiftRows</code> first, but needs to <code>ShiftRows</code> the round-key</h2>
<p>This one is a bit more tricky, but again it's more about reordering, rewriting the encryption loop than really replacing computation by look-up tables so far. Basically, the idea of this step is to start the encryption loop with a <code>ShiftRows</code> operation. Because of the way this operation is defined, if you put it first you also need to apply <code>ShiftRows</code> to the current round key in order to get the same result than <code>AddRoundKey</code>/<code>ShiftRows</code>.</p>
<div class="highlight"><pre><span></span><code>    <span class="kt">void</span> <span class="nf">aes128_enc_reorg_step3</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">in</span><span class="p">[</span><span class="mi">16</span><span class="p">],</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">out</span><span class="p">[</span><span class="mi">16</span><span class="p">],</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">key</span><span class="p">[</span><span class="mi">16</span><span class="p">])</span>
    <span class="p">{</span>
    <span class="p">[...]</span>
        <span class="c1">/// Key schedule -- Generate one subkey for each round</span>
    <span class="p">[...]</span>
        <span class="c1">/// Let&#39;s start the encryption process now</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">ShiftRows</span><span class="p">(</span><span class="n">out</span><span class="p">);</span>
            <span class="n">ShiftRows</span><span class="p">(</span><span class="n">round_keys</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
            <span class="n">AddRoundKey</span><span class="p">(</span><span class="n">round_keys</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">out</span><span class="p">);</span>
            <span class="n">SubBytes</span><span class="p">(</span><span class="n">out</span><span class="p">);</span>
            <span class="n">MixColumns</span><span class="p">(</span><span class="n">out</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">/// Last round which is a bit different</span>
        <span class="n">ShiftRows</span><span class="p">(</span><span class="n">out</span><span class="p">);</span>
        <span class="n">ShiftRows</span><span class="p">(</span><span class="n">round_keys</span><span class="p">[</span><span class="mi">9</span><span class="p">]);</span>
        <span class="n">AddRoundKey</span><span class="p">(</span><span class="n">round_keys</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span> <span class="n">out</span><span class="p">);</span>
        <span class="n">SubBytes</span><span class="p">(</span><span class="n">out</span><span class="p">);</span>
        <span class="n">AddRoundKey</span><span class="p">(</span><span class="n">round_keys</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span> <span class="n">out</span><span class="p">);</span>
    <span class="p">}</span>
</code></pre></div>

<h2 id="step-4-white-boxing-it-like-its-hot-white-boxing-it-like-its-hot">Step 4: White-boxing it like it's hot, White-boxing it like it's hot</h2>
<p>This step is a really important one for us, it's actually the first one where we are going to be able to both remove the key &amp; start the tables generator project. The tables generator project basically generates everything we need to have our white-box AES encryption working.</p>
<p>Now we don't need the key schedule anymore in the AES encryption function (but obviously we will need it on the table generator side), and we can keep only the encryption loop.</p>
<p>The transformation introduced in this step is to create a look-up table that will replace <code>ShiftRows(round_keys[i])</code>/<code>AddRoundKey</code>/<code>SubBytes</code>. We can clearly see now how our round keys are going to be "diffused" &amp; combined with different operations to make them "not trivially" extractable (in fact they are, but let's say they are not right now). In order to have such a table, we need quite some space though: basically we need this table <code>Tboxes[10][16][0x100]</code>. We have 10 operations <code>ShiftRows(round_keys[i])</code>/<code>AddRoundKey</code>/<code>SubBytes</code>, 16 bytes of round keys in each one of them and the 0x100 for the bytes (<code>[0x00-0xFF]</code>) than can be encrypted.</p>
<p>The computation is not really hard:</p>
<ol>
<li>We compute the key schedule for a specific encryption key</li>
<li>We populate the table this way:<ol>
<li>For each round key:</li>
<li>For every byte possible:<ol>
<li>You compute <code>S_box[byte ^ ShiftRows(roundkey)[i]]</code></li>
</ol>
</li>
</ol>
</li>
</ol>
<p>The <code>S_box</code> part is for the <code>SubBytes</code> operation, the xor with one byte of the round key is for <code>AddRoundKey</code> &amp; the rest is for <code>ShiftRows(round_keys[i])</code>. There is a special case for the 9th round key, where you have to include <code>AddRoundKey</code> of the latest round key. It's like we don't have 11 rounds anymore, but 10 now. As the 9th contains information about the round key 9th &amp; 10th.</p>
<p>If you are confused about that bit, don't be ; it's just I suck at explaining things, but just have a look at the following code (especially at lines 47, 48):</p>
<div class="highlight"><pre><span></span><code>    <span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">key</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;0vercl0k@doare-e&quot;</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">plain_block</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;whatdup folks???&quot;</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">round_keys</span><span class="p">[</span><span class="mi">11</span><span class="p">][</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>

        <span class="c1">/// 10 -&gt; we have 10 rounds</span>
        <span class="c1">/// 16 -&gt; we have 16 bytes of round keys</span>
        <span class="c1">/// 0x100 -&gt; we have to be able to encrypt every plain-text input byte [0-0xff]</span>
        <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Tboxes</span><span class="p">[</span><span class="mi">10</span><span class="p">][</span><span class="mi">16</span><span class="p">][</span><span class="mh">0x100</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>

        <span class="n">key_schedule</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">round_keys</span><span class="p">);</span>

        <span class="c1">/// Remember we have 10 rounds &amp; we want to combine AddRoundKey &amp; SubBytes</span>
        <span class="c1">/// which is really simple.</span>
        <span class="c1">/// These so-called T-boxes are defined as follows:</span>
        <span class="c1">/// Tri(x) = S[x ^ ShiftRows(rk)[i]] ; r being the round number ([0-8]), x being the byte of plaintext, rk the roundkey &amp; i the index ([0-15])</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;#pragma once</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;// Table for key=&#39;%.16s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;const unsigned char Tboxes[10][16][0x100] = </span><span class="se">\n</span><span class="s">{</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="o">++</span><span class="n">r</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;  {</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

            <span class="n">ShiftRows</span><span class="p">(</span><span class="n">round_keys</span><span class="p">[</span><span class="n">r</span><span class="p">]);</span>

            <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">&quot;    {</span><span class="se">\n</span><span class="s">      &quot;</span><span class="p">);</span>
                <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mh">0x100</span><span class="p">;</span> <span class="o">++</span><span class="n">x</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">x</span> <span class="o">%</span> <span class="mi">16</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">      &quot;</span><span class="p">);</span>

                    <span class="n">Tboxes</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">S_box</span><span class="p">[</span><span class="n">x</span> <span class="o">^</span> <span class="n">round_keys</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">i</span><span class="p">]];</span>
                    <span class="c1">/// We need to include the bytes from the roundkey 10 to replace that:</span>
                    <span class="c1">///  ShiftRows(out);</span>
                    <span class="c1">///  ShiftRows(round_keys[9]);</span>
                    <span class="c1">///  AddRoundKey(round_keys[9], out);</span>
                    <span class="c1">///  SubBytes(out);</span>
                    <span class="c1">///  AddRoundKey(round_keys[10], out);</span>
                    <span class="c1">///</span>
                    <span class="c1">/// By</span>
                    <span class="c1">/// ShiftRows(out);</span>
                    <span class="c1">/// for (size_t j = 0; j &lt; 16; ++j)</span>
                    <span class="c1">///     out[j] = Tboxes[9][j][out[j]];</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="mi">9</span><span class="p">)</span>
                        <span class="n">Tboxes</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">x</span><span class="p">]</span> <span class="o">^=</span> <span class="n">round_keys</span><span class="p">[</span><span class="mi">10</span><span class="p">][</span><span class="n">i</span><span class="p">];</span>

                    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;0x%.2x&quot;</span><span class="p">,</span> <span class="n">Tboxes</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">x</span><span class="p">]);</span>
                    <span class="k">if</span> <span class="p">((</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mh">0x100</span><span class="p">)</span>
                        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;, &quot;</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">    }&quot;</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span>
                    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="p">);</span>

                <span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;  }&quot;</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">r</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="p">);</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;};</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="p">}</span>
</code></pre></div>

<p>Now that we have this table created, we just need to actually use it in our encryption. Thanks to this table, the encryption loop is way more simple and pretty, check it out:</p>
<div class="highlight"><pre><span></span><code>    <span class="kt">void</span> <span class="nf">aes128_enc_wb_step1</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">in</span><span class="p">[</span><span class="mi">16</span><span class="p">],</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">out</span><span class="p">[</span><span class="mi">16</span><span class="p">])</span>
    <span class="p">{</span>
        <span class="n">memcpy</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">in</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>

        <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">ShiftRows</span><span class="p">(</span><span class="n">out</span><span class="p">);</span>

            <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">x</span> <span class="o">=</span> <span class="n">Tboxes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="n">out</span><span class="p">[</span><span class="n">j</span><span class="p">]];</span>
                <span class="n">out</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="n">MixColumns</span><span class="p">(</span><span class="n">out</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">ShiftRows</span><span class="p">(</span><span class="n">out</span><span class="p">);</span>

        <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">x</span> <span class="o">=</span> <span class="n">Tboxes</span><span class="p">[</span><span class="mi">9</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="n">out</span><span class="p">[</span><span class="n">j</span><span class="p">]];</span>
            <span class="n">out</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div>

<h2 id="step-5-transforming-mixcolumns-in-a-look-up-table">Step 5: Transforming <code>MixColumns</code> in a look-up table</h2>
<p>OK, so this is maybe the "most difficult" part of the game: we have to transform our ugly <code>MixColumn</code> function in four look-up tables. Basically, we want to transform this:</p>
<div class="highlight"><pre><span></span><code>    <span class="n">out</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">gmul</span><span class="p">[</span><span class="n">matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">a</span><span class="p">]</span> <span class="o">^</span> <span class="n">gmul</span><span class="p">[</span><span class="n">matrix</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="n">b</span><span class="p">]</span> <span class="o">^</span> <span class="n">gmul</span><span class="p">[</span><span class="n">matrix</span><span class="p">[</span><span class="mi">2</span><span class="p">]][</span><span class="n">c</span><span class="p">]</span> <span class="o">^</span> <span class="n">gmul</span><span class="p">[</span><span class="n">matrix</span><span class="p">[</span><span class="mi">3</span><span class="p">]][</span><span class="n">d</span><span class="p">];</span>
    <span class="n">out</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">gmul</span><span class="p">[</span><span class="n">matrix</span><span class="p">[</span><span class="mi">4</span><span class="p">]][</span><span class="n">a</span><span class="p">]</span> <span class="o">^</span> <span class="n">gmul</span><span class="p">[</span><span class="n">matrix</span><span class="p">[</span><span class="mi">5</span><span class="p">]][</span><span class="n">b</span><span class="p">]</span> <span class="o">^</span> <span class="n">gmul</span><span class="p">[</span><span class="n">matrix</span><span class="p">[</span><span class="mi">6</span><span class="p">]][</span><span class="n">c</span><span class="p">]</span> <span class="o">^</span> <span class="n">gmul</span><span class="p">[</span><span class="n">matrix</span><span class="p">[</span><span class="mi">7</span><span class="p">]][</span><span class="n">d</span><span class="p">];</span>
    <span class="n">out</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">gmul</span><span class="p">[</span><span class="n">matrix</span><span class="p">[</span><span class="mi">8</span><span class="p">]][</span><span class="n">a</span><span class="p">]</span> <span class="o">^</span> <span class="n">gmul</span><span class="p">[</span><span class="n">matrix</span><span class="p">[</span><span class="mi">9</span><span class="p">]][</span><span class="n">b</span><span class="p">]</span> <span class="o">^</span> <span class="n">gmul</span><span class="p">[</span><span class="n">matrix</span><span class="p">[</span><span class="mi">10</span><span class="p">]][</span><span class="n">c</span><span class="p">]</span> <span class="o">^</span> <span class="n">gmul</span><span class="p">[</span><span class="n">matrix</span><span class="p">[</span><span class="mi">11</span><span class="p">]][</span><span class="n">d</span><span class="p">];</span>
    <span class="n">out</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">gmul</span><span class="p">[</span><span class="n">matrix</span><span class="p">[</span><span class="mi">12</span><span class="p">]][</span><span class="n">a</span><span class="p">]</span> <span class="o">^</span> <span class="n">gmul</span><span class="p">[</span><span class="n">matrix</span><span class="p">[</span><span class="mi">13</span><span class="p">]][</span><span class="n">b</span><span class="p">]</span> <span class="o">^</span> <span class="n">gmul</span><span class="p">[</span><span class="n">matrix</span><span class="p">[</span><span class="mi">14</span><span class="p">]][</span><span class="n">c</span><span class="p">]</span> <span class="o">^</span> <span class="n">gmul</span><span class="p">[</span><span class="n">matrix</span><span class="p">[</span><span class="mi">15</span><span class="p">]][</span><span class="n">d</span><span class="p">];</span>
</code></pre></div>

<p>by this (where <code>Ty[0-4]</code> are the look-up tables I mentioned just above):</p>
<div class="highlight"><pre><span></span><code>    <span class="n">DW</span><span class="p">(</span><span class="o">&amp;</span><span class="n">out</span><span class="p">[</span><span class="n">j</span> <span class="o">*</span> <span class="mi">4</span><span class="p">])</span> <span class="o">=</span> <span class="n">Ty</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">a</span><span class="p">]</span> <span class="o">^</span> <span class="n">Ty</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">b</span><span class="p">]</span> <span class="o">^</span> <span class="n">Ty</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">^</span> <span class="n">Ty</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">d</span><span class="p">];</span>
</code></pre></div>

<p>We know that <code>gmul[X]</code> gives you 1 byte, and we can see those four lines use <code>gmul[X][a]</code> where <code>X</code> is constant. You can also see that basically those four lines take 4 bytes as input <code>a</code>, <code>b</code>, <code>c</code> &amp; <code>d</code> and will generate 4 bytes as output.</p>
<p>The idea is to combine <code>gmul[matrix[0]][a]</code>, <code>gmul[matrix[4]][a]</code>, <code>gmul[matrix[8]][a]</code> &amp; <code>gmul[matrix[12]][a]</code> inside a single double-word. We do the same for <code>b</code>, <code>c</code> &amp; <code>d</code> so that we can directly apply the <code>xor</code> operation between double-words now ; the result will also be a double-word so we have our 4 output bytes. We just re-factorized 4 individual computations (1 byte as input, 1 byte as output) into a single one (4 bytes as input, 4 bytes as output).</p>
<p>With that in mind, the tables generation function writes nearly by itself:</p>
<div class="highlight"><pre><span></span><code>    <span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
    <span class="p">{</span>
    <span class="p">[...]</span>
        <span class="k">typedef</span> <span class="k">union</span>
        <span class="p">{</span>
            <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
            <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
        <span class="p">}</span> <span class="n">magic_int</span><span class="p">;</span>

        <span class="c1">/// 4 -&gt; four rows MC</span>
        <span class="c1">/// 0x100 -&gt; for every char</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">Ty</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="mh">0x100</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;const unsigned int Ty[4][16][0x100] =</span><span class="se">\n</span><span class="s">{</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;  {</span><span class="se">\n</span><span class="s">    &quot;</span><span class="p">);</span>
            <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mh">0x100</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">j</span> <span class="o">%</span> <span class="mi">16</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">    &quot;</span><span class="p">);</span>

                <span class="n">magic_int</span> <span class="n">mi</span><span class="p">;</span>

                <span class="n">mi</span><span class="p">.</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">gmul</span><span class="p">[</span><span class="n">matrix</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]][</span><span class="n">j</span><span class="p">];</span>
                <span class="n">mi</span><span class="p">.</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">gmul</span><span class="p">[</span><span class="n">matrix</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]][</span><span class="n">j</span><span class="p">];</span>
                <span class="n">mi</span><span class="p">.</span><span class="n">b</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">gmul</span><span class="p">[</span><span class="n">matrix</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">8</span><span class="p">]][</span><span class="n">j</span><span class="p">];</span>
                <span class="n">mi</span><span class="p">.</span><span class="n">b</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">gmul</span><span class="p">[</span><span class="n">matrix</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">12</span><span class="p">]][</span><span class="n">j</span><span class="p">];</span>

                <span class="n">Ty</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">mi</span><span class="p">.</span><span class="n">i</span><span class="p">;</span>

                <span class="n">printf</span><span class="p">(</span><span class="s">&quot;0x%.8x&quot;</span><span class="p">,</span> <span class="n">Ty</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]);</span>
                <span class="k">if</span> <span class="p">((</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mh">0x100</span><span class="p">)</span>
                    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;, &quot;</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">  }&quot;</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="p">);</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;};</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="p">}</span>
</code></pre></div>

<p>Glad to replace that <code>MixColumn</code> call now:</p>
<div class="highlight"><pre><span></span><code>    <span class="kt">void</span> <span class="nf">aes128_enc_wb_step2</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">in</span><span class="p">[</span><span class="mi">16</span><span class="p">],</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">out</span><span class="p">[</span><span class="mi">16</span><span class="p">])</span>
    <span class="p">{</span>
        <span class="n">memcpy</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">in</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>

        <span class="c1">/// Let&#39;s start the encryption process now</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">ShiftRows</span><span class="p">(</span><span class="n">out</span><span class="p">);</span>

            <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">x</span> <span class="o">=</span> <span class="n">Tboxes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="n">out</span><span class="p">[</span><span class="n">j</span><span class="p">]];</span>
                <span class="n">out</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">a</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="n">j</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">0</span><span class="p">];</span>
                <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="n">j</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
                <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="n">j</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">2</span><span class="p">];</span>
                <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">d</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="n">j</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">3</span><span class="p">];</span>

                <span class="n">DW</span><span class="p">(</span><span class="o">&amp;</span><span class="n">out</span><span class="p">[</span><span class="n">j</span> <span class="o">*</span> <span class="mi">4</span><span class="p">])</span> <span class="o">=</span> <span class="n">Ty</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">a</span><span class="p">]</span> <span class="o">^</span> <span class="n">Ty</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">b</span><span class="p">]</span> <span class="o">^</span> <span class="n">Ty</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">^</span> <span class="n">Ty</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">d</span><span class="p">];</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="c1">/// Last round which is a bit different</span>
        <span class="n">ShiftRows</span><span class="p">(</span><span class="n">out</span><span class="p">);</span>

        <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">x</span> <span class="o">=</span> <span class="n">Tboxes</span><span class="p">[</span><span class="mi">9</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="n">out</span><span class="p">[</span><span class="n">j</span><span class="p">]];</span>
            <span class="n">out</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div>

<p>You can even make it cleaner by merging the two inner-loops &amp; make them both handle 4 bytes of data by 4 bytes of data:</p>
<div class="highlight"><pre><span></span><code>    <span class="c1">// Unified the loops by treating the state 4 bytes by 4 bytes</span>
    <span class="kt">void</span> <span class="nf">aes128_enc_wb_step3</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">in</span><span class="p">[</span><span class="mi">16</span><span class="p">],</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">out</span><span class="p">[</span><span class="mi">16</span><span class="p">])</span>
    <span class="p">{</span>
        <span class="n">memcpy</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">in</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>

        <span class="c1">/// Let&#39;s start the encryption process now</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">ShiftRows</span><span class="p">(</span><span class="n">out</span><span class="p">);</span>

            <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">a</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="n">j</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">0</span><span class="p">];</span>
                <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="n">j</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
                <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="n">j</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">2</span><span class="p">];</span>
                <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">d</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="n">j</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">3</span><span class="p">];</span>

                <span class="n">a</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="n">j</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Tboxes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">0</span><span class="p">][</span><span class="n">a</span><span class="p">];</span>
                <span class="n">b</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="n">j</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">Tboxes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="n">b</span><span class="p">];</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="n">j</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">Tboxes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">2</span><span class="p">][</span><span class="n">c</span><span class="p">];</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="n">j</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">Tboxes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">3</span><span class="p">][</span><span class="n">d</span><span class="p">];</span>

                <span class="n">DW</span><span class="p">(</span><span class="o">&amp;</span><span class="n">out</span><span class="p">[</span><span class="n">j</span> <span class="o">*</span> <span class="mi">4</span><span class="p">])</span> <span class="o">=</span> <span class="n">Ty</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">a</span><span class="p">]</span> <span class="o">^</span> <span class="n">Ty</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">b</span><span class="p">]</span> <span class="o">^</span> <span class="n">Ty</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">^</span> <span class="n">Ty</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">d</span><span class="p">];</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="c1">/// Last round which is a bit different</span>
        <span class="n">ShiftRows</span><span class="p">(</span><span class="n">out</span><span class="p">);</span>

        <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">x</span> <span class="o">=</span> <span class="n">Tboxes</span><span class="p">[</span><span class="mi">9</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="n">out</span><span class="p">[</span><span class="n">j</span><span class="p">]];</span>
            <span class="n">out</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div>

<h2 id="step-6-adding-a-little-xor-table">Step 6: Adding a little <em>xor</em> table</h2>
<p>This step is a really simple one (&amp; kind of useless) ; we just want to transform the <em>xor</em> operation between 2 double-words by a look-up table that does that between 2 nibbles (4 bits). Basically, you combine 8 nibbles to get a full double-word with <em>or</em> operations &amp; some binary shifts. Easy peasy:</p>
<div class="highlight"><pre><span></span><code>    <span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
    <span class="p">{</span>
    <span class="p">[...]</span>
        <span class="c1">/// Xor Tables</span>
        <span class="c1">/// Basically takes two nibbles in input &amp; generate a nibble in output (x^y)</span>
        <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Xor</span><span class="p">[</span><span class="mh">0x10</span><span class="p">][</span><span class="mh">0x10</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;const unsigned char Xor[0x10][0x10] =</span><span class="se">\n</span><span class="s">{</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x10</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;  {</span><span class="se">\n</span><span class="s">    &quot;</span><span class="p">);</span>

            <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mh">0x10</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">j</span> <span class="o">%</span> <span class="mi">8</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">    &quot;</span><span class="p">);</span>

                <span class="n">Xor</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">^</span> <span class="n">j</span><span class="p">;</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">&quot;0x%.1x&quot;</span><span class="p">,</span> <span class="n">Xor</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]);</span>
                <span class="k">if</span> <span class="p">((</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mh">0x10</span><span class="p">)</span>
                    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;, &quot;</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">  }&quot;</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mh">0x10</span><span class="p">)</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="p">);</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;};</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">EXIT_SUCCESS</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div>

<p>Which is directly used by our implementation:</p>
<div class="highlight"><pre><span></span><code>    <span class="kt">void</span> <span class="nf">aes128_enc_wb_step4</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">in</span><span class="p">[</span><span class="mi">16</span><span class="p">],</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">out</span><span class="p">[</span><span class="mi">16</span><span class="p">])</span>
    <span class="p">{</span>
        <span class="n">memcpy</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">in</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>

        <span class="c1">/// Let&#39;s start the encryption process now</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">ShiftRows</span><span class="p">(</span><span class="n">out</span><span class="p">);</span>

            <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">a</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="n">j</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">0</span><span class="p">];</span>
                <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="n">j</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
                <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="n">j</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">2</span><span class="p">];</span>
                <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">d</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="n">j</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">3</span><span class="p">];</span>

                <span class="n">a</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="n">j</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Tboxes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">0</span><span class="p">][</span><span class="n">a</span><span class="p">];</span>
                <span class="n">b</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="n">j</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">Tboxes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="n">b</span><span class="p">];</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="n">j</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">Tboxes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">2</span><span class="p">][</span><span class="n">c</span><span class="p">];</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="n">j</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">Tboxes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">3</span><span class="p">][</span><span class="n">d</span><span class="p">];</span>

                <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">aa</span> <span class="o">=</span> <span class="n">Ty</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">a</span><span class="p">];</span>
                <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bb</span> <span class="o">=</span> <span class="n">Ty</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">b</span><span class="p">];</span>
                <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cc</span> <span class="o">=</span> <span class="n">Ty</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">c</span><span class="p">];</span>
                <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dd</span> <span class="o">=</span> <span class="n">Ty</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">d</span><span class="p">];</span>

                <span class="n">out</span><span class="p">[</span><span class="n">j</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Txor</span><span class="p">[</span><span class="n">Txor</span><span class="p">[(</span><span class="n">aa</span> <span class="o">&gt;&gt;</span>  <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">][(</span><span class="n">bb</span> <span class="o">&gt;&gt;</span>  <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">]][</span><span class="n">Txor</span><span class="p">[(</span><span class="n">cc</span> <span class="o">&gt;&gt;</span>  <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">][(</span><span class="n">dd</span> <span class="o">&gt;&gt;</span>  <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">]])</span>  <span class="o">|</span> <span class="p">((</span><span class="n">Txor</span><span class="p">[</span><span class="n">Txor</span><span class="p">[(</span><span class="n">aa</span> <span class="o">&gt;&gt;</span>  <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">][(</span><span class="n">bb</span> <span class="o">&gt;&gt;</span>  <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">]][</span><span class="n">Txor</span><span class="p">[(</span><span class="n">cc</span> <span class="o">&gt;&gt;</span>  <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">][(</span><span class="n">dd</span> <span class="o">&gt;&gt;</span>  <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">]])</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
                <span class="n">out</span><span class="p">[</span><span class="n">j</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Txor</span><span class="p">[</span><span class="n">Txor</span><span class="p">[(</span><span class="n">aa</span> <span class="o">&gt;&gt;</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">][(</span><span class="n">bb</span> <span class="o">&gt;&gt;</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">]][</span><span class="n">Txor</span><span class="p">[(</span><span class="n">cc</span> <span class="o">&gt;&gt;</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">][(</span><span class="n">dd</span> <span class="o">&gt;&gt;</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">]])</span>  <span class="o">|</span> <span class="p">((</span><span class="n">Txor</span><span class="p">[</span><span class="n">Txor</span><span class="p">[(</span><span class="n">aa</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">][(</span><span class="n">bb</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">]][</span><span class="n">Txor</span><span class="p">[(</span><span class="n">cc</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">][(</span><span class="n">dd</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">]])</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
                <span class="n">out</span><span class="p">[</span><span class="n">j</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Txor</span><span class="p">[</span><span class="n">Txor</span><span class="p">[(</span><span class="n">aa</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">][(</span><span class="n">bb</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">]][</span><span class="n">Txor</span><span class="p">[(</span><span class="n">cc</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">][(</span><span class="n">dd</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">]])</span>  <span class="o">|</span> <span class="p">((</span><span class="n">Txor</span><span class="p">[</span><span class="n">Txor</span><span class="p">[(</span><span class="n">aa</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">][(</span><span class="n">bb</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">]][</span><span class="n">Txor</span><span class="p">[(</span><span class="n">cc</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">][(</span><span class="n">dd</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">]])</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
                <span class="n">out</span><span class="p">[</span><span class="n">j</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Txor</span><span class="p">[</span><span class="n">Txor</span><span class="p">[(</span><span class="n">aa</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">][(</span><span class="n">bb</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">]][</span><span class="n">Txor</span><span class="p">[(</span><span class="n">cc</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">][(</span><span class="n">dd</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">]])</span>  <span class="o">|</span> <span class="p">((</span><span class="n">Txor</span><span class="p">[</span><span class="n">Txor</span><span class="p">[(</span><span class="n">aa</span> <span class="o">&gt;&gt;</span> <span class="mi">28</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">][(</span><span class="n">bb</span> <span class="o">&gt;&gt;</span> <span class="mi">28</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">]][</span><span class="n">Txor</span><span class="p">[(</span><span class="n">cc</span> <span class="o">&gt;&gt;</span> <span class="mi">28</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">][(</span><span class="n">dd</span> <span class="o">&gt;&gt;</span> <span class="mi">28</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">]])</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="c1">/// Last round which is a bit different</span>
        <span class="n">ShiftRows</span><span class="p">(</span><span class="n">out</span><span class="p">);</span>

        <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">x</span> <span class="o">=</span> <span class="n">Tboxes</span><span class="p">[</span><span class="mi">9</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="n">out</span><span class="p">[</span><span class="n">j</span><span class="p">]];</span>
            <span class="n">out</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div>

<h2 id="step-7-combining-tboxes-ty-tables">Step 7: Combining TBoxes &amp; Ty tables</h2>
<p>The last step aims to combine the <code>Tboxes</code> with <code>Ty</code> tables and if you look at the code it doesn't seem really hard. We basically want the table to work this way: 1 byte as input (<code>a</code> for example in the previous code) &amp; generate 4 bytes of outputs.</p>
<p>To compute such a table, you need to compute the <code>Tboxes</code> (or not, you can compute everything without relying on the <code>Tboxes</code> ; it's actually what I'm doing), &amp; then you compute <code>Ty[Y][Tboxes[i][j][X]]</code> ; this is it, roughly. <code>X</code>, <code>i</code> and <code>j</code> are the unknown variables here, which means we will end-up with a table like that:</p>
<div class="highlight"><pre><span></span><code>    <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">Tyboxes</span><span class="p">[</span><span class="mi">9</span><span class="p">][</span><span class="mi">16</span><span class="p">][</span><span class="mh">0x100</span><span class="p">];</span>
</code></pre></div>

<p>Makes sense right?</p>
<p>So here is the code that generates that big table:</p>
<div class="highlight"><pre><span></span><code>    <span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
    <span class="p">{</span>
    <span class="p">[...]</span>
        <span class="c1">/// Tyboxes</span>
        <span class="c1">/// It&#39;s basically Tybox(Tboxes(x))</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">Tyboxes</span><span class="p">[</span><span class="mi">9</span><span class="p">][</span><span class="mi">16</span><span class="p">][</span><span class="mh">0x100</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;const unsigned int Tyboxes[9][16][0x100] =</span><span class="se">\n</span><span class="s">{</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">;</span> <span class="o">++</span><span class="n">r</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;  {</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

            <span class="c1">// ShiftRows(round_keys[r]); &lt;- don&#39;t forget we already executed that to compute the Tboxes</span>

            <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">&quot;    {</span><span class="se">\n</span><span class="s">      &quot;</span><span class="p">);</span>
                <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mh">0x100</span><span class="p">;</span> <span class="o">++</span><span class="n">x</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">x</span> <span class="o">%</span> <span class="mi">16</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">      &quot;</span><span class="p">);</span>

                    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="n">S_box</span><span class="p">[</span><span class="n">x</span> <span class="o">^</span> <span class="n">round_keys</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">i</span><span class="p">]];</span>
                    <span class="n">Tyboxes</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">Ty</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="mi">4</span><span class="p">][</span><span class="n">c</span><span class="p">];</span>

                    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;0x%.8x&quot;</span><span class="p">,</span> <span class="n">Tyboxes</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">x</span><span class="p">]);</span>
                    <span class="k">if</span> <span class="p">((</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mh">0x100</span><span class="p">)</span>
                        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;, &quot;</span><span class="p">);</span>
                <span class="p">}</span>

                <span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">    }&quot;</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span>
                    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="p">);</span>

                <span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;  }&quot;</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">r</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="p">);</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;};</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;const unsigned char Tboxes_[16][0x100] = </span><span class="se">\n</span><span class="s">{</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;  {</span><span class="se">\n</span><span class="s">    &quot;</span><span class="p">);</span>
            <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mh">0x100</span><span class="p">;</span> <span class="o">++</span><span class="n">x</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">x</span> <span class="o">%</span> <span class="mi">16</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">    &quot;</span><span class="p">);</span>

                <span class="n">Tboxes</span><span class="p">[</span><span class="mi">9</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">S_box</span><span class="p">[</span><span class="n">x</span> <span class="o">^</span> <span class="n">round_keys</span><span class="p">[</span><span class="mi">9</span><span class="p">][</span><span class="n">i</span><span class="p">]]</span> <span class="o">^</span> <span class="n">round_keys</span><span class="p">[</span><span class="mi">10</span><span class="p">][</span><span class="n">i</span><span class="p">];</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">&quot;0x%.2x&quot;</span><span class="p">,</span> <span class="n">Tboxes</span><span class="p">[</span><span class="mi">9</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">x</span><span class="p">]);</span>
                <span class="k">if</span> <span class="p">((</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mh">0x100</span><span class="p">)</span>
                    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;, &quot;</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">  }&quot;</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="p">);</span>

            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;};</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">EXIT_SUCCESS</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div>

<p>We just have to take care of the last round which is a bit different as we saw earlier, but no biggie.</p>
<h2 id="final-code">Final code</h2>
<p>Yeah, finally, here we are ; the final code of our (not protected) AES128 white-box:</p>
<div class="highlight"><pre><span></span><code>    <span class="kt">void</span> <span class="nf">aes128_enc_wb_final</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">in</span><span class="p">[</span><span class="mi">16</span><span class="p">],</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">out</span><span class="p">[</span><span class="mi">16</span><span class="p">])</span>
    <span class="p">{</span>
        <span class="n">memcpy</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">in</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>

        <span class="c1">/// Let&#39;s start the encryption process now</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">ShiftRows</span><span class="p">(</span><span class="n">out</span><span class="p">);</span>

            <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">aa</span> <span class="o">=</span> <span class="n">Tyboxes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">0</span><span class="p">][</span><span class="n">out</span><span class="p">[</span><span class="n">j</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]];</span>
                <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bb</span> <span class="o">=</span> <span class="n">Tyboxes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="n">out</span><span class="p">[</span><span class="n">j</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]];</span>
                <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cc</span> <span class="o">=</span> <span class="n">Tyboxes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">2</span><span class="p">][</span><span class="n">out</span><span class="p">[</span><span class="n">j</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]];</span>
                <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dd</span> <span class="o">=</span> <span class="n">Tyboxes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">3</span><span class="p">][</span><span class="n">out</span><span class="p">[</span><span class="n">j</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]];</span>

                <span class="n">out</span><span class="p">[</span><span class="n">j</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Txor</span><span class="p">[</span><span class="n">Txor</span><span class="p">[(</span><span class="n">aa</span> <span class="o">&gt;&gt;</span>  <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">][(</span><span class="n">bb</span> <span class="o">&gt;&gt;</span>  <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">]][</span><span class="n">Txor</span><span class="p">[(</span><span class="n">cc</span> <span class="o">&gt;&gt;</span>  <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">][(</span><span class="n">dd</span> <span class="o">&gt;&gt;</span>  <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">]])</span> <span class="o">|</span> <span class="p">((</span><span class="n">Txor</span><span class="p">[</span><span class="n">Txor</span><span class="p">[(</span><span class="n">aa</span> <span class="o">&gt;&gt;</span>  <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">][(</span><span class="n">bb</span> <span class="o">&gt;&gt;</span>  <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">]][</span><span class="n">Txor</span><span class="p">[(</span><span class="n">cc</span> <span class="o">&gt;&gt;</span>  <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">][(</span><span class="n">dd</span> <span class="o">&gt;&gt;</span>  <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">]])</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
                <span class="n">out</span><span class="p">[</span><span class="n">j</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Txor</span><span class="p">[</span><span class="n">Txor</span><span class="p">[(</span><span class="n">aa</span> <span class="o">&gt;&gt;</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">][(</span><span class="n">bb</span> <span class="o">&gt;&gt;</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">]][</span><span class="n">Txor</span><span class="p">[(</span><span class="n">cc</span> <span class="o">&gt;&gt;</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">][(</span><span class="n">dd</span> <span class="o">&gt;&gt;</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">]])</span> <span class="o">|</span> <span class="p">((</span><span class="n">Txor</span><span class="p">[</span><span class="n">Txor</span><span class="p">[(</span><span class="n">aa</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">][(</span><span class="n">bb</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">]][</span><span class="n">Txor</span><span class="p">[(</span><span class="n">cc</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">][(</span><span class="n">dd</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">]])</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
                <span class="n">out</span><span class="p">[</span><span class="n">j</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Txor</span><span class="p">[</span><span class="n">Txor</span><span class="p">[(</span><span class="n">aa</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">][(</span><span class="n">bb</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">]][</span><span class="n">Txor</span><span class="p">[(</span><span class="n">cc</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">][(</span><span class="n">dd</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">]])</span> <span class="o">|</span> <span class="p">((</span><span class="n">Txor</span><span class="p">[</span><span class="n">Txor</span><span class="p">[(</span><span class="n">aa</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">][(</span><span class="n">bb</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">]][</span><span class="n">Txor</span><span class="p">[(</span><span class="n">cc</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">][(</span><span class="n">dd</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">]])</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
                <span class="n">out</span><span class="p">[</span><span class="n">j</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Txor</span><span class="p">[</span><span class="n">Txor</span><span class="p">[(</span><span class="n">aa</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">][(</span><span class="n">bb</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">]][</span><span class="n">Txor</span><span class="p">[(</span><span class="n">cc</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">][(</span><span class="n">dd</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">]])</span> <span class="o">|</span> <span class="p">((</span><span class="n">Txor</span><span class="p">[</span><span class="n">Txor</span><span class="p">[(</span><span class="n">aa</span> <span class="o">&gt;&gt;</span> <span class="mi">28</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">][(</span><span class="n">bb</span> <span class="o">&gt;&gt;</span> <span class="mi">28</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">]][</span><span class="n">Txor</span><span class="p">[(</span><span class="n">cc</span> <span class="o">&gt;&gt;</span> <span class="mi">28</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">][(</span><span class="n">dd</span> <span class="o">&gt;&gt;</span> <span class="mi">28</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">]])</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="c1">/// Last round which is a bit different</span>
        <span class="n">ShiftRows</span><span class="p">(</span><span class="n">out</span><span class="p">);</span>

        <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">x</span> <span class="o">=</span> <span class="n">Tboxes_</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">out</span><span class="p">[</span><span class="n">j</span><span class="p">]];</span>
            <span class="n">out</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div>

<p>It's cute isn't it?</p>
<h1 id="attacking-the-white-box-extract-the-key">Attacking the white-box: extract the key</h1>
<p>As the title says, this white-box implementation is really insecure: which means that if you have access to an executable with that kind of white-box you just have to extract <code>Tyboxes[0]</code> &amp; do a little magic to extract the key.</p>
<p>If it's not already obvious to you, you just have to remember how we actually compute the values inside that big tables ; look carefully at those two lines:</p>
<div class="highlight"><pre><span></span><code>    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="n">S_box</span><span class="p">[</span><span class="n">x</span> <span class="o">^</span> <span class="n">round_keys</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">i</span><span class="p">]];</span>
    <span class="n">Tyboxes</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">Ty</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="mi">4</span><span class="p">][</span><span class="n">c</span><span class="p">];</span>
</code></pre></div>

<p>In our case, <code>r</code> is 0, <code>i</code> will be the byte index of the round key 0 (which is the AES key) &amp; we can also set <code>x</code> to a constant value: let's say 0 or 1 for instance. <code>S_box</code> is known, <code>Ty</code> too as this transformation is always the same (it doesn't depend on the key). Basically we just need to brute-force <code>round_keys[r][i]</code> with every values a byte can take. If the computed value is equal to the one in the dumped <code>Tyboxes</code>, then we have extracted one byte of the round key &amp; we can go find the next one.</p>
<p>Attentive readers noticed that we are not going to actually extract the encryption key per-se, but <code>ShiftRows(key)</code> instead (remember that we needed to apply this transformation to build our white-box). But again, <code>ShiftRows</code> being not key-dependent we can invert this operation easily to really have  the plain encryption key this time.</p>
<p>Here is the code that does what I just described:</p>
<div class="highlight"><pre><span></span><code>        <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">scrambled_key</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// unsigned char c = S_box[0 ^ X0];</span>
            <span class="c1">// Tyboxes[0][0][0] = Ty[0][c];</span>
            <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span> <span class="o">=</span> <span class="n">Tyboxes_round0_dumped</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">];</span>
            <span class="c1">// Now we generate the 0x100 possible values for the character 0 &amp; wait to find a match</span>
            <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mh">0x100</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="n">S_box</span><span class="p">[</span><span class="mi">1</span> <span class="o">^</span> <span class="n">j</span><span class="p">];</span>
                <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">computed_value</span> <span class="o">=</span> <span class="n">Ty</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="mi">4</span><span class="p">][</span><span class="n">c</span><span class="p">];</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">computed_value</span> <span class="o">==</span> <span class="n">value</span><span class="p">)</span>
                    <span class="n">scrambled_key</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="p">{</span>
            <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">tmp1</span><span class="p">,</span> <span class="n">tmp2</span><span class="p">;</span>
            <span class="c1">// 8-bits right rotation of the second line</span>
            <span class="n">tmp1</span> <span class="o">=</span> <span class="n">scrambled_key</span><span class="p">[</span><span class="mi">13</span><span class="p">];</span>
            <span class="n">scrambled_key</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="n">scrambled_key</span><span class="p">[</span><span class="mi">9</span><span class="p">];</span>
            <span class="n">scrambled_key</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">scrambled_key</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
            <span class="n">scrambled_key</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp1</span><span class="p">;</span>

            <span class="c1">// 16-bits right rotation of the third line</span>
            <span class="n">tmp1</span> <span class="o">=</span> <span class="n">scrambled_key</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
            <span class="n">tmp2</span> <span class="o">=</span> <span class="n">scrambled_key</span><span class="p">[</span><span class="mi">14</span><span class="p">];</span>
            <span class="n">scrambled_key</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="n">scrambled_key</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
            <span class="n">scrambled_key</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="n">scrambled_key</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
            <span class="n">scrambled_key</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp2</span><span class="p">;</span>
            <span class="n">scrambled_key</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp1</span><span class="p">;</span>

            <span class="c1">// 24-bits right rotation of the last line</span>
            <span class="n">tmp1</span> <span class="o">=</span> <span class="n">scrambled_key</span><span class="p">[</span><span class="mi">15</span><span class="p">];</span>
            <span class="n">scrambled_key</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="n">scrambled_key</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
            <span class="n">scrambled_key</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">scrambled_key</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
            <span class="n">scrambled_key</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">scrambled_key</span><span class="p">[</span><span class="mi">11</span><span class="p">];</span>
            <span class="n">scrambled_key</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp1</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Key successfully extracted &amp; UnShiftRow&#39;d:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\\</span><span class="s">x%.2x&quot;</span><span class="p">,</span> <span class="n">scrambled_key</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</code></pre></div>

<h1 id="obfuscating-it">Obfuscating it?</h1>
<p>This is basically the part where you have no limits, where you can exercise your creativity &amp; develop stuff. I'll just talk about ideas &amp; obvious things, a lot of them are directly taken from <a href="https://twitter.com/elvanderb">@elvanderb</a>'s challenge so I guess I owe him yet another beer.</p>
<p>The first things you can do for free are:</p>
<ul>
<li>Unrolling the implementation to make room for craziness</li>
<li>Use public LLVM passes on the unrolled implementation to make it even more crazy<ul>
<li><a href="https://github.com/0vercl0k/stuffz/blob/master/llvm-funz/kryptonite/llvm-functionpass-kryptonite-obfuscater.cpp">Kryptonite</a></li>
<li>Quarklab's <a href="https://github.com/quarkslab/llvm-passes">ones</a></li>
<li><a href="https://github.com/obfuscator-llvm/obfuscator">Ollvm</a></li>
<li>Build yours!</li>
</ul>
</li>
</ul>
<p>The other good idea is to try to make less obvious key elements in your implementation: basically the AES state, the tables &amp; their structures. Those three things give away quite some important information about how your implementation works, so making a bit harder to figure those points out is good for us. Instead of storing the AES state inside a contiguous memory area of 16 bytes, why not use 16 non-contiguous variables of 1 byte? You can go even further by using different variables for every round to make it even more confusing. </p>
<p>You can also apply that same idea to the different arrays our implementation uses: do not store them in a contiguous memory area, dispatch them all over the memory &amp; transform them in one dimension arrays instead.</p>
<p>We could also imagine a generic array "obfuscation" where you add several "layers" before reaching the value you are interested in:</p>
<ul>
<li>Imagine an array <code>[1,5,10,11]</code> ; we could shuffle this one into <code>[10, 5, 1, 11]</code> and build the associated index table which would be <code>[2, 1, 0, 3]</code></li>
<li>And now instead of accessing directly the first array, you retrieve the correct index first in the index table, <code>shuffled[index[0]]</code><ul>
<li>Obviously you could have as many indirections you want</li>
</ul>
</li>
</ul>
<p>To make everything always more confusing, we could build the primitives we need on top of crazy CPU extensions like SSE or MMX; or completely build a virtual software-processor..!</p>
<p>Do also try to shuffle everything that is "shufflable" ; here is simple graph that shows data-dependencies between the lines of our unrolled C implementation (an arrow from A to B means that A needs to be executed prior to B):</p>
<p><center><img alt="aes.svg" src="/images/spotlight_on_an_unprotected_aes128_white-box_implementation/aes.svg"></center>
From here, you have everything you need to move the lines around &amp; generate a "less normal" implementation (even that we can clearly see what I call synchronization points at the end of every round which is basically the calls to <code>ShiftRows(out)</code> ; but again we could get rid of those, and directly in-lining them etc):</p>
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">generate_shuffled_implementation_via_dependency_graph</span><span class="p">(</span><span class="n">dependency_graph</span><span class="p">,</span> <span class="n">out_filename</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;This function is basically leveraging the graph we produced in the previous function</span>
<span class="sd">        to generate an actual shuffled implementation of the AES white-box without breaking any</span>
<span class="sd">        constraints, keeping the result of this new shuffled function the same as the clean version.&#39;&#39;&#39;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;aes_unrolled_code.raw.clean.unique_aabbccdd&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="nb">print</span> <span class="s1">&#39; &gt; Finding the bottom of the graph..&#39;</span>
        <span class="n">last_nodes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)):</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">degree_o</span> <span class="o">=</span> <span class="n">dependency_graph</span><span class="o">.</span><span class="n">degree_iter</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">indeg</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">outdeg</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">degree_o</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">last_nodes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">dependency_graph</span><span class="o">.</span><span class="n">get_node</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

        <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">last_nodes</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="nb">print</span> <span class="s1">&#39; &gt; Good, check it out: </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">last_nodes</span>
        <span class="n">shuffled_lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">step_n</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="nb">print</span> <span class="s1">&#39; &gt; Lets go&#39;</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">last_nodes</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s1">&#39;  </span><span class="si">%.2d</span><span class="s1">&gt; Shuffle </span><span class="si">%d</span><span class="s1"> nodes / lines..&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">step_n</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">last_nodes</span><span class="p">))</span>
            <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">last_nodes</span><span class="p">),</span> <span class="n">random</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">)</span>
            <span class="n">shuffled_lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">get_name</span><span class="p">())]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">last_nodes</span><span class="p">)</span>
            <span class="n">step_n</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="nb">print</span> <span class="s1">&#39;  </span><span class="si">%.2d</span><span class="s1">&gt; Finding parents / stepping back ..&#39;</span> <span class="o">%</span> <span class="n">step_n</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">last_nodes</span><span class="p">:</span>
                <span class="n">tmp</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">dependency_graph</span><span class="o">.</span><span class="n">in_neighbors</span><span class="p">(</span><span class="n">node</span><span class="p">))</span>
            <span class="n">last_nodes</span> <span class="o">=</span> <span class="n">tmp</span>
            <span class="n">step_n</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">shuffled_lines</span> <span class="o">=</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">shuffled_lines</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">out_filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;void aes128_enc_wb_final_unrolled_shuffled_</span><span class="si">%d</span><span class="s1">(unsigned char in[16], unsigned char out[16])</span>
<span class="s1">    {</span>
<span class="s1">    memcpy(out, in, 16);</span>
<span class="s1">    &#39;&#39;&#39;</span> <span class="o">%</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">shuffled_lines</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;}&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">shuffled_lines</span>
</code></pre></div>

<p>Anyway, I wish I had time to implement what we just talked about but I unfortunately don't; if you do feel free to shoot me an email &amp; I'll update the post with links to your code :-).</p>
<h1 id="last-words">Last words</h1>
<p>I hope this little post gave you enough to understand how white-box cryptography kind of works, how important is the design of the implementation and what sort of problems you can encounter. If you enjoyed this subject, here is a list of cool articles you may want to check out:</p>
<ul>
<li><a href="http://www.whiteboxcrypto.com/files/2012_misc.pdf">White-box cryptography: hiding keys in software</a></li>
<li><a href="https://www.youtube.com/watch?v=om5AVTqB5bA">White-Box Cryptography - 30c3</a></li>
<li><a href="http://esec-lab.sogeti.com/dotclear/public/publications/10-hitbkl-drm.pdf">Digital content protection: How to crack DRM and make them more resistant</a></li>
<li><a href="https://github.com/mimoo/whiteboxDES">A white-box DES (Chow et al)</a></li>
</ul>
<p>Every source file produced for this post has been posted on my <a href="https://github.com/0vercl0k">github</a> account right here: <a href="https://github.com/0vercl0k/stuffz/blob/master/wbaes_attack/wbaes128">wbaes128</a>.</p>
<p>Special thanks to my mate <a href="https://twitter.com/__x86">@__x86</a> for proof-reading!</p>
                </div><!-- /.entry-content -->
        </article>
</section>
        </div><!--/span-->
      </div><!--/row-->
      <hr>

      <footer style='background-color:#00000000'>
        <center>
          <address id="about">
                  Proudly powered by <a href="http://pelican.notmyidea.org/">Pelican <i class="icon-external-link"></i></a>,
                                  which takes great advantage of <a href="http://python.org">Python <i class="icon-external-link"></i></a>.
          </address><!-- /#about -->

          <p>The theme is from <a href="http://twitter.github.com/bootstrap/">Bootstrap from Twitter <i class="icon-external-link"></i></a>,
                     and <a href="http://fortawesome.github.com/Font-Awesome/">Font-Awesome <i class="icon-external-link"></i></a>, thanks!</p>
        </center>
      </footer>

    </div><!--/.fluid-container-->


    <script src="../../../../../theme/js/jquery-1.7.2.min.js"></script>
    <script src="../../../../../theme/js/bootstrap.min.js"></script>
  </body>
</html>