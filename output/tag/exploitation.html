<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Diary of a reverse-engineer - exploitation</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="Axel '0vercl0k' Souchet">
    <link rel="stylesheet" href="/theme/css/bootstrap.min.css" type="text/css" />
    <style type="text/css">
      body {
        padding-top: 60px;
        padding-bottom: 40px;
      }
      .sidebar-nav {
        padding: 9px 0;
      }
      .tag-1 {
        font-size: 13pt;
      }
      .tag-2 {
        font-size: 10pt;
      }
      .tag-2 {
        font-size: 8pt;
      }
      .tag-4 {
        font-size: 6pt;
     }
    </style>
    <link href="/theme/css/bootstrap-responsive.min.css" rel="stylesheet" />
    <link href="/theme/css/font-awesome.css" rel="stylesheet" />
    <link href="/theme/css/pygments.css" rel="stylesheet" />

    <!--[if lt IE 9]>
      <script src="//html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <link href="/feeds/atom.xml" type="application/atom+xml" rel="alternate" title="Diary of a reverse-engineer ATOM Feed" />
    <link href="/feeds/rss.xml" type="application/atom+xml" rel="alternate" title="Diary of a reverse-engineer RSS Feed" />

  </head>

  <body>

    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container-fluid">
          <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
          <a class="brand" href="/index.html">Diary of a reverse-engineer </a>
          <div class="nav-collapse">
            <ul class="nav">
              <ul class="nav">
                    <li><a href="/archives.html"><i class="icon-th-list"></i>Archives</a></li>
              </ul>

                <li >
                    <a href="/category/debugging.html">
                      <i class="icon-folder-open icon-large"></i>debugging
                    </a>
                </li>
                <li >
                    <a href="/category/exploitation.html">
                      <i class="icon-folder-open icon-large"></i>exploitation
                    </a>
                </li>
                <li >
                    <a href="/category/misc.html">
                      <i class="icon-folder-open icon-large"></i>misc
                    </a>
                </li>
                <li >
                    <a href="/category/obfuscation.html">
                      <i class="icon-folder-open icon-large"></i>obfuscation
                    </a>
                </li>
                <li >
                    <a href="/category/reverse-engineering.html">
                      <i class="icon-folder-open icon-large"></i>reverse-engineering
                    </a>
                </li>

                <li><a href="/pages/about.html">About</a></li>
                <li><a href="/pages/presentations.html">Presentations</a></li>

            </ul>
          </div><!--/.nav-collapse -->
        </div>
      </div>
    </div>

    <div class="container-fluid">
      <div class="row">
        <div class="span9" id="content">
        <div class="article">
                <h1><a href="/blog/2018/11/19/introduction-to-spidermonkey-exploitation/">Introduction to SpiderMonkey exploitation.</a></h1>
                <div class="well small"><footer class="post-info">
<span class="label">Date</span>
<abbr class="published" title="2018-11-19T08:25:00-08:00">
        <i class="icon-calendar"></i>Mon 19 November 2018
</abbr>
<span class="label">By</span>
<a href="/author/axel-0vercl0k-souchet.html"><i class="icon-user"></i>Axel "0vercl0k" Souchet</a>
<span class="label">Category</span>
<a href="/category/exploitation.html"><i class="icon-folder-open"></i>exploitation</a>


<span class="label">Tags</span>
	<a href="/tag/spidermonkey.html"><i class="icon-tag"></i>spidermonkey</a>
	<a href="/tag/blazefox.html"><i class="icon-tag"></i>blazefox</a>
	<a href="/tag/exploitation.html"><i class="icon-tag"></i>exploitation</a>
	<a href="/tag/windows.html"><i class="icon-tag"></i>windows</a>
	<a href="/tag/ttd.html"><i class="icon-tag"></i>ttd</a>
</footer><!-- /.post-info --></div>
                <div class="summary"><h1 id="introduction">Introduction</h1>
<p>This blogpost covers the development of three exploits targeting SpiderMonkey JavaScript Shell interpreter and Mozilla Firefox on Windows 10 RS5 64-bit from the perspective of somebody that has never written a browser exploit nor looked closely at any JavaScript engine codebase.</p>
<p>As you have probably noticed, there has been a LOT of interest in exploiting browsers in the past year or two. Every major CTF competition has at least one browser challenge, every month there are at least a write-up or two touching on browser exploitation. It is just everywhere. That is kind of why I figured I should have a little look at what a JavaScript engine is like from inside the guts, and exploit one of them. I have picked Firefox's SpiderMonkey JavaScript engine and the challenge <a href="https://ctftime.org/task/6000">Blazefox</a> that has been written by <a href="https://twitter.com/itszn13">itszn13</a>.</p>
<p>In this blogpost, I present my findings and the <a href="https://github.com/0vercl0k/blazefox/blob/master/exploits">three exploits</a> I have written during this quest. Originally, the challenge was targeting a Linux x64 environment and so naturally I decided to exploit it on Windows x64 :). Now you may wonder why three different exploits? Three different exploits allowed me to take it step by step and not face all the complexity at once. That is usually how I work day to day, I make something small work and iterate to build it up.</p>
<p>Here is how I organized things:</p>
<ul>
<li>
<p>The first thing I wrote is a WinDbg JavaScript extension called <a href="https://github.com/0vercl0k/windbg-scripts/tree/master/sm">sm.js</a> that gives me visibility into a bunch of stuff in SpiderMonkey. It is also a good exercise to familiarize yourself with the various ways objects are organized in memory. It is not necessary, but it has been definitely useful when writing the exploits.</p>
</li>
<li>
<p>The first exploit, <code>basic.js</code>, targets a very specific build of the JavaScript interpreter, <code>js.exe</code>. It is full of hardcoded ugly offsets, and would have no chance to land elsewhere than on my system with this specific build of <code>js.exe</code>.</p>
</li>
<li>
<p>The second exploit, <code>kaizen.js</code>, is meant to be a net improvement of <code>basic.js</code>. It still targets the JavaScript interpreter itself, but this time, it resolves dynamically a bunch of things like a big boy. It also uses the baseline JIT to have it generate ROP gadgets.</p>
</li>
<li>
<p>The third exploit, <code>ifrit.js</code>, finally targets the Firefox browser with a little extra. Instead of just leveraging the baseline JIT to generate one or two ROP gadgets, we make it JIT a whole native code payload. No need to ROP, scan for finding Windows API addresses or to create a writable and executable memory region anymore. We just redirect the execution flow to our payload inside the JIT code. This might be the less dull / interesting part for people that knows SpiderMonkey and have been doing browser exploitation already :).</p>
</li>
</ul>
<p>Before starting, for those who do not feel like reading through the whole post: <strong>TL;DR</strong> I have created a <a href="https://github.com/0vercl0k/blazefox">blazefox</a> GitHub repository that you can clone with all the materials. In the repository you can find:</p>
<ul>
<li><a href="https://github.com/0vercl0k/blazefox/tree/master/sm">sm.js</a> which is the debugger extension mentioned above,</li>
<li>The source code of the three exploits in <a href="https://github.com/0vercl0k/blazefox/tree/master/exploits">exploits</a>,</li>
<li>A 64-bit debug build of the JavaScript shell along with private symbol information in <a href="https://github.com/0vercl0k/blazefox/tree/master/js-asserts">js-asserts</a>, and a release build in <a href="https://github.com/0vercl0k/blazefox/tree/master/js-release">js-release</a>,</li>
<li>The scripts I used to build the <strong>B</strong>ring <strong>Y</strong>our <strong>O</strong>wn <strong>P</strong>ayload technique in <a href="https://github.com/0vercl0k/blazefox/tree/master/scripts">scripts</a>,</li>
<li>The sources that have been used to build <code>js-release</code> so that you can do source-level debugging in WinDbg in <a href="https://github.com/0vercl0k/blazefox/tree/master/src/js">src/js</a>,</li>
<li>A 64-bit build of the Firefox binaries along with private symbol information for <code>xul.dll</code> in <a href="https://github.com/0vercl0k/blazefox/blob/master/ff-bin.7z.001">ff-bin.7z.001</a> and <a href="https://github.com/0vercl0k/blazefox/blob/master/ff-bin.7z.002">ff-bin.7z.002</a>.</li>
</ul>
<p>All right, let's buckle up and hit the road now!</p>

                        <a class="btn primary xsmall" href="/blog/2018/11/19/introduction-to-spidermonkey-exploitation/">more ...</a>
                </div>
        </div>
        <hr />
        <div class="article">
                <h1><a href="/blog/2018/07/14/cve-2017-2446-or-jscjsglobalobjectishavingabadtime/">CVE-2017-2446 or JSC::JSGlobalObject::isHavingABadTime.</a></h1>
                <div class="well small"><footer class="post-info">
<span class="label">Date</span>
<abbr class="published" title="2018-07-14T18:49:00-07:00">
        <i class="icon-calendar"></i>Sat 14 July 2018
</abbr>
<span class="label">By</span>
<a href="/author/yrp.html"><i class="icon-user"></i>yrp</a>
<span class="label">Category</span>
<a href="/category/exploitation.html"><i class="icon-folder-open"></i>exploitation</a>


<span class="label">Tags</span>
	<a href="/tag/javascriptcore.html"><i class="icon-tag"></i>JavascriptCore</a>
	<a href="/tag/jsc.html"><i class="icon-tag"></i>jsc</a>
	<a href="/tag/cve-2017-2446.html"><i class="icon-tag"></i>cve-2017-2446</a>
	<a href="/tag/exploitation.html"><i class="icon-tag"></i>exploitation</a>
</footer><!-- /.post-info --></div>
                <div class="summary"><h1 id="introduction">Introduction</h1>
<p>This post will cover the development of an exploit for JavaScriptCore (JSC) from the perspective of someone with no background in browser exploitation.</p>
<p>Around the start of the year, I was pretty burnt out on CTF problems and was interested in writing an exploit for something more complicated and practical. I settled on writing a WebKit exploit for a few reasons:</p>
<ul>
<li>It is code that is broadly used in the real world</li>
<li>Browsers seemed like a cool target in an area I had little familiarity (both C++ and interpreter exploitation.)</li>
<li>WebKit is (supposedly) the softest of the major browser targets.</li>
<li>There were good existing resources on WebKit exploitation, namely <a href="http://phrack.org/papers/attacking_javascript_engines.html">saelo’s Phrack article</a>, as well as a variety of public console exploits.</li>
</ul>
<p>With this in mind, I got a recommendation for an interesting looking bug that has not previously been publicly exploited: <a href="https://twitter.com/natashenka">@natashenka</a>’s CVE-2017-2446 from the <a href="https://bugs.chromium.org/p/project-zero/issues/detail?id=1032">project zero bugtracker</a>. The bug report had a PoC which crashed in <code>memcpy()</code> with some partially controlled registers, which is always a promising start.</p>
<p>This post assumes you’ve read saelo’s Phrack article linked above, particularly the portions on NaN boxing and butterflies -- I can’t do a better job of explaining these concepts than the article. Additionally, you should be able to run a browser/JavaScript engine in a debugger -- we will target Linux for this post, but the concepts should translate to your preferred platform/debugger.</p>
<p>Finally, the goal of doing this initially and now writing it up was and is to learn as much as possible. There is clearly a lot more for me to learn in this area, so if you read something that is incorrect, inefficient, unstable, a bad idea, or just have some thoughts to share, I’d love to hear from you.</p>

                        <a class="btn primary xsmall" href="/blog/2018/07/14/cve-2017-2446-or-jscjsglobalobjectishavingabadtime/">more ...</a>
                </div>
        </div>
        <hr />
        <div class="article">
                <h1><a href="/blog/2016/12/21/happy-unikernels/">happy unikernels</a></h1>
                <div class="well small"><footer class="post-info">
<span class="label">Date</span>
<abbr class="published" title="2016-12-21T18:59:00-08:00">
        <i class="icon-calendar"></i>Wed 21 December 2016
</abbr>
<span class="label">By</span>
<a href="/author/yrp.html"><i class="icon-user"></i>yrp</a>
<span class="label">Category</span>
<a href="/category/exploitation.html"><i class="icon-folder-open"></i>exploitation</a>


<span class="label">Tags</span>
	<a href="/tag/unikernel.html"><i class="icon-tag"></i>unikernel</a>
	<a href="/tag/rumpkernel.html"><i class="icon-tag"></i>rumpkernel</a>
	<a href="/tag/exploitation.html"><i class="icon-tag"></i>exploitation</a>
</footer><!-- /.post-info --></div>
                <div class="summary"><h1 id="intro">Intro</h1>
<p>Below is a collection of notes regarding unikernels. I had originally prepared this stuff to submit to EkoParty’s CFP, but ended up not wanting to devote time to stabilizing PHP7’s heap structures and I lost interest in the rest of the project before it was complete. However, there are still some cool takeaways I figured I could write down. Maybe they’ll come in handy? If so, please let let me know.</p>
<p>Unikernels are a continuation of turning everything into a container or VM. Basically, as many VMs currently just run one userland application, the idea is that we can simplify our entire software stack by removing the userland/kernelland barrier and essentially compiling our usermode process into the kernel. This is, in the implementation I looked at, done with a NetBSD kernel and a variety of either <a href="https://github.com/rumpkernel/rumprun-packages">native or lightly-patched POSIX applications</a>  (bonus: there is significant lag time between upstream fixes and rump package fixes, just like every other containerized solution).</p>
<p>While I don’t necessarily think that conceptually unikernels are a good idea (attack surface reduction vs mitigation removal), I do think people will start more widely deploying them shortly and I was curious what memory corruption exploitation would look like inside of them, and more generally what your payload options are like.</p>
<p>All of the following is based off of two unikernel programs, nginx and php5 and only makes use of public vulnerabilities. I am happy to provide all referenced code (in varying states of incompleteness), on request.</p>

                        <a class="btn primary xsmall" href="/blog/2016/12/21/happy-unikernels/">more ...</a>
                </div>
        </div>
        <hr />
        <div class="article">
                <h1><a href="/blog/2014/04/30/corrupting-arm-evt/">Corrupting the ARM Exception Vector Table</a></h1>
                <div class="well small"><footer class="post-info">
<span class="label">Date</span>
<abbr class="published" title="2014-04-30T21:01:00-07:00">
        <i class="icon-calendar"></i>Wed 30 April 2014
</abbr>
<span class="label">By</span>
<a href="/author/amat-acez-cama.html"><i class="icon-user"></i>Amat "acez" Cama</a>
<span class="label">Category</span>
<a href="/category/exploitation.html"><i class="icon-folder-open"></i>exploitation</a>


<span class="label">Tags</span>
	<a href="/tag/exploitation.html"><i class="icon-tag"></i>exploitation</a>
	<a href="/tag/kernel.html"><i class="icon-tag"></i>kernel</a>
</footer><!-- /.post-info --></div>
                <div class="summary"><h1 id="introduction">Introduction</h1>
<p>A few months ago, I was writing a Linux kernel exploitation challenge on ARM in an attempt to learn about kernel exploitation and I thought I'd explore things a little. I chose the ARM architecture mainly because I thought it would be fun to look at. This article is going to describe how the ARM Exception Vector Table (EVT) can aid in kernel exploitation in case an attacker has a write what-where primitive. It will be covering a local exploit scenario as well as a remote exploit scenario. Please note that corrupting the EVT has been mentioned in the paper "Vector Rewrite Attack"<a href="http://cansecwest.com/slides07/Vector-Rewrite-Attack.pdf">[1]</a>, which briefly talks about how it can be used in NULL pointer dereference vulnerabilities on an ARM RTOS.</p>
<p>The article is broken down into two main sections. First a brief description of the ARM EVT and its implications from an exploitation point of view (please note that a number of things about the EVT will be omitted to keep this article relatively short). We will go over two examples showing how we can abuse the EVT.</p>
<p>I am assuming the reader is familiar with Linux kernel exploitation and knows some ARM assembly (seriously).</p>

                        <a class="btn primary xsmall" href="/blog/2014/04/30/corrupting-arm-evt/">more ...</a>
                </div>
        </div>
        <hr />
        <div class="article">
                <h1><a href="/blog/2014/03/11/first-dip-into-the-kernel-pool-ms10-058/">First dip into the kernel pool : MS10-058</a></h1>
                <div class="well small"><footer class="post-info">
<span class="label">Date</span>
<abbr class="published" title="2014-03-11T10:52:37+01:00">
        <i class="icon-calendar"></i>Tue 11 March 2014
</abbr>
<span class="label">By</span>
<a href="/author/jeremy-__x86-fetiveau.html"><i class="icon-user"></i>Jeremy "__x86" Fetiveau</a>
<span class="label">Category</span>
<a href="/category/exploitation.html"><i class="icon-folder-open"></i>exploitation</a>


<span class="label">Tags</span>
	<a href="/tag/reverse-engineering.html"><i class="icon-tag"></i>reverse-engineering</a>
	<a href="/tag/exploitation.html"><i class="icon-tag"></i>exploitation</a>
	<a href="/tag/kernel-pool.html"><i class="icon-tag"></i>kernel pool</a>
	<a href="/tag/ms10-058.html"><i class="icon-tag"></i>ms10-058</a>
	<a href="/tag/tcpipsys.html"><i class="icon-tag"></i>tcpip.sys</a>
</footer><!-- /.post-info --></div>
                <div class="summary"><h1 id="introduction">Introduction</h1>
<p>I am currently playing with pool-based memory corruption vulnerabilities. That’s why I wanted to program a PoC exploit for the vulnerability presented by Tarjei Mandt during his first talk “Kernel Pool Exploitation on Windows 7” <a href="http://www.mista.nu/research/MANDT-kernelpool-PAPER.pdf">[3]</a>. I think it's a good exercise to start learning about pool overflows.</p>

                        <a class="btn primary xsmall" href="/blog/2014/03/11/first-dip-into-the-kernel-pool-ms10-058/">more ...</a>
                </div>
        </div>
        <hr />

                <section id="content" class="body">
                <h1>Pages</h1>
                        <li><a href="/pages/about.html">About</a></li>
                        <li><a href="/pages/presentations.html">Presentations</a></li>
                </section>
        </div><!--/span-->
      </div><!--/row-->
      <hr>

      <footer style='background-color:#00000000'>
        <center>
          <address id="about">
                  Proudly powered by <a href="http://pelican.notmyidea.org/">Pelican <i class="icon-external-link"></i></a>,
                                  which takes great advantage of <a href="http://python.org">Python <i class="icon-external-link"></i></a>.
          </address><!-- /#about -->

          <p>The theme is from <a href="http://twitter.github.com/bootstrap/">Bootstrap from Twitter <i class="icon-external-link"></i></a>,
                     and <a href="http://fortawesome.github.com/Font-Awesome/">Font-Awesome <i class="icon-external-link"></i></a>, thanks!</p>
        </center>
      </footer>

    </div><!--/.fluid-container-->


    <script src="/theme/js/jquery-1.7.2.min.js"></script>
    <script src="/theme/js/bootstrap.min.js"></script>
  </body>
</html>